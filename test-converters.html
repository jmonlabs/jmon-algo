<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Converter Download Functions Test</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    h1, h2 {
      color: #333;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    button {
      background-color: #4CAF50;
      border: none;
      color: white;
      padding: 15px 32px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
      margin: 4px 2px;
      cursor: pointer;
      border-radius: 4px;
    }
    button:hover {
      background-color: #45a049;
    }
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
    }
    .success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    pre {
      background-color: #f4f4f4;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <h1>Converter Download Functions Test</h1>

  <div class="test-section">
    <h2>Test 1: Basic Composition (Default PolySynth)</h2>
    <p>Click the buttons below to test each download function:</p>

    <button id="download-midi">Download MIDI (.mid)</button>
    <button id="download-wav">Download WAV (.wav)</button>
    <button id="download-abc">Download ABC (.abc)</button>
    <button id="show-abc">Show ABC Text</button>

    <div id="status"></div>
    <pre id="abc-output" style="display:none;"></pre>
  </div>

  <div class="test-section">
    <h2>Test 2: Composition with AudioGraph (Sawtooth + Filter + Reverb)</h2>
    <p>This should produce a WAV with distinctive sawtooth sound and reverb:</p>

    <button id="download-wav-audiograph">Download AudioGraph WAV (.wav)</button>

    <div id="status-audiograph"></div>
    <h3>AudioGraph Configuration:</h3>
    <pre id="audiograph-config"></pre>
  </div>

  <script type="module">
    import { jm } from './dist/jmon.esm.js';

    // Test composition
    const twinkleScore = {
      title: "Twinkle, twinkle little star",
      format: 'jmon',
      version: '1.0',
      tempo: 120,
      timeSignature: "4/4",
      keySignature: "C",
      tracks: [{
        label: 'Melody',
        timeSignature: "4/4",
        notes: [
          { pitch: 60, duration: 1, time: 0, velocity: 0.8 },   // C
          { pitch: 60, duration: 1, time: 1, velocity: 0.8 },   // C
          { pitch: 67, duration: 1, time: 2, velocity: 0.8 },   // G
          { pitch: 67, duration: 1, time: 3, velocity: 0.8 },   // G
          { pitch: 69, duration: 1, time: 4, velocity: 0.8 },   // A
          { pitch: 69, duration: 1, time: 5, velocity: 0.8 },   // A
          { pitch: 67, duration: 2, time: 6, velocity: 0.8 },   // G
          { pitch: 65, duration: 1, time: 8, velocity: 0.8 },   // F
          { pitch: 65, duration: 1, time: 9, velocity: 0.8 },   // F
          { pitch: 64, duration: 1, time: 10, velocity: 0.8 },  // E
          { pitch: 64, duration: 1, time: 11, velocity: 0.8 },  // E
          { pitch: 62, duration: 1, time: 12, velocity: 0.8 },  // D
          { pitch: 62, duration: 1, time: 13, velocity: 0.8 },  // D
          { pitch: 60, duration: 2, time: 14, velocity: 0.8 }   // C
        ]
      }]
    };

    const statusDiv = document.getElementById('status');

    // Test MIDI download
    document.getElementById('download-midi').addEventListener('click', async () => {
      try {
        statusDiv.innerHTML = '<div class="status">Loading @tonejs/midi library...</div>';

        const ToneMidi = await import("https://esm.sh/@tonejs/midi@2.0.28");

        statusDiv.innerHTML = '<div class="status">Generating MIDI file...</div>';
        await jm.converters.downloadMidi(twinkleScore, ToneMidi, "twinkle.mid");

        statusDiv.innerHTML = '<div class="status success">✓ MIDI file downloaded successfully!</div>';
      } catch (error) {
        statusDiv.innerHTML = `<div class="status error">✗ Error: ${error.message}</div>`;
        console.error('MIDI download error:', error);
      }
    });

    // Test WAV download (default)
    document.getElementById('download-wav').addEventListener('click', async () => {
      try {
        statusDiv.innerHTML = '<div class="status">Loading Tone.js library...</div>';

        const Tone = await import("https://esm.sh/tone@14.7.77");

        statusDiv.innerHTML = '<div class="status">Rendering WAV file (this may take a moment)...</div>';
        await jm.converters.downloadWav(twinkleScore, Tone, "twinkle.wav");

        statusDiv.innerHTML = '<div class="status success">✓ WAV file downloaded successfully!</div>';
      } catch (error) {
        statusDiv.innerHTML = `<div class="status error">✗ Error: ${error.message}</div>`;
        console.error('WAV download error:', error);
      }
    });

    // Test WAV download with audioGraph
    const audioGraphComposition = {
      title: "Twinkle with AudioGraph",
      tempo: 120,
      timeSignature: "4/4",
      tracks: [{
        label: 'Melody',
        notes: twinkleScore.tracks[0].notes,
        synthRef: "synth1"
      }],
      audioGraph: {
        nodes: [
          {
            id: "synth1",
            type: "synth",
            params: {
              oscillator: { type: "sawtooth" },
              envelope: {
                attack: 0.01,
                decay: 0.2,
                sustain: 0.5,
                release: 0.8
              }
            }
          },
          {
            id: "filter1",
            type: "filter",
            params: {
              frequency: 800,
              type: "lowpass"
            }
          },
          {
            id: "reverb1",
            type: "reverb",
            params: {
              roomSize: 0.7,
              dampening: 3000
            }
          }
        ],
        connections: [
          { from: "synth1", to: "filter1" },
          { from: "filter1", to: "reverb1" },
          { from: "reverb1", to: "destination" }
        ]
      }
    };

    document.getElementById('audiograph-config').textContent =
      JSON.stringify(audioGraphComposition.audioGraph, null, 2);

    document.getElementById('download-wav-audiograph').addEventListener('click', async () => {
      const statusAudioGraph = document.getElementById('status-audiograph');
      try {
        statusAudioGraph.innerHTML = '<div class="status">Loading Tone.js library...</div>';

        const Tone = await import("https://esm.sh/tone@14.7.77");

        statusAudioGraph.innerHTML = '<div class="status">Rendering AudioGraph WAV file (this may take a moment)...</div>';
        await jm.converters.downloadWav(audioGraphComposition, Tone, "twinkle-audiograph.wav");

        statusAudioGraph.innerHTML = '<div class="status success">✓ AudioGraph WAV file downloaded successfully! Listen and compare the sawtooth sound with reverb.</div>';
      } catch (error) {
        statusAudioGraph.innerHTML = `<div class="status error">✗ Error: ${error.message}</div>`;
        console.error('AudioGraph WAV download error:', error);
      }
    });

    // Test ABC download
    document.getElementById('download-abc').addEventListener('click', () => {
      try {
        statusDiv.innerHTML = '<div class="status">Generating ABC file...</div>';

        jm.converters.downloadABC(twinkleScore, "twinkle.abc");

        statusDiv.innerHTML = '<div class="status success">✓ ABC file downloaded successfully!</div>';
      } catch (error) {
        statusDiv.innerHTML = `<div class="status error">✗ Error: ${error.message}</div>`;
        console.error('ABC download error:', error);
      }
    });

    // Show ABC text
    document.getElementById('show-abc').addEventListener('click', () => {
      try {
        const abcText = jm.converters.abc(twinkleScore);
        const abcOutput = document.getElementById('abc-output');
        abcOutput.textContent = abcText;
        abcOutput.style.display = 'block';

        statusDiv.innerHTML = '<div class="status success">✓ ABC notation generated successfully!</div>';
      } catch (error) {
        statusDiv.innerHTML = `<div class="status error">✗ Error: ${error.message}</div>`;
        console.error('ABC generation error:', error);
      }
    });
  </script>
</body>
</html>
