<!DOCTYPE html>
<html>
<head>
  <title>Articulation Debug Test</title>
  <script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.js"></script>
</head>
<body>
  <h1>Articulation Debug Test</h1>
  <button id="test1">Test 1: Normal Note (PolySynth)</button><br><br>
  <button id="test2">Test 2: Vibrato with PolySynth (BROKEN)</button><br><br>
  <button id="test3">Test 3: Vibrato with MonoSynth (CORRECT)</button><br><br>
  <button id="stop">STOP ALL</button>

  <script type="module">
    let synth = null;

    document.getElementById('test1').addEventListener('click', async () => {
      await Tone.start();
      console.log('Test 1: Normal note');
      const s = new Tone.PolySynth().toDestination();
      s.triggerAttackRelease('C4', 2);
    });

    document.getElementById('test2').addEventListener('click', async () => {
      await Tone.start();
      console.log('Test 2: Vibrato with PolySynth - checking if frequency exists');
      const s = new Tone.PolySynth().toDestination();

      console.log('PolySynth.frequency:', s.frequency);
      console.log('PolySynth.volume:', s.volume);

      const now = Tone.now();
      s.triggerAttack('C4', now);

      // This won't work - PolySynth doesn't have frequency parameter
      if (s.frequency) {
        console.log('Applying vibrato to frequency');
        const values = [261.63, 270, 261.63, 253, 261.63];
        s.frequency.setValueCurveAtTime(values, now, 2);
      } else {
        console.error('PolySynth has no frequency parameter!');
      }

      s.triggerRelease(now + 2);
    });

    document.getElementById('test3').addEventListener('click', async () => {
      await Tone.start();
      console.log('Test 3: Vibrato with MonoSynth');
      const s = new Tone.MonoSynth().toDestination();

      console.log('MonoSynth.frequency:', s.frequency);
      console.log('MonoSynth.volume:', s.volume);

      const now = Tone.now();
      s.triggerAttack('C4', now);

      // Create vibrato effect using frequency modulation
      const baseFreq = Tone.Frequency('C4').toFrequency();
      const rate = 5; // 5 Hz vibrato
      const depth = 50; // 50 cents
      const duration = 2;
      const depthRatio = Math.pow(2, depth / 1200);

      const numSteps = Math.ceil(duration * rate * 10);
      const values = [];
      for (let i = 0; i < numSteps; i++) {
        const phase = (i / numSteps) * duration * rate * Math.PI * 2;
        const offset = Math.sin(phase) * (depthRatio - 1);
        values.push(baseFreq * (1 + offset));
      }

      console.log('Applying vibrato curve with', numSteps, 'steps');
      s.frequency.setValueCurveAtTime(values, now, duration);

      s.triggerRelease(now + duration);

      // Clean up
      setTimeout(() => {
        s.dispose();
      }, duration * 1000 + 500);
    });

    document.getElementById('stop').addEventListener('click', () => {
      console.log('Stopping transport and disposing all');
      Tone.Transport.stop();
      Tone.Transport.cancel(0);
      // Note: This won't clean up synths created outside transport
    });
  </script>
</body>
</html>
