<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>API Harmonization Test</title>
  <script src="https://cdn.jsdelivr.net/npm/vexflow@4.2.2/build/vexflow.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.js"></script>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      max-width: 1600px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    h1, h2 {
      color: #333;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
    }
    .success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .info {
      background-color: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    #score-container {
      margin-top: 20px;
      overflow-x: auto;
    }
    #player-container {
      margin-top: 20px;
    }
    pre {
      background-color: #f4f4f4;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <h1>jmon/algo API Harmonization Test</h1>

  <div class="test-section">
    <h2>Test Composition: Twinkle Twinkle Little Star</h2>
    <pre id="composition-data"></pre>
  </div>

  <div class="test-section">
    <h2>Test 1: score() with new API - { VexFlow, width: 1500, height: 300 }</h2>
    <div id="test1-status"></div>
    <div id="score-container"></div>
  </div>

  <div class="test-section">
    <h2>Test 2: play() with new API - { Tone, autoplay: false }</h2>
    <div id="test2-status"></div>
    <div id="player-container"></div>
  </div>

  <div class="test-section">
    <h2>Test 3: Backward Compatibility - score() with old API</h2>
    <div id="test3-status"></div>
    <div id="score-container-old"></div>
  </div>

  <script type="module">
    import { jm } from './dist/jmon.esm.js';

    // Twinkle Twinkle Little Star - 14 notes (tests width requirement)
    const twinkleTwinkle = {
      metadata: { title: "Twinkle Twinkle Little Star" },
      tempo: 120,
      timeSignature: "4/4",
      tracks: [{
        label: "Melody",
        notes: [
          { pitch: 60, duration: 1, time: 0 },  // C
          { pitch: 60, duration: 1, time: 1 },  // C
          { pitch: 67, duration: 1, time: 2 },  // G
          { pitch: 67, duration: 1, time: 3 },  // G
          { pitch: 69, duration: 1, time: 4 },  // A
          { pitch: 69, duration: 1, time: 5 },  // A
          { pitch: 67, duration: 2, time: 6 },  // G
          { pitch: 65, duration: 1, time: 8 },  // F
          { pitch: 65, duration: 1, time: 9 },  // F
          { pitch: 64, duration: 1, time: 10 }, // E
          { pitch: 64, duration: 1, time: 11 }, // E
          { pitch: 62, duration: 1, time: 12 }, // D
          { pitch: 62, duration: 1, time: 13 }, // D
          { pitch: 60, duration: 2, time: 14 }  // C
        ]
      }]
    };

    // Display composition
    document.getElementById('composition-data').textContent =
      JSON.stringify(twinkleTwinkle, null, 2);

    // Test 1: New score() API
    async function test1() {
      const status = document.getElementById('test1-status');
      try {
        status.innerHTML = '<div class="info">Testing new score() API...</div>';

        const VexFlow = window.Vex?.Flow || window.VF;
        if (!VexFlow) {
          throw new Error('VexFlow not loaded');
        }

        // New API: { VexFlow, width, height }
        const scoreElement = jm.score(twinkleTwinkle, {
          VexFlow,
          width: 1500,
          height: 300
        });

        if (scoreElement && scoreElement.querySelector) {
          const svg = scoreElement.querySelector('svg');
          if (svg) {
            const svgWidth = svg.getAttribute('width') || svg.style.width;
            const svgHeight = svg.getAttribute('height') || svg.style.height;

            document.getElementById('score-container').appendChild(scoreElement);

            status.innerHTML = `
              <div class="success">
                ✓ Test 1 PASSED<br>
                - New API works correctly<br>
                - SVG rendered with width: ${svgWidth}, height: ${svgHeight}<br>
                - All 14 notes should be visible without truncation
              </div>
            `;
          } else {
            throw new Error('SVG not found in rendered element');
          }
        } else {
          throw new Error('Invalid score element returned');
        }
      } catch (error) {
        status.innerHTML = `
          <div class="error">
            ✗ Test 1 FAILED<br>
            Error: ${error.message}
          </div>
        `;
        console.error('Test 1 error:', error);
      }
    }

    // Test 2: New play() API
    async function test2() {
      const status = document.getElementById('test2-status');
      try {
        status.innerHTML = '<div class="info">Testing new play() API...</div>';

        const Tone = window.Tone;
        if (!Tone) {
          throw new Error('Tone.js not loaded');
        }

        const startTime = performance.now();

        // New API: { Tone, autoplay: false }
        const playerResult = jm.play(twinkleTwinkle, {
          Tone,
          autoplay: false
        });

        // Check if it's a Promise or direct return
        const isPromise = playerResult && typeof playerResult.then === 'function';
        const playerElement = isPromise ? await playerResult : playerResult;

        const endTime = performance.now();
        const executionTime = (endTime - startTime).toFixed(2);

        if (playerElement && playerElement.appendChild) {
          document.getElementById('player-container').appendChild(playerElement);

          status.innerHTML = `
            <div class="success">
              ✓ Test 2 PASSED<br>
              - New API works correctly<br>
              - Returned: ${isPromise ? 'Promise' : 'Direct element'}<br>
              - Execution time: ${executionTime}ms<br>
              - Player rendered successfully<br>
              - AudioContext state: ${Tone.context ? Tone.context.state : 'unknown'}
            </div>
          `;
        } else {
          throw new Error('Invalid player element returned');
        }
      } catch (error) {
        status.innerHTML = `
          <div class="error">
            ✗ Test 2 FAILED<br>
            Error: ${error.message}
          </div>
        `;
        console.error('Test 2 error:', error);
      }
    }

    // Test 3: Backward compatibility
    async function test3() {
      const status = document.getElementById('test3-status');
      try {
        status.innerHTML = '<div class="info">Testing backward compatibility...</div>';

        const VF = window.Vex?.Flow || window.VF;
        if (!VF) {
          throw new Error('VexFlow not loaded');
        }

        // Old API: direct VexFlow parameter (should still work)
        const scoreElement = jm.score(twinkleTwinkle, VF);

        if (scoreElement && scoreElement.querySelector) {
          const svg = scoreElement.querySelector('svg');
          if (svg) {
            document.getElementById('score-container-old').appendChild(scoreElement);

            status.innerHTML = `
              <div class="success">
                ✓ Test 3 PASSED<br>
                - Backward compatibility maintained<br>
                - Old API (direct VexFlow param) still works<br>
                - Note: Uses default dimensions (1500x300)
              </div>
            `;
          } else {
            throw new Error('SVG not found in rendered element');
          }
        } else {
          throw new Error('Invalid score element returned');
        }
      } catch (error) {
        status.innerHTML = `
          <div class="error">
            ✗ Test 3 FAILED<br>
            Error: ${error.message}
          </div>
        `;
        console.error('Test 3 error:', error);
      }
    }

    // Run tests sequentially
    window.addEventListener('load', async () => {
      console.log('Starting API harmonization tests...');
      await test1();
      await test2();
      await test3();
      console.log('All tests completed');
    });
  </script>
</body>
</html>
