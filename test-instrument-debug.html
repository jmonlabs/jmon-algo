<!DOCTYPE html>
<html>
<head>
  <title>Instrument Creation Debug Test</title>
  <style>
    body {
      font-family: 'Courier New', monospace;
      padding: 20px;
      background: #1a1a1a;
      color: #0f0;
    }
    .log {
      background: #000;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
      white-space: pre-wrap;
      font-size: 12px;
    }
    .error { color: #f00; }
    .success { color: #0f0; }
    .info { color: #0ff; }
  </style>
</head>
<body>
  <h1>Instrument Creation Debug</h1>
  <div id="log" class="log">Initializing...\n</div>
  <div id="player-container"></div>

  <script type="module">
    import { createPlayer } from './src/browser/music-player.js';

    const logEl = document.getElementById('log');

    function log(msg, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      logEl.textContent += `[${timestamp}] <span class="${type}">${msg}</span>\n`;
    }

    // Override console.log to capture player logs
    const originalLog = console.log;
    console.log = function(...args) {
      originalLog.apply(console, args);
      log(args.join(' '), 'info');
    };

    console.warn = function(...args) {
      log('⚠️ ' + args.join(' '), 'error');
    };

    console.error = function(...args) {
      log('❌ ' + args.join(' '), 'error');
    };

    // Test composition with violin + vibrato
    const composition = {
      metadata: { title: "Violin Debug Test" },
      tempo: 120,
      tracks: [
        {
          instrument: 40, // Violin - should create Tone.Sampler
          events: [
            {
              time: 0,
              duration: 2,
              pitch: 64,
              velocity: 0.8,
              articulations: [
                {
                  type: "vibrato",
                  rate: 5,
                  depth: 50
                }
              ]
            }
          ]
        }
      ]
    };

    log('Creating player with composition:', 'info');
    log(JSON.stringify(composition, null, 2), 'info');
    log('---', 'info');

    try {
      const player = createPlayer(composition, { autoplay: false });
      document.getElementById('player-container').appendChild(player);
      log('✓ Player created successfully', 'success');
      log('---', 'info');
      log('Expected logs above:', 'info');
      log('1. "Creating Sampler for GM instrument 40" (Violin)', 'info');
      log('2. Effect chain creation logs if vibrato detected', 'info');
      log('3. "Waiting for samples to load..." when you press Play', 'info');
      log('4. "Samples loaded, starting playback"', 'info');
      log('---', 'info');
      log('Click Play button above to start. Watch for Sampler creation logs.', 'success');
    } catch (err) {
      log('❌ Failed to create player: ' + err.message, 'error');
      log(err.stack, 'error');
    }
  </script>
</body>
</html>
