<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AudioGraph Test - JMON/Algo</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    h1, h2 {
      color: #333;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .player-container {
      margin: 20px 0;
    }
    pre {
      background-color: #f4f4f4;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
    }
    .comparison {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 20px 0;
    }
    .comparison > div {
      background: #fafafa;
      padding: 15px;
      border-radius: 4px;
      border: 2px solid #ddd;
    }
    .comparison h3 {
      margin-top: 0;
      color: #555;
    }
  </style>
</head>
<body>
  <h1>AudioGraph Test - JMON/Algo</h1>

  <div class="test-section">
    <h2>Comparison: Default PolySynth vs Custom AudioGraph</h2>
    <p>The audioGraph below creates a sawtooth synth with a lowpass filter and reverb.</p>
    <p>Listen to both players and compare the sound:</p>

    <div class="comparison">
      <div>
        <h3>üéπ Default PolySynth</h3>
        <div id="default-player"></div>
      </div>
      <div>
        <h3>üéõÔ∏è Custom AudioGraph (Sawtooth + Filter + Reverb)</h3>
        <div id="audiograph-player"></div>
      </div>
    </div>

    <h3>AudioGraph Configuration:</h3>
    <pre id="audiograph-config"></pre>
  </div>

  <script type="module">
    import { jm } from './dist/jmon.esm.js';

    // Simple melody
    const melody = [
      { pitch: 60, duration: 1, time: 0, velocity: 0.8 },   // C
      { pitch: 60, duration: 1, time: 1, velocity: 0.8 },   // C
      { pitch: 67, duration: 1, time: 2, velocity: 0.8 },   // G
      { pitch: 67, duration: 1, time: 3, velocity: 0.8 },   // G
      { pitch: 69, duration: 1, time: 4, velocity: 0.8 },   // A
      { pitch: 69, duration: 1, time: 5, velocity: 0.8 },   // A
      { pitch: 67, duration: 2, time: 6, velocity: 0.8 }    // G
    ];

    // Default composition (no audioGraph)
    const defaultComposition = {
      title: "Default PolySynth",
      tempo: 120,
      timeSignature: "4/4",
      tracks: [{
        label: 'Melody',
        notes: melody
      }]
    };

    // Composition with custom audioGraph
    const audioGraphComposition = {
      title: "Custom AudioGraph",
      tempo: 120,
      timeSignature: "4/4",
      tracks: [{
        label: 'Melody',
        notes: melody,
        synthRef: "synth1"  // Reference to audioGraph node
      }],
      audioGraph: {
        nodes: [
          {
            id: "synth1",
            type: "synth",
            params: {
              oscillator: { type: "sawtooth" },
              envelope: {
                attack: 0.01,
                decay: 0.2,
                sustain: 0.5,
                release: 0.8
              }
            }
          },
          {
            id: "filter1",
            type: "filter",
            params: {
              frequency: 800,
              type: "lowpass"
            }
          },
          {
            id: "reverb1",
            type: "reverb",
            params: {
              roomSize: 0.7,
              dampening: 3000
            }
          }
        ],
        connections: [
          { from: "synth1", to: "filter1" },
          { from: "filter1", to: "reverb1" },
          { from: "reverb1", to: "destination" }
        ]
      }
    };

    // Display the audioGraph configuration
    document.getElementById('audiograph-config').textContent =
      JSON.stringify(audioGraphComposition.audioGraph, null, 2);

    // Load Tone.js and create players
    async function init() {
      const Tone = await import("https://esm.sh/tone@14.7.77");

      // Create default player
      const defaultPlayer = await jm.play(defaultComposition, {
        Tone,
        autoplay: false
      });
      document.getElementById('default-player').appendChild(defaultPlayer);

      // Create audioGraph player
      const audioGraphPlayer = await jm.play(audioGraphComposition, {
        Tone,
        autoplay: false
      });
      document.getElementById('audiograph-player').appendChild(audioGraphPlayer);

      console.log('‚úÖ Both players loaded successfully');
      console.log('Default composition:', defaultComposition);
      console.log('AudioGraph composition:', audioGraphComposition);
    }

    init().catch(error => {
      console.error('Error initializing players:', error);
      document.body.innerHTML += `
        <div style="background: #f8d7da; color: #721c24; padding: 20px; margin: 20px; border-radius: 4px;">
          <strong>Error:</strong> ${error.message}
          <pre>${error.stack}</pre>
        </div>
      `;
    });
  </script>
</body>
</html>
