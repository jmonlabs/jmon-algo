<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Simple JMON VexFlow Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #score {
            border: 2px dashed #ddd;
            padding: 20px;
            margin: 20px 0;
            border-radius: 4px;
            min-height: 200px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>JMON Studio Basic API Test</h1>
        <p>Testing fundamental jm.score() API functionality and error handling.</p>

        <div>
            <button onclick="testWithoutVexFlow()">Test Without VexFlow</button>
            <button onclick="testWithVexFlow()">Test with VexFlow</button>
            <button onclick="clearResults()">Clear</button>
        </div>

        <div id="status"></div>
        <div id="score"></div>
        <div id="debug"></div>
    </div>

    <!-- Load JMON Studio -->
    <script src="../dist/jmon.umd.js"></script>

    <!-- Load VexFlow from a working CDN -->
    <script src="https://unpkg.com/vexflow@4.2.2/build/umd/vexflow.min.js"></script>

    <script>
        const statusDiv = document.getElementById('status');
        const scoreDiv = document.getElementById('score');
        const debugDiv = document.getElementById('debug');

        // Test data using proper JMON schema
        const testPiece = {
            format: "jmon",
            version: "1.0.0",
            tempo: 120,
            keySignature: 'C',
            timeSignature: '4/4',
            metadata: { title: 'Simple Test Melody' },
            tracks: [{
                label: "melody",
                notes: [
                    { pitch: 60, duration: "4n", time: 0 }, // C
                    { pitch: 62, duration: "4n", time: 1 }, // D
                    { pitch: 64, duration: "4n", time: 2 }, // E
                    { pitch: 65, duration: "4n", time: 3 }  // F
                ]
            }]
        };

        function showStatus(message, type = 'success') {
            statusDiv.innerHTML = `<div class="${type}">${message}</div>`;
        }

        function showDebug(obj) {
            debugDiv.innerHTML = `<pre>${JSON.stringify(obj, null, 2)}</pre>`;
        }

        function clearResults() {
            statusDiv.innerHTML = '';
            scoreDiv.innerHTML = '';
            debugDiv.innerHTML = '';
        }

        function testWithoutVexFlow() {
            try {
                const jm = window.JmonStudio;
                if (!jm) {
                    showStatus('JMON Studio not loaded', 'error');
                    return;
                }

                showStatus('Testing without VexFlow (should fail)...', 'warning');
                const result = jm.score(testPiece); // No VexFlow - should throw error

                showStatus('⚠️ Unexpected: jm.score worked without VexFlow', 'warning');
                showDebug(result);
            } catch (error) {
                showStatus(`✅ Expected error: ${error.message}`, 'success');
                console.log('Expected error (VexFlow required):', error);
            }
        }

        function testWithVexFlow() {
            try {
                const jm = window.JmonStudio;
                if (!jm) {
                    showStatus('JMON Studio not loaded', 'error');
                    return;
                }

                if (!window.VF && !window.VexFlow && !window.Vex) {
                    showStatus('VexFlow not detected - testing without it', 'warning');
                    testWithoutVexFlow();
                    return;
                }

                showStatus('Testing with VexFlow...', 'warning');
                const VF = window.VF || window.VexFlow || window.Vex;
                const result = jm.score(testPiece, VF, { width: 800, height: 200 });

                if (result && typeof result === 'object') {
                    if (result.nodeType === 1) {
                        // DOM element with SVG
                        scoreDiv.innerHTML = '';
                        scoreDiv.appendChild(result);

                        const hasSvg = result.querySelector('svg');
                        if (hasSvg) {
                            showStatus('✅ VexFlow rendered SVG successfully!', 'success');
                        } else {
                            showStatus('⚠️ DOM element returned but no SVG found', 'warning');
                        }
                    } else if (result.type === 'vexflow') {
                        showStatus('✅ VexFlow data structure returned (non-DOM)', 'success');
                        showDebug({ type: result.type, dataKeys: Object.keys(result.data || {}) });
                    } else {
                        showStatus('⚠️ Unexpected result format', 'warning');
                        showDebug({ type: typeof result, data: result });
                    }
                } else {
                    showStatus('❌ No result returned', 'error');
                }
            } catch (error) {
                showStatus(`❌ Error: ${error.message}`, 'error');
                console.error(error);
            }
        }

        // Auto-test when page loads
        window.addEventListener('load', () => {
            setTimeout(() => {
                showStatus('Page loaded. Click buttons to test score generation.', 'success');
            }, 500);
        });
    </script>
</body>
</html>