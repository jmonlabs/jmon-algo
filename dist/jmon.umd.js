(function(St,Nt){typeof exports=="object"&&typeof module<"u"?Nt(exports):typeof define=="function"&&define.amd?define(["exports"],Nt):(St=typeof globalThis<"u"?globalThis:St||self,Nt(St.JmonStudio={}))})(this,(function(St){"use strict";class Nt{constructor(){console.warn("[JMON] Using simplified browser validator. For full validation, use Node.js environment.")}validateAndNormalize(t){const e=[];let n={...t};try{return!t||typeof t!="object"?(e.push("Object must be a valid object"),{valid:!1,errors:e,normalized:null}):(!n.tracks&&!n.notes&&(Array.isArray(t)?n={tracks:[{notes:t}]}:n.tracks=n.tracks||[]),n.notes&&!n.tracks&&(n.tracks=[{notes:n.notes}],delete n.notes),Array.isArray(n.tracks)||(n.tracks=[n.tracks]),n.tracks.forEach((o,r)=>{if(!o.notes){e.push(`Track ${r} missing notes array`);return}if(!Array.isArray(o.notes)){e.push(`Track ${r} notes must be an array`);return}o.notes.forEach((i,s)=>{if(typeof i!="object"){e.push(`Track ${r}, note ${s}: must be an object`);return}i.pitch===void 0&&(i.pitch=null),i.duration===void 0&&(i.duration=1),i.time===void 0&&(i.time=0)})}),n.format=n.format||"jmon",n.version=n.version||"1.0",n.timeSignature=n.timeSignature||"4/4",n.keySignature=n.keySignature||"C",{valid:e.length===0,errors:e,normalized:n})}catch(o){return e.push(`Validation error: ${o.message}`),{valid:!1,errors:e,normalized:null}}}isValid(t){return this.validateAndNormalize(t).valid}}class et{static chromatic_scale=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];static flat_to_sharp={Bb:"A#",Db:"C#",Eb:"D#",Gb:"F#",Ab:"G#","B♭":"A#","D♭":"C#","E♭":"D#","G♭":"F#","A♭":"G#","B-":"A#","D-":"C#","E-":"D#","G-":"F#","A-":"G#"};static scale_intervals={major:[0,2,4,5,7,9,11],minor:[0,2,3,5,7,8,10],diminished:[0,2,3,5,6,8,9,11],"major pentatonic":[0,2,4,7,9],"minor pentatonic":[0,3,5,7,10],chromatic:[0,1,2,3,4,5,6,7,8,9,10,11],lydian:[0,2,4,6,7,9,11],mixolydian:[0,2,4,5,7,9,10],dorian:[0,2,3,5,7,9,10],phrygian:[0,1,3,5,7,8,10],locrian:[0,1,3,5,6,8,10],"harmonic minor":[0,2,3,5,7,8,11],"melodic minor ascending":[0,2,3,5,7,9,11],"melodic minor descending":[0,2,3,5,7,8,10]};static intervals={P1:0,m2:1,M2:2,m3:3,M3:4,P4:5,P5:7,m6:8,M6:9,m7:10,M7:11,P8:12};static convertFlatToSharp(t){return this.flat_to_sharp[t]||t}static noteNameToMidi(t){const e=t.match(/^([A-G][#b♭-]?)(-?\d+)$/);if(!e)throw new Error(`Invalid note name format: ${t}`);const[,n,o]=e,r=this.convertFlatToSharp(n),i=this.chromatic_scale.indexOf(r);if(i===-1)throw new Error(`Invalid note name: ${n}`);return i+(parseInt(o)+1)*12}static midiToNoteName(t,e=!1){const n=Math.floor(t/12)-1,o=t%12;return`${this.chromatic_scale[o]}${n}`}static scaleToTriad(t){return[t[0],t[2],t[4]]}}class we{constructor(t,e="major"){const n=et.convertFlatToSharp(t);if(!et.chromatic_scale.includes(n))throw new Error(`'${t}' is not a valid tonic note. Select one among '${et.chromatic_scale.join(", ")}'.`);if(this.tonic=n,!Object.keys(et.scale_intervals).includes(e))throw new Error(`'${e}' is not a valid scale. Select one among '${Object.keys(et.scale_intervals).join(", ")}'.`);this.mode=e}generate(t={}){const e=et.scale_intervals[this.mode];if(!e)return console.warn(`Unknown scale mode: ${this.mode}`),[];typeof t.start=="string"&&(t.start=et.noteNameToMidi(t.start)),typeof t.end=="string"&&(t.end=et.noteNameToMidi(t.end));const n=t.start??60;if(et.chromatic_scale.indexOf(this.tonic)===-1)return console.warn(`Unknown tonic: ${this.tonic}`),[];const r=(s,c)=>{const a=c%e.length,h=Math.floor(c/e.length)*12,u=e[a];return s+u+h},i=[];if(t.end!==void 0)for(let s=0;;s++){const c=r(n,s);if(c>t.end)break;i.push(c)}else if(t.length)for(let s=0;s<t.length;s++)i.push(r(n,s));else return e.map(s=>n+s);return i}getNoteNames(){const t=et.scale_intervals[this.mode];if(!t)return[];const e=et.chromatic_scale.indexOf(this.tonic);return e===-1?[]:t.map(n=>{const o=(e+n)%12;return et.chromatic_scale[o]})}isInScale(t){const e=t%12;return this.generate().map(o=>o%12).includes(e)}}function Je(l){if(typeof l=="object"&&!Array.isArray(l))return l;if(Array.isArray(l)){if(l.length===0)return{};if(l.every(e=>Array.isArray(e)&&e.length===3))return{"track 1":l};const t={};return l.forEach((e,n)=>{t[`track ${n+1}`]=e}),t}throw new Error("Input must be a list or dict of tracks.")}function be(l,t){return t.reduce((e,n)=>Math.abs(n-l)<Math.abs(e-l)?n:e)}function xe(l){return Math.floor(l/12)-1}function Xe(l){return{"D-":"C#","E-":"D#","G-":"F#","A-":"G#","B-":"A#",Db:"C#",Eb:"D#",Gb:"F#",Ab:"G#",Bb:"A#"}[l]||l}function Zt(l,t,e){typeof l=="string"&&(l=Ot(l)),typeof e=="string"&&(e=Ot(e));const n=t.indexOf(e);if(t.includes(l))return t.indexOf(l)-n;{const o=be(l,t),r=t.indexOf(o),i=r>0?r-1:r,s=t[i],c=o-l,a=l-s,h=c+a;if(h===0)return r-n;const u=1-c/h,m=1-a/h,p=r-n,v=i-n;return p*u+v*m}}function Qe(l,t,e){const n=t.indexOf(e),o=Math.round(n+l);if(o>=0&&o<t.length)return t[o];{const r=Math.max(0,Math.min(o,t.length-1)),i=Math.min(t.length-1,Math.max(o,0)),s=t[r],c=t[i],a=i-o,h=o-r,u=a+h;if(u===0)return(c+s)/2;const m=1-a/u,p=1-h/u;return c*m+s*p}}function ve(l){l.length>0&&l[0].length===2&&(l=l.map(n=>[n[0],n[1],0]));const t=[];let e=0;for(const[n,o,r]of l)t.push([n,o,e]),e+=o;return t}function Te(l,t=0){const e=[...l].sort((r,i)=>r[2]-i[2]);let n=0;const o=[];for(const r of e){const[i,s,c]=r,a=t+c;if(a>n){const u=[null,a-n,n-t];o.push(u)}o.push(r),n=Math.max(n,a+s)}return o}function Me(l){l.sort((t,e)=>t[2]-e[2]);for(let t=0;t<l.length-1;t++){const e=l[t],n=l[t+1];if(e[2]+e[1]>n[2]){const r=n[2]-e[2];l[t]=[e[0],r,e[2]]}}return l}function Ze(l){return Me(Te(l))}function Ot(l){const t=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],e={Db:"C#",Eb:"D#",Gb:"F#",Ab:"G#",Bb:"A#",Cb:"B"};let n=4,o=l;if(l.includes("b")){const s=l.slice(0,-1);e[s]&&(o=e[s]+l.slice(-1))}let r;return o.length>2||o.length===2&&!isNaN(o[1])?(r=o.slice(0,-1),n=parseInt(o.slice(-1))):r=o[0],12*(n+1)+t.indexOf(r)}function tn(l){const t=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],e=Math.floor(l/12)-1,n=l%12;return t[n]+e.toString()}function en(l,t="offsets"){const e=[];let n=0;for(const[o,r,i]of l)e.push([o,r,n]),n+=r;return e}function nn(l){return l.every(t=>Array.isArray(t))?"list of tuples":l.every(t=>!Array.isArray(t))?"list":"unknown"}function on(l,t,e,n=null,o=null){const r=n!==null?n:Math.min(...l),i=o!==null?o:Math.max(...l);return r===i?new Array(l.length).fill((t+e)/2):l.map(s=>(s-r)*(e-t)/(i-r)+t)}function ke(l,t){return l.map(([e,n,o])=>[e,n,o+t])}function rn(l,t,e){const n=[];for(const[o,r,i]of l){const s=Math.round(i/e)*e,c=(Math.floor(s/t)+1)*t;let a=Math.round(r/e)*e;a=Math.min(a,c-s),a>0&&n.push([o,a,s])}return n}function sn(l,t){const n=l.filter(([s,,c])=>s!==null&&c!==null).sort((s,c)=>s[2]-c[2]),o=Math.max(...n.map(([,,s])=>s)),r=Math.floor(o/t)+1,i=[];for(let s=0;s<r;s++){const c=s*t;let a=null,h=1/0;for(const[u,,m]of n){const p=c-m;if(p>=0&&p<h&&(h=p,a=u),m>c)break}a!==null&&i.push(a)}return i}function an(l,t){return t.reduce((e,n)=>Math.abs(n-l)<Math.abs(e-l)?n:e)}function cn(l,t){return 60/t*l}function*ln(l=0,t=1,e=0,n=1){for(;;)yield e+n*l,[l,t]=[t,l+t]}function un(l,t,e){const n={};for(const[o,r]of Object.entries(l)){const i=[];for(let s=0;s<t;s++){const c=s*e,a=ke(r,c);i.push(...a)}n[o]=i}return n}const hn=Object.freeze(Object.defineProperty({__proto__:null,adjustNoteDurationsToPreventOverlaps:Me,cdeToMidi:Ot,checkInput:nn,fibonacci:ln,fillGapsWithRests:Te,findClosestPitchAtMeasureStart:sn,getDegreeFromPitch:Zt,getOctave:xe,getPitchFromDegree:Qe,getSharp:Xe,instrumentMapping:{"Acoustic Grand Piano":0,"Bright Acoustic Piano":1,"Electric Grand Piano":2,"Honky-tonk Piano":3,"Electric Piano 1":4,"Electric Piano 2":5,Harpsichord:6,Clavinet:7,Gunshot:127},midiToCde:tn,noOverlap:en,offsetTrack:ke,qlToSeconds:cn,quantizeNotes:rn,repairNotes:Ze,repeatPolyloops:un,roundToList:be,scaleList:on,setOffsetsAccordingToDurations:ve,tracksToDict:Je,tune:an},Symbol.toStringTag,{value:"Module"}));class dn extends et{constructor(t="C4",e="P5",n="chords",o=[3,3,1],r=null){if(super(),this.tonicMidi=Ot(t),this.circleOf=e,this.type=n,this.radius=o,this.weights=r||o,!Object.keys(this.intervals).includes(this.circleOf))throw new Error(`Select a circleOf among ${Object.keys(this.intervals).join(", ")}.`);if(!["chords","pitches"].includes(this.type))throw new Error("Type must either be 'pitches' or 'chords'.")}computeCircle(){const t=this.intervals[this.circleOf],e=[this.tonicMidi];for(let n=0;n<Math.max(...this.radius);n++){const o=(e[e.length-1]+t)%12+Math.floor(e[e.length-1]/12)*12;e.push(o)}return{major:e.slice(0,this.radius[0]),minor:e.slice(0,this.radius[1]),diminished:e.slice(0,this.radius[2])}}generateChord(t,e){return({major:[0,4,7],minor:[0,3,7],diminished:[0,3,6]}[e]||[0,4,7]).map(i=>t+i).map(i=>i>127?i-12:i)}generate(t=4,e=null){e!==null&&(Math.seedrandom=e);const{major:n,minor:o,diminished:r}=this.computeCircle(),i=[n,o,r],s=["major","minor","diminished"],c=[];for(let a=0;a<t;a++){const h=this.weightedRandomChoice(this.weights);if(i[h].length>0){const u=i[h][Math.floor(Math.random()*i[h].length)],m=s[h],p=Array.isArray(u)?u[0]:u,v=this.generateChord(p,m);c.push(v)}}return c}weightedRandomChoice(t){const e=t.reduce((o,r)=>o+r,0);let n=Math.random()*e;for(let o=0;o<t.length;o++)if(n-=t[o],n<=0)return o;return t.length-1}}class mn extends et{constructor(t="major",e="C",n=[0,2,4]){super(),this.tonic=e,this.scale=new we(e,t).generate(),this.degrees=n}pitchToChord(t){const e=xe(t),n=this.tonic+e.toString(),o=Ot(n),r=this.scale.map(c=>Zt(c,this.scale,o)),i=Math.round(Zt(t,this.scale,o)),s=[];for(const c of this.degrees){const a=i+c,h=r.indexOf(a);h!==-1&&s.push(this.scale[h])}return s}generate(t,e=null,n=!1){if(!Array.isArray(t)||t.length===0)return[];let o=t;if(typeof t[0]=="number"){e===null&&(e=[1]);let i=0,s=0;o=t.map(c=>{const a=e[i%e.length],h=[c,a,s];return s+=a,i++,h})}const r=o.map(([i,s,c])=>[this.pitchToChord(i),s,c]);if(n){const i=[];for(const[s,c,a]of r){const h=c/s.length;s.forEach((u,m)=>{i.push([u,h,a+m*h])})}return i}else return r}}const Se={grace_note:{requiredParams:["graceNoteType"],optionalParams:["gracePitches"],conflicts:[],description:"Single note before the main note",defaultParams:{graceNoteType:"acciaccatura"},validate:(l,t)=>["acciaccatura","appoggiatura"].includes(t.graceNoteType)?t.gracePitches&&!Array.isArray(t.gracePitches)?{valid:!1,error:"gracePitches must be an array of pitches"}:{valid:!0}:{valid:!1,error:"graceNoteType must be either acciaccatura or appoggiatura"}},trill:{requiredParams:[],optionalParams:["by","trillRate"],conflicts:["mordent"],minDuration:"8n",description:"Rapid alternation between main note and auxiliary note",defaultParams:{by:1,trillRate:.125},validate:(l,t)=>t.by&&typeof t.by!="number"?{valid:!1,error:"trill step (by) must be a number"}:t.trillRate&&typeof t.trillRate!="number"?{valid:!1,error:"trillRate must be a number"}:{valid:!0}},mordent:{requiredParams:[],optionalParams:["by"],conflicts:["trill"],description:"Quick alternation with note above or below",defaultParams:{by:1},validate:(l,t)=>t.by&&typeof t.by!="number"?{valid:!1,error:"mordent step (by) must be a number"}:{valid:!0}},turn:{requiredParams:[],optionalParams:["scale"],conflicts:[],description:"Melodic turn around the main note",validate:(l,t)=>t.scale&&typeof t.scale!="string"?{valid:!1,error:"scale must be a string"}:{valid:!0}},arpeggio:{requiredParams:["arpeggioDegrees"],optionalParams:["direction"],conflicts:[],description:"Notes played in sequence",defaultParams:{direction:"up"},validate:(l,t)=>Array.isArray(t.arpeggioDegrees)?t.direction&&!["up","down","both"].includes(t.direction)?{valid:!1,error:"direction must be up, down, or both"}:{valid:!0}:{valid:!1,error:"arpeggioDegrees must be an array"}}};class te{static validateOrnament(t,e,n={}){const o={valid:!1,warnings:[],errors:[]},r=Se[e];if(!r)return o.errors.push(`Unknown ornament type: ${e}`),o;if(r.requiredParams){for(const i of r.requiredParams)if(!(i in n))return o.errors.push(`Missing required parameter '${i}' for ${e}`),o}if(r.minDuration&&o.warnings.push(`Duration check not implemented for ${e}`),t.ornaments&&r.conflicts){const i=t.ornaments.filter(s=>r.conflicts.includes(s.type)).map(s=>s.type);if(i.length>0)return o.errors.push(`${e} conflicts with existing ornaments: ${i.join(", ")}`),o}if(r.validate){const i=r.validate(t,n);if(!i.valid)return o.errors.push(i.error),o}return o.valid=!0,o}constructor(t){const e=Se[t.type];if(!e)throw new Error(`Unknown ornament type: ${t.type}`);this.type=t.type,this.params={...e.defaultParams,...t.parameters},t.tonic&&t.mode?(this.tonicIndex=et.chromatic_scale.indexOf(t.tonic),this.scale=this.generateScale(t.tonic,t.mode)):this.scale=null}generateScale(t,e){const n=et.scale_intervals[e],o=et.chromatic_scale.indexOf(t),r=n.map(s=>(o+s)%12),i=[];for(let s=-1;s<10;s++)for(const c of r){const a=12*s+c;a>=0&&a<=127&&i.push(a)}return i}apply(t,e=null){if(!Array.isArray(t)||t.length===0||(e===null&&(e=Math.floor(Math.random()*t.length)),e<0||e>=t.length))return t;const n=t[e],o=te.validateOrnament(n,this.type,this.params);if(!o.valid)return console.warn(`Ornament validation failed: ${o.errors.join(", ")}`),t;switch(this.type){case"grace_note":return this.addGraceNote(t,e);case"trill":return this.addTrill(t,e);case"mordent":return this.addMordent(t,e);case"turn":return this.addTurn(t,e);case"arpeggio":return this.addArpeggio(t,e);default:return t}}addGraceNote(t,e){const n=t[e],o=n.pitch,r=n.duration,i=n.time,s=this.params.gracePitches?this.params.gracePitches[Math.floor(Math.random()*this.params.gracePitches.length)]:o+1;if(this.params.graceNoteType==="acciaccatura"){const c=r*.125,a={pitch:o,duration:r,time:i+c};return[...t.slice(0,e),{pitch:s,duration:c,time:i},a,...t.slice(e+1)]}else{const c=r/2,a={pitch:o,duration:c,time:i+c};return[...t.slice(0,e),{pitch:s,duration:c,time:i},a,...t.slice(e+1)]}}addTrill(t,e){const n=t[e],o=n.pitch,r=n.duration,i=n.time,s=[];let c=i;const a=this.params.by||1,h=this.params.trillRate||.125;let u;if(this.scale&&this.scale.includes(o)){const p=(this.scale.indexOf(o)+Math.round(a))%this.scale.length;u=this.scale[p]}else u=o+a;for(;c<i+r;){const m=i+r-c,p=Math.min(h,m/2);if(m>=p*2)s.push({pitch:o,duration:p,time:c}),s.push({pitch:u,duration:p,time:c+p}),c+=2*p;else break}return[...t.slice(0,e),...s,...t.slice(e+1)]}addMordent(t,e){const n=t[e],o=n.pitch,r=n.duration,i=n.time,s=this.params.by||1;let c;if(this.scale&&this.scale.includes(o)){const m=this.scale.indexOf(o)+Math.round(s);c=this.scale[m]||o+s}else c=o+s;const a=r/3,h=[{pitch:o,duration:a,time:i},{pitch:c,duration:a,time:i+a},{pitch:o,duration:a,time:i+2*a}];return[...t.slice(0,e),...h,...t.slice(e+1)]}addTurn(t,e){const n=t[e],o=n.pitch,r=n.duration,i=n.time,s=r/4;let c,a;if(this.scale&&this.scale.includes(o)){const u=this.scale.indexOf(o);c=this.scale[u+1]||o+2,a=this.scale[u-1]||o-2}else c=o+2,a=o-2;const h=[{pitch:o,duration:s,time:i},{pitch:c,duration:s,time:i+s},{pitch:o,duration:s,time:i+2*s},{pitch:a,duration:s,time:i+3*s}];return[...t.slice(0,e),...h,...t.slice(e+1)]}addArpeggio(t,e){const n=t[e],o=n.pitch,r=n.duration,i=n.time,{arpeggioDegrees:s,direction:c="up"}=this.params;if(!s||!Array.isArray(s))return t;const a=[];if(this.scale&&this.scale.includes(o)){const m=this.scale.indexOf(o);a.push(...s.map(p=>this.scale[m+p]||o+p))}else a.push(...s.map(m=>o+m));c==="down"&&a.reverse(),c==="both"&&a.push(...a.slice(0,-1).reverse());const h=r/a.length,u=a.map((m,p)=>({pitch:m,duration:h,time:i+p*h}));return[...t.slice(0,e),...u,...t.slice(e+1)]}}const ee={staccato:{complex:!1,description:"Shortens note duration to ~50%"},accent:{complex:!1,description:"Increases note velocity/emphasis"},tenuto:{complex:!1,description:"Holds note for full duration with emphasis"},legato:{complex:!1,description:"Smooth connection between notes"},marcato:{complex:!1,description:"Strong accent with slight separation"},glissando:{complex:!0,requiredParams:["target"],description:"Smooth slide from note to target pitch"},portamento:{complex:!0,requiredParams:["target"],optionalParams:["curve","speed"],description:"Expressive slide between pitches"},bend:{complex:!0,requiredParams:["amount"],optionalParams:["curve","returnToOriginal"],description:"Pitch bend up or down in cents"},vibrato:{complex:!0,optionalParams:["rate","depth","delay"],description:"Periodic pitch variation"},tremolo:{complex:!0,optionalParams:["rate","depth"],description:"Rapid volume variation"},crescendo:{complex:!0,requiredParams:["endVelocity"],optionalParams:["curve"],description:"Gradual volume increase"},diminuendo:{complex:!0,requiredParams:["endVelocity"],optionalParams:["curve"],description:"Gradual volume decrease"}};class Ae{static addArticulation(t,e,n,o={}){const r={success:!1,warnings:[],errors:[]};if(!Array.isArray(t))return r.errors.push("Sequence must be an array"),r;if(n<0||n>=t.length)return r.errors.push(`Note index ${n} out of bounds (sequence length: ${t.length})`),r;const i=ee[e];if(!i)return r.errors.push(`Unknown articulation type: ${e}`),r;const s=t[n];if(!s||typeof s!="object")return r.errors.push(`Invalid note at index ${n}`),r;if(!i.complex){const c=Array.isArray(s.articulations)?s.articulations:[];return s.articulations=[...c,e],r.success=!0,r}return this._addComplexArticulation(s,e,i,o,r)}static _addComplexArticulation(t,e,n,o,r){if(n.requiredParams){for(const i of n.requiredParams)if(!(i in o))return r.errors.push(`Missing required parameter '${i}' for ${e}`),r}switch(e){case"glissando":case"portamento":return this._applyGlissando(t,e,o,r);case"bend":return this._applyBend(t,o,r);case"vibrato":return this._applyVibrato(t,o,r);case"tremolo":return this._applyTremolo(t,o,r);case"crescendo":case"diminuendo":return this._applyDynamicChange(t,e,o,r);default:return r.errors.push(`Complex articulation ${e} not implemented`),r}}static _applyGlissando(t,e,n,o){const r=Array.isArray(t.articulations)?t.articulations:[];return t.articulations=[...r,{type:e,...n}],o.success=!0,o}static _applyBend(t,e,n){const o=Array.isArray(t.articulations)?t.articulations:[];return t.articulations=[...o,{type:"bend",...e}],n.success=!0,n}static _applyVibrato(t,e,n){const o=Array.isArray(t.articulations)?t.articulations:[];return t.articulations=[...o,{type:"vibrato",...e}],n.success=!0,n}static _applyTremolo(t,e,n){const o=Array.isArray(t.articulations)?t.articulations:[];return t.articulations=[...o,{type:"tremolo",...e}],n.success=!0,n}static _applyDynamicChange(t,e,n,o){const r=Array.isArray(t.articulations)?t.articulations:[];return t.articulations=[...r,{type:e,...n}],o.success=!0,o}static removeArticulation(t,e){if(!Array.isArray(t)||e<0||e>=t.length)return{success:!1,error:"Invalid sequence or note index"};const n=t[e];if(!n||typeof n!="object")return{success:!1,error:"Invalid note"};const o=Array.isArray(n.articulations)?n.articulations.slice():[];return n.articulations=[],{success:!0,removed:o,message:"Removed articulations from note"}}static validateSequence(t){const e=[];return t.forEach((n,o)=>{const r=Array.isArray(n.articulations)?n.articulations:[];for(const i of r){const s=typeof i=="string"?i:i?.type,c=ee[s];if(!s||!c){e.push({type:"unknown_articulation",noteIndex:o,articulation:s,message:`Unknown articulation type: ${s}`});continue}if(Array.isArray(c.requiredParams))for(const a of c.requiredParams)(typeof i!="object"||!(a in i))&&e.push({type:"missing_parameter",noteIndex:o,articulation:s,message:`Missing required parameter '${a}' for ${s}`})}}),{valid:e.length===0,issues:e}}static getAvailableTypes(){return Object.entries(ee).map(([t,e])=>({type:t,complex:e.complex,description:e.description,requiredParams:e.requiredParams||[],optionalParams:e.optionalParams||[]}))}}function fn(l){return Ae.validateSequence(l)}function Pe(l,t,e,n={}){if(!Array.isArray(l))return l;const o=l.slice(),r=l[t];if(!r||typeof r!="object")return o;const i=a=>a==="staccato"||a==="accent"||a==="tenuto"||a==="marcato",s=Array.isArray(r.articulations)?r.articulations.slice():[];i(e)?s.push(e):s.push({type:e,...n});const c={...r,articulations:s};return o[t]=c,o}function Ee(l,t,e){if(!Array.isArray(l))return l;const n=l.slice(),o=l[t];if(!o||typeof o!="object")return n;const r=c=>typeof e=="function"?e(c):!0,i=Array.isArray(o.articulations)?o.articulations.filter(c=>{const a=typeof c=="string"?c:c.type;return!r(a)}):[],s={...o,articulations:i};return n[t]=s,n}const pn={Scale:we,Progression:dn,Voice:mn,Ornament:te,Articulation:Ae,addArticulation:Pe,addOrnament:Pe,removeArticulation:Ee,removeOrnament:Ee,validateArticulations:fn};class gn{constructor(t,e){this.measureLength=t,this.durations=e}random(t=null,e=0,n=100){t!==null&&(Math.seedrandom=t);const o=[];let r=0,i=0;for(;r<this.measureLength&&i<n;){const s=this.durations[Math.floor(Math.random()*this.durations.length)];if(r+s>this.measureLength){i++;continue}if(Math.random()<e){i++;continue}o.push([s,r]),r+=s,i++}return i>=n&&console.warn("Max iterations reached. The sum of the durations may not equal the measure length."),o}darwin(t=null,e=10,n=50,o=.1){return new yn(t,e,this.measureLength,n,o,this.durations).generate()}}class yn{constructor(t,e,n,o,r,i){t!==null&&(Math.seedrandom=t),this.populationSize=e,this.measureLength=n,this.maxGenerations=o,this.mutationRate=r,this.durations=i,this.population=this.initializePopulation()}initializePopulation(){const t=[];for(let e=0;e<this.populationSize;e++)t.push(this.createRandomRhythm());return t}createRandomRhythm(){const t=[];let e=0;for(;e<this.measureLength;){const n=this.measureLength-e,o=this.durations[Math.floor(Math.random()*this.durations.length)];if(o<=n)t.push([o,e]),e+=o;else break}return t}evaluateFitness(t){const e=t.reduce((n,o)=>n+o[0],0);return Math.abs(this.measureLength-e)}selectParent(){const t=this.population[Math.floor(Math.random()*this.population.length)],e=this.population[Math.floor(Math.random()*this.population.length)];return this.evaluateFitness(t)<this.evaluateFitness(e)?t:e}crossover(t,e){if(t.length===0||e.length===0)return t.length>0?[...t]:[...e];const n=Math.floor(Math.random()*(t.length-1))+1,o=[...t.slice(0,n),...e.slice(n)];return this.ensureMeasureLength(o)}ensureMeasureLength(t){return t.reduce((n,o)=>n+o[0],0)>this.measureLength&&t.length>0&&t.pop(),t}mutate(t){if(Math.random()<this.mutationRate&&t.length>1){const e=Math.floor(Math.random()*(t.length-1)),[n,o]=t[e],i=(e===t.length-1?this.measureLength:t[e+1][1])-o,s=this.durations.filter(c=>c<=i);if(s.length>0){const c=s[Math.floor(Math.random()*s.length)];t[e]=[c,o]}}return t}generate(){for(let e=0;e<this.maxGenerations;e++){const n=[];for(let o=0;o<this.populationSize;o++){const r=this.selectParent(),i=this.selectParent();let s=this.crossover(r,i);s=this.mutate(s),s.sort((c,a)=>c[1]-a[1]),n.push(s)}this.population=n}return this.population.reduce((e,n)=>this.evaluateFitness(n)<this.evaluateFitness(e)?n:e).sort((e,n)=>e[1]-n[1])}}function gt(l,t=4,e=480){const n=Math.floor(l/t),o=l-n*t,r=Math.floor(o),i=o-r,s=Math.round(i*e);return`${n}:${r}:${s}`}function jt(l,t=4,e=480){if(typeof l=="number")return l;if(typeof l!="string")return 0;const n=l.split(":").map(s=>parseFloat(s||"0")),[o=0,r=0,i=0]=n;return o*t+r+i/e}function Ne(l,t="Untitled Part",e={}){const n=ne(l);return{name:t,notes:n,...e}}function wn(l,t={}){const e=l.map((o,r)=>Array.isArray(o)?Ne(o,`Track ${r+1}`):o.name&&o.notes?{...o,notes:ne(o.notes)}:o),n={format:"jmon",version:"1.0",bpm:t.bpm||120,keySignature:t.keySignature||"C",timeSignature:t.timeSignature||"4/4",tracks:e,...t};return delete n.metadata?.bpm,delete n.metadata?.keySignature,delete n.metadata?.timeSignature,n}function ne(l){return Array.isArray(l)?l.map((t,e)=>{if(Array.isArray(t)){const[n,o,r=0]=t;return{pitch:n,duration:o,time:gt(r)}}if(typeof t=="object"&&t!==null){const{pitch:n,duration:o}=t;let r="0:0:0";return typeof t.time=="string"?r=t.time:typeof t.time=="number"?r=gt(t.time):typeof t.offset=="number"&&(r=gt(t.offset)),{pitch:n,duration:o,time:r,...Object.fromEntries(Object.entries(t).filter(([i])=>!["time","offset"].includes(i)))}}return console.warn(`Unexpected note format at index ${e}:`,t),{pitch:60,duration:1,time:"0:0:0"}}):[]}function bn(l){return l.map(([t,e,n=0])=>({pitch:t,duration:e,time:gt(n)}))}function xn(l){return l.map(t=>[t.pitch,t.duration,jt(t.time)])}function vn(l,t=1,e=0){let n=e;return l.map(o=>{const r={pitch:o,duration:t,time:gt(n)};return n+=t,r})}function Ce(l,t){return l.map(e=>({...e,time:gt(jt(e.time)+t)}))}function Tn(l){if(l.length===0)return[];const t=[];let e=0;for(const n of l){const o=Ce(n,e);t.push(...o);const r=o.map(i=>jt(i.time)+i.duration);e=Math.max(...r,e)}return t}function Mn(l){return l.flat()}function kn(l){if(l.length===0)return{start:0,end:0,duration:0};const t=l.map(r=>jt(r.time)),e=l.map(r=>jt(r.time)+r.duration),n=Math.min(...t),o=Math.max(...e);return{start:n,end:o,duration:o-n,startTime:gt(n),endTime:gt(o)}}const Sn=Object.freeze(Object.defineProperty({__proto__:null,beatsToTime:gt,combineSequences:Mn,concatenateSequences:Tn,createComposition:wn,createPart:Ne,createScale:vn,getTimingInfo:kn,jmonToTuples:xn,normalizeNotes:ne,offsetNotes:Ce,timeToBeats:jt,tuplesToJmon:bn},Symbol.toStringTag,{value:"Module"}));function An(l,t,e={}){const n=l.map(a=>Array.isArray(a)||typeof a=="object"&&a.length?a[0]:a),o=Pn(n.length,t.length),r=[],i=[];for(let a=0;a<o;a++)r.push(n[a%n.length]),i.push(t[a%t.length]);const s=r.map((a,h)=>[a,i[h],1]),c=ve(s);return e.legacy?c:c.map(([a,h,u])=>({pitch:a,duration:h,time:e.useStringTime?gt(u):u}))}function Pn(l,t){const e=(n,o)=>o===0?n:e(o,n%o);return Math.abs(l*t)/e(l,t)}function En(l,t){const e=[];let n=0,o=0;for(const r of l){const i=t[o%t.length];e.push([r,i,n]),n+=i,o++}return e}const Nn={Rhythm:gn,isorhythm:An,beatcycle:En};class Cn{constructor(){}}class yt{data;constructor(t,e){if(typeof t=="number"){if(e===void 0)throw new Error("Columns parameter required when creating matrix from dimensions");this.rows=t,this.columns=e,this.data=Array(this.rows).fill(0).map(()=>Array(this.columns).fill(0))}else this.data=t.map(n=>[...n]),this.rows=this.data.length,this.columns=this.data[0]?.length||0}static zeros(t,e){return new yt(t,e)}static from2DArray(t){return new yt(t)}get(t,e){if(t<0||t>=this.rows||e<0||e>=this.columns)throw new Error(`Index out of bounds: (${t}, ${e})`);return this.data[t][e]}set(t,e,n){if(t<0||t>=this.rows||e<0||e>=this.columns)throw new Error(`Index out of bounds: (${t}, ${e})`);this.data[t][e]=n}getRow(t){if(t<0||t>=this.rows)throw new Error(`Row index out of bounds: ${t}`);return[...this.data[t]]}getColumn(t){if(t<0||t>=this.columns)throw new Error(`Column index out of bounds: ${t}`);return this.data.map(e=>e[t])}transpose(){const t=Array(this.columns).fill(0).map(()=>Array(this.rows).fill(0));for(let e=0;e<this.rows;e++)for(let n=0;n<this.columns;n++)t[n][e]=this.data[e][n];return new yt(t)}clone(){return new yt(this.data)}toArray(){return this.data.map(t=>[...t])}}function oe(l){return Array.isArray(l[0])?yt.from2DArray(l):yt.from2DArray([l])}function Re(l){if(l.rows!==l.columns)throw new Error("Matrix must be square for Cholesky decomposition");const t=l.rows,e=yt.zeros(t,t);for(let n=0;n<t;n++)for(let o=0;o<=n;o++)if(n===o){let r=0;for(let s=0;s<o;s++)r+=e.get(o,s)*e.get(o,s);const i=l.get(o,o)-r;if(i<=0)throw new Error(`Matrix is not positive definite at position (${o}, ${o})`);e.set(o,o,Math.sqrt(i))}else{let r=0;for(let i=0;i<o;i++)r+=e.get(n,i)*e.get(o,i);e.set(n,o,(l.get(n,o)-r)/e.get(o,o))}return e}class Rn{constructor(t={}){this.params={...t}}call(t,e){const n=e||t,o=yt.zeros(t.rows,n.rows);for(let r=0;r<t.rows;r++)for(let i=0;i<n.rows;i++)o.set(r,i,this.compute(t.getRow(r),n.getRow(i)));return o}getParams(){return{...this.params}}setParams(t){Object.assign(this.params,t)}euclideanDistance(t,e){let n=0;for(let o=0;o<t.length;o++)n+=Math.pow(t[o]-e[o],2);return Math.sqrt(n)}squaredEuclideanDistance(t,e){let n=0;for(let o=0;o<t.length;o++)n+=Math.pow(t[o]-e[o],2);return n}}class Ie{kernel;alpha;XTrain;yTrain;L;alphaVector;constructor(t,e={}){this.kernel=t,this.alpha=e.alpha||1e-10}fit(t,e){this.XTrain=oe(t),this.yTrain=[...e];const n=this.kernel.call(this.XTrain);for(let o=0;o<n.rows;o++)n.set(o,o,n.get(o,o)+this.alpha);try{this.L=Re(n)}catch(o){throw new Error(`Failed to compute Cholesky decomposition: ${o instanceof Error?o.message:"Unknown error"}`)}this.alphaVector=this.solveCholesky(this.L,this.yTrain)}predict(t,e=!1){if(!this.XTrain||!this.yTrain||!this.L||!this.alphaVector)throw new Error("Model must be fitted before prediction");const n=oe(t),o=this.kernel.call(this.XTrain,n),r=new Array(n.rows);for(let s=0;s<n.rows;s++){r[s]=0;for(let c=0;c<this.XTrain.rows;c++)r[s]+=o.get(c,s)*this.alphaVector[c]}const i={mean:r};if(e){const s=this.computeStd(n,o);i.std=s}return i}sampleY(t,e=1){if(!this.XTrain||!this.yTrain||!this.L||!this.alphaVector)throw new Error("Model must be fitted before sampling");const n=oe(t),o=this.predict(t,!0);if(!o.std)throw new Error("Standard deviation computation failed");const r=[];for(let i=0;i<e;i++){const s=new Array(n.rows);for(let c=0;c<n.rows;c++){const a=o.mean[c],h=o.std[c];s[c]=a+h*this.sampleStandardNormal()}r.push(s)}return r}logMarginalLikelihood(){if(!this.XTrain||!this.yTrain||!this.L||!this.alphaVector)throw new Error("Model must be fitted before computing log marginal likelihood");let t=0;for(let e=0;e<this.yTrain.length;e++)t-=.5*this.yTrain[e]*this.alphaVector[e];for(let e=0;e<this.L.rows;e++)t-=Math.log(this.L.get(e,e));return t-=.5*this.yTrain.length*Math.log(2*Math.PI),t}computeStd(t,e){if(!this.L)throw new Error("Cholesky decomposition not available");const n=new Array(t.rows);for(let o=0;o<t.rows;o++){const r=this.kernel.compute(t.getRow(o),t.getRow(o)),i=e.getColumn(o),s=this.forwardSubstitution(this.L,i);let c=0;for(let h=0;h<s.length;h++)c+=s[h]*s[h];const a=r-c;n[o]=Math.sqrt(Math.max(0,a))}return n}solveCholesky(t,e){const n=this.forwardSubstitution(t,e);return this.backSubstitution(t,n)}forwardSubstitution(t,e){const n=t.rows,o=new Array(n);for(let r=0;r<n;r++){o[r]=e[r];for(let i=0;i<r;i++)o[r]-=t.get(r,i)*o[i];o[r]/=t.get(r,r)}return o}backSubstitution(t,e){const n=t.rows,o=new Array(n);for(let r=n-1;r>=0;r--){o[r]=e[r];for(let i=r+1;i<n;i++)o[r]-=t.get(i,r)*o[i];o[r]/=t.get(r,r)}return o}sampleStandardNormal(){const t=Math.random(),e=Math.random();return Math.sqrt(-2*Math.log(t))*Math.cos(2*Math.PI*e)}}class je extends Rn{constructor(t=1,e=1){super({length_scale:t,variance:e}),this.lengthScale=t,this.variance=e}compute(t,e){const n=this.euclideanDistance(t,e);return this.variance*Math.exp(-.5*Math.pow(n/this.lengthScale,2))}getParams(){return{length_scale:this.lengthScale,variance:this.variance}}}function In(l=0,t=1){const e=Math.random(),n=Math.random(),o=Math.sqrt(-2*Math.log(e))*Math.cos(2*Math.PI*n);return l+t*o}function jn(l,t){const e=l.length,n=Re(t),o=Array.from({length:e},()=>In()),r=new Array(e);for(let i=0;i<e;i++){r[i]=l[i];for(let s=0;s<=i;s++)r[i]+=n.get(i,s)*o[s]}return r}const wt={timeSignature:[4,4],ticksPerQuarterNote:480,beatsPerBar:4};function $t(l,t=wt){const{timeSignature:e,ticksPerQuarterNote:n}=t,[o,r]=e,i=o*4/r,s=Math.floor(l/i),c=l%i,a=Math.floor(c),h=c-a,u=Math.round(h*n);return`${s}:${a}:${u}`}function re(l,t=wt){const{timeSignature:e,ticksPerQuarterNote:n}=t,[o,r]=e,i=l.split(":");if(i.length!==3)throw new Error(`Invalid bars:beats:ticks format: ${l}`);const s=parseInt(i[0],10),c=parseFloat(i[1]),a=parseInt(i[2],10);if(isNaN(s)||isNaN(c)||isNaN(a))throw new Error(`Invalid numeric values in bars:beats:ticks: ${l}`);const h=o*4/r;return s*h+c+a/n}function $n(l,t=wt,e=!0){return l.map(n=>{const o={...n};if(n.offset!==void 0&&(o.time=n.offset,delete o.offset),typeof n.time=="string"&&n.time.includes(":")&&(o.time=re(n.time,t)),typeof n.duration=="number"&&!e){const r=n.duration;r===1?o.duration="4n":r===.5?o.duration="8n":r===.25?o.duration="16n":r===2?o.duration="2n":r===4&&(o.duration="1n")}return o})}function Gt(l,t={}){const{label:e="track",midiChannel:n=0,synth:o={type:"Synth"},timingConfig:r=wt,keepNumericDuration:i=!0}=t,s=$n(l,r,i);return{label:e,midiChannel:n,synth:o,notes:s}}class _n{data;lengthScale;amplitude;noiseLevel;walkAround;timingConfig;isFitted;gpr;constructor(t=[],e=1,n=1,o=.1,r=!1,i=wt){this.data=[...t],this.lengthScale=e,this.amplitude=n,this.noiseLevel=o,this.walkAround=r,this.timingConfig=i,this.isFitted=!1,this.gpr=null}generate(t={}){t.length,t.nsamples;const e=t.seed;return t.useStringTime,e!==void 0&&(Math.seedrandom=this.seededRandom(e)),this.data.length>0&&Array.isArray(this.data[0])?this.generateFitted(t):this.generateUnfitted(t)}generateUnfitted(t={}){const e=t.length||100,n=t.nsamples||1,o=t.lengthScale||this.lengthScale,r=t.amplitude||this.amplitude,i=t.noiseLevel||this.noiseLevel;t.useStringTime;const s=[];for(let c=0;c<n;c++){const a=Array.from({length:e},(f,k)=>[k]),h=new yt(a),m=new je(o,r).call(h);for(let f=0;f<m.rows;f++)m.set(f,f,m.get(f,f)+i);let p=new Array(e).fill(this.walkAround||0);this.walkAround&&typeof this.walkAround=="number"&&(p=new Array(e).fill(this.walkAround));const v=jn(p,m);s.push(v)}return n===1?s[0]:s}generateFitted(t={}){const e=t.length||100,n=t.nsamples||1,o=t.lengthScale||this.lengthScale,r=t.amplitude||this.amplitude,i=this.data.map(f=>[f[0]]),s=this.data.map(f=>f[1]),c=new je(o,r);this.gpr=new Ie(c);try{this.gpr.fit(i,s),this.isFitted=!0}catch(f){throw new Error(`Failed to fit Gaussian Process: ${f.message}`)}const a=Math.min(...this.data.map(f=>f[0])),u=(Math.max(...this.data.map(f=>f[0]))-a)/(e-1),m=Array.from({length:e},(f,k)=>[a+k*u]),p=this.gpr.sampleY(m,n),v=m.map(f=>f[0]);return n===1?[v,p[0]]:[v,p]}rbfKernel(t,e){let n=0;for(let o=0;o<t.length;o++)n+=Math.pow(t[o]-e[o],2);return this.amplitude*Math.exp(-n/(2*Math.pow(this.lengthScale,2)))}setData(t){this.data=[...t]}getData(){return[...this.data]}setLengthScale(t){this.lengthScale=t}setAmplitude(t){this.amplitude=t}setNoiseLevel(t){this.noiseLevel=t}toJmonNotes(t,e=[1],n=null,o={}){const{useStringTime:r=!1,mapToScale:i=null,scaleRange:s=[60,72],quantize:c=!1}=o,a=[];let h=0;const u=Array.isArray(t[0])?t:[t],m=n||Array.from({length:u[0].length},(p,v)=>v);for(let p=0;p<u[0].length;p++){const v=e[p%e.length],f=n?m[p]:h,k=u.map(V=>{let O=V[p];if(i){const L=Math.min(...V),W=Math.max(...V)-L||1,at=(O-L)/W,U=Math.floor(at*i.length),K=Math.max(0,Math.min(U,i.length-1));O=i[K]}else{const L=Math.min(...V),W=Math.max(...V)-L||1,at=(O-L)/W;O=s[0]+at*(s[1]-s[0])}return c&&(O=Math.round(O)),O}),F=k.length===1?k[0]:k;a.push({pitch:F,duration:v,time:r?$t(f,this.timingConfig):f}),n||(h+=v)}return a}generateTrack(t={},e={}){const n=this.generate(t),o=t.durations||[1];let r;if(this.isFitted||this.data.length>0&&Array.isArray(this.data[0])){const[i,s]=n;r=this.toJmonNotes(s,o,i,t)}else r=this.toJmonNotes(n,o,null,t);return Gt(r,{label:"gaussian-process",midiChannel:0,synth:{type:"Synth"},...e})}seededRandom(t){return function(){return t=(t*9301+49297)%233280,t/233280}}}class Ln{constructor(t={}){this.width=t.width||51,this.ruleNumber=t.ruleNumber||30,this.initialState=t.initialState||this.generateRandomInitialState(),this.state=[...this.initialState],this.rules=this.loadRules(this.ruleNumber),this.history=[]}generate(t){this.history=[],this.state=[...this.initialState],this.history.push([...this.state]);for(let e=0;e<t;e++)this.updateState(),this.history.push([...this.state]);return this.history}generate01(t){return this.generate(t).map(n=>n.map(o=>o>0?1:0))}loadRules(t){const e=t.toString(2).padStart(8,"0"),n={},o=["111","110","101","100","011","010","001","000"];for(let r=0;r<8;r++)n[o[r]]=parseInt(e[r],10);return n}updateState(){const t=new Array(this.width);for(let e=0;e<this.width;e++){const n=this.state[(e-1+this.width)%this.width],o=this.state[e],r=this.state[(e+1)%this.width],i=`${n}${o}${r}`;t[e]=this.rules[i]||0}this.state=t}validateStrips(t){if(!Array.isArray(t)||t.length===0)return!1;const e=t[0]?.length;return e?t.every(n=>Array.isArray(n)&&n.length===e&&n.every(o=>typeof o=="number"&&(o===0||o===1))):!1}validateValues(t){return Array.isArray(t)&&t.length===this.width&&t.every(e=>typeof e=="number"&&(e===0||e===1))}setInitialState(t){if(this.validateValues(t))this.initialState=[...t],this.state=[...t];else throw new Error("Invalid initial state")}setRuleNumber(t){if(t>=0&&t<=255)this.ruleNumber=t,this.rules=this.loadRules(t);else throw new Error("Rule number must be between 0 and 255")}getHistory(){return this.history.map(t=>[...t])}getCurrentState(){return[...this.state]}generateRandomInitialState(){const t=new Array(this.width).fill(0);return t[Math.floor(this.width/2)]=1,t}generateRandomState(){return Array.from({length:this.width},()=>Math.random()>.5?1:0)}plot(){return{data:this.getHistory(),width:this.width,height:this.history.length}}async plotEvolution(t){return(await Promise.resolve().then(()=>ge)).CAVisualizer.plotEvolution(this.getHistory(),t)}async plotGeneration(t){return(await Promise.resolve().then(()=>ge)).CAVisualizer.plotGeneration(this.getCurrentState(),t)}async plotDensity(t){return(await Promise.resolve().then(()=>ge)).CAVisualizer.plotDensity(this.getHistory(),t)}}class qt{constructor(t,e=4,n=!0){if(!t)throw new Error("Loops parameter is required");if(typeof e!="number"||e<=0)throw new Error("measureLength must be a positive number");if(typeof n!="boolean")throw new Error("insertRests must be a boolean");if(this.measureLength=e,Array.isArray(t)){if(t.length===0)throw new Error("Loops array cannot be empty");const o={};t.forEach((r,i)=>{const s=r?.label||`Loop ${i+1}`;o[s]=r}),t=o}if(typeof t!="object"||Object.keys(t).length===0)throw new Error("Loops must be a non-empty object or array");this.loops={};for(const[o,r]of Object.entries(t)){if(!r)throw new Error(`Loop data for "${o}" is null or undefined`);const i=Array.isArray(r)?r:r.notes||[];if(!Array.isArray(i))throw new Error(`Notes for loop "${o}" must be an array`);const s=i.map((c,a)=>{if(!c||typeof c!="object")throw new Error(`Note ${a} in loop "${o}" must be an object`);if(c.pitch!==null&&(typeof c.pitch!="number"||c.pitch<0||c.pitch>127))throw new Error(`Note ${a} in loop "${o}" has invalid pitch: ${c.pitch}`);if(typeof c.time!="number"||c.time<0)throw new Error(`Note ${a} in loop "${o}" has invalid time: ${c.time}`);if(typeof c.duration!="number"||c.duration<=0)throw new Error(`Note ${a} in loop "${o}" has invalid duration: ${c.duration}`);return{pitch:c.pitch,time:c.time,duration:c.duration,velocity:typeof c.velocity=="number"?Math.max(0,Math.min(1,c.velocity)):.8}});this.loops[o]={label:r.label||o,notes:n?this.fillGapsWithRests(s):s,synth:r.synth||{type:"Synth",options:{oscillator:{type:"sine"},envelope:{attack:.01,decay:.1,sustain:.3,release:.5}}}}}}fillGapsWithRests(t){if(t.length===0)return t;const e=[];let n=0;const o=[...t].sort((r,i)=>r.time-i.time);for(const r of o)r.time>n&&e.push({pitch:null,duration:r.time-n,time:n,velocity:0}),e.push({pitch:r.pitch,duration:r.duration,time:r.time,velocity:r.velocity||.8}),n=r.time+r.duration;return e}static fromTrack(t,e=4){if((t.notes||[]).length===0)throw new Error("Track must have notes to create loop");return new qt({[t.label||"Track"]:t},e)}static euclidean(t,e,n=[60],o=null){if(typeof t!="number"||t<=0||!Number.isInteger(t))throw new Error("beats must be a positive integer");if(typeof e!="number"||e<0||!Number.isInteger(e))throw new Error("pulses must be a non-negative integer");if(e>t)throw new Error("pulses cannot be greater than beats");if(!Array.isArray(n)||n.length===0)throw new Error("pitches must be a non-empty array");const r=this.generateEuclideanRhythm(t,e),i=[],s=1;r.forEach((a,h)=>{if(a){const u=h*s,m=n[h%n.length];i.push({pitch:m,duration:s*.8,time:u,velocity:.8})}});const c={label:o||`Euclidean ${e}/${t}`,notes:i,synth:{type:"Synth",options:{oscillator:{type:"sine"},envelope:{attack:.01,decay:.1,sustain:.3,release:.5}}}};return new qt({[c.label]:c},t)}static generateEuclideanRhythm(t,e){if(e===0)return Array(t).fill(!1);if(e>=t)return Array(t).fill(!0);let n=[{pattern:[1],count:e},{pattern:[0],count:t-e}];for(;n.length>1;){const[i,s]=n;if(i.count<=s.count){const c=i.count,a=s.count-i.count;n=[{pattern:[...s.pattern,...i.pattern],count:c}],a>0&&n.push({pattern:s.pattern,count:a})}else{const c=s.count,a=i.count-s.count;n=[{pattern:[...i.pattern,...s.pattern],count:c}],a>0&&n.push({pattern:i.pattern,count:a})}}const o=n[0],r=[];for(let i=0;i<o.count;i++)r.push(...o.pattern);return r.map(i=>i===1)}toJMonSequences(){return Object.values(this.loops)}async plot(t=1/4,e=null,n={}){const{LoopVisualizer:o}=await Promise.resolve().then(()=>Yo);return o.plotLoops(this.loops,this.measureLength,t,e,n)}}class Yt{constructor(t){this.sequence=t.filter(e=>e!=null),this.originalSequence=t}gini(){if(this.sequence.length===0)return 0;const t=[...this.sequence].sort((r,i)=>r-i),e=t.length;let n=0;for(let r=0;r<e;r++)n+=(2*(r+1)-e-1)*t[r];const o=t.reduce((r,i)=>r+i,0);return o===0?0:n/(e*o)}balance(){if(this.sequence.length===0)return 0;const t=this.sequence.reduce((n,o)=>n+o,0)/this.sequence.length,e=this.sequence.reduce((n,o)=>n+Math.pow(o-t,2),0)/this.sequence.length;return t===0?0:Math.sqrt(e)/Math.abs(t)}motif(t=4){if(this.sequence.length<2)return 0;const e=new Map;let n=0;for(let r=2;r<=Math.min(t,this.sequence.length);r++)for(let i=0;i<=this.sequence.length-r;i++){const s=this.sequence.slice(i,i+r).join(",");e.set(s,(e.get(s)||0)+1),n++}let o=0;for(const r of e.values())r>1&&(o+=r*r);return n===0?0:o/n}dissonance(t){if(!t||t.length===0||this.sequence.length===0)return 0;const e=new Set(t.map(o=>o%12));let n=0;for(const o of this.sequence)if(o!=null){const r=o%12;e.has(r)||n++}return n/this.sequence.length}rhythmic(t=4){if(this.sequence.length===0)return 0;let e=0,n=0;const o=this.sequence.reduce((r,i)=>r+i,0);for(const r of this.sequence){const i=e+r,s=Math.floor(e/t),c=Math.floor(i/t);if(s!==c){const a=t-e%t;a<r&&a>0&&(n+=Math.min(a,r-a))}e=i}return o===0?0:1-n/o}restProportion(){return this.originalSequence.length===0?0:this.originalSequence.filter(e=>e==null).length/this.originalSequence.length}calculateAll(t=null,e=4){return{gini:this.gini(),balance:this.balance(),motif:this.motif(),dissonance:t?this.dissonance(t):0,rhythmic:this.rhythmic(e),rest:this.restProportion()}}getStats(){if(this.sequence.length===0)return{mean:0,std:0,min:0,max:0,range:0};const t=this.sequence.reduce((i,s)=>i+s,0)/this.sequence.length,e=this.sequence.reduce((i,s)=>i+Math.pow(s-t,2),0)/this.sequence.length,n=Math.sqrt(e),o=Math.min(...this.sequence),r=Math.max(...this.sequence);return{mean:t,std:n,min:o,max:r,range:r-o}}similarity(t,e=null,n=4){const o=this.calculateAll(e,n),r=t.calculateAll(e,n);let i=0,s=0;for(const[c,a]of Object.entries(o)){const h=r[c];if(typeof a=="number"&&typeof h=="number"){const u=Math.max(Math.abs(a),Math.abs(h),1),m=1-Math.abs(a-h)/u;i+=m,s++}}return s===0?0:i/s}}class Fn{constructor(t={}){const{initialPhrases:e=[],mutationRate:n=.05,populationSize:o=50,mutationProbabilities:r=null,scale:i=null,measureLength:s=4,timeResolution:c=[.125,4],weights:a=null,targets:h=null,seed:u=null}=t;this.initialPhrases=e,this.mutationRate=n,this.populationSize=o,this.scale=i,this.measureLength=s,this.timeResolution=c,u!==null?(this.seed=u,this.randomState=this.createSeededRandom(u)):this.randomState=Math;const m=[.125,.25,.5,1,2,3,4,8];this.possibleDurations=m.filter(p=>p>=c[0]&&p<=Math.min(c[1],s)),this.mutationProbabilities=r||{pitch:()=>Math.max(0,Math.min(127,Math.floor(this.gaussianRandom(60,5)))),duration:()=>{const p=this.possibleDurations.map((v,f)=>Math.pow(2,-f));return this.weightedChoice(this.possibleDurations,p)},rest:()=>this.randomState.random()<.02?null:1},this.weights=a||{gini:[1,1,0],balance:[1,1,0],motif:[10,1,0],dissonance:[1,0,0],rhythmic:[0,10,0],rest:[1,0,0]},this.targets=h||{gini:[.05,.5,0],balance:[.1,.1,0],motif:[1,1,0],dissonance:[0,0,0],rhythmic:[0,1,0],rest:[0,0,0]},this.population=this.initializePopulation(),this.bestIndividuals=[],this.bestScores=[],this.generationCount=0}createSeededRandom(t){let e=t;const n=()=>(e=(e*9301+49297)%233280,e/233280);return{random:n,choice:o=>o[Math.floor(n()*o.length)],sample:(o,r)=>[...o].sort(()=>n()-.5).slice(0,r)}}gaussianRandom(t=0,e=1){if(this.gaussianSpare!==void 0){const i=this.gaussianSpare;return this.gaussianSpare=void 0,t+e*i}const n=this.randomState.random(),o=this.randomState.random(),r=e*Math.sqrt(-2*Math.log(n));return this.gaussianSpare=r*Math.cos(2*Math.PI*o),t+r*Math.sin(2*Math.PI*o)}weightedChoice(t,e){const n=e.reduce((r,i)=>r+i,0);let o=this.randomState.random()*n;for(let r=0;r<t.length;r++)if(o-=e[r],o<=0)return t[r];return t[t.length-1]}initializePopulation(){const t=[],e=Math.floor(this.populationSize/this.initialPhrases.length);for(const n of this.initialPhrases)for(let o=0;o<e;o++)t.push(this.mutate(n,0));for(;t.length<this.populationSize;){const n=this.randomState.choice(this.initialPhrases);t.push(this.mutate(n,0))}return t}calculateFitnessComponents(t){if(t.length===0)return{};const e=t.map(s=>s[0]),n=t.map(s=>s[1]),o=t.map(s=>s[2]),r={};if(e.length>0){const s=new Yt(e);r.gini_pitch=s.gini(),r.balance_pitch=s.balance(),r.motif_pitch=s.motif(),this.scale&&(r.dissonance_pitch=s.dissonance(this.scale))}if(n.length>0){const s=new Yt(n);r.gini_duration=s.gini(),r.balance_duration=s.balance(),r.motif_duration=s.motif(),r.rhythmic=s.rhythmic(this.measureLength)}if(o.length>0){const s=new Yt(o);r.gini_offset=s.gini(),r.balance_offset=s.balance(),r.motif_offset=s.motif()}const i=e.filter(s=>s==null).length/e.length;return r.rest=i,r}fitness(t){const e=this.calculateFitnessComponents(t);let n=0;for(const[o,r]of Object.entries(this.targets)){const i=this.weights[o];for(let s=0;s<3;s++){const c=s===0?`${o}_pitch`:s===1?`${o}_duration`:`${o}_offset`,a=e[c]||0,h=r[s],u=i[s];if(u>0&&h!==void 0){const m=Math.max(Math.abs(h),1),p=1-Math.abs(a-h)/m;n+=Math.max(0,p)*u}}}if(this.weights.rest[0]>0){const o=e.rest||0,r=this.targets.rest[0],i=1-Math.abs(o-r)/Math.max(r,1);n+=Math.max(0,i)*this.weights.rest[0]}return n}mutate(t,e=null){e===null&&(e=this.mutationRate);const n=[];let o=0;for(const r of t){let[i,s,c]=r;this.randomState.random()<e&&(i=this.mutationProbabilities.pitch()),this.randomState.random()<e&&(s=this.mutationProbabilities.duration()),this.randomState.random()<e&&this.mutationProbabilities.rest()===null&&(i=null);const a=o;o+=s,n.push([i,s,a])}return n}select(t=25){const e=this.population.map(n=>({phrase:n,fitness:this.fitness(n)}));return e.sort((n,o)=>o.fitness-n.fitness),e.slice(0,t).map(n=>n.phrase)}crossover(t,e){if(t.length===0||e.length===0)return t.length>0?[...t]:[...e];const n=Math.min(t.length,e.length),o=Math.floor(this.randomState.random()*n),r=Math.floor(this.randomState.random()*n),[i,s]=[Math.min(o,r),Math.max(o,r)],c=[];for(let h=0;h<i;h++)h<t.length&&c.push([...t[h]]);for(let h=i;h<s;h++)h<e.length&&c.push([...e[h]]);for(let h=s;h<Math.max(t.length,e.length);h++)h<t.length?c.push([...t[h]]):h<e.length&&c.push([...e[h]]);let a=0;for(let h=0;h<c.length;h++)c[h][2]=a,a+=c[h][1];return c}evolve(t=25){const e=this.select(t),n=this.fitness(e[0]);this.bestIndividuals.push([...e[0]]),this.bestScores.push(n);const o=[];for(;o.length<this.populationSize;){const r=this.randomState.choice(e),i=this.randomState.choice(e),s=this.crossover([...r],[...i]),c=this.mutate(s);o.push(c)}return this.population=o,this.generationCount++,{generation:this.generationCount,bestFitness:n,averageFitness:e.reduce((r,i)=>r+this.fitness(i),0)/e.length,populationSize:this.populationSize}}evolveGenerations(t,e=25,n=null){const o=[];for(let r=0;r<t;r++){const i=this.evolve(e);o.push(i),n&&n(i,r,t)}return o}getBestIndividual(){return this.bestIndividuals.length>0?[...this.bestIndividuals[this.bestIndividuals.length-1]]:null}getEvolutionHistory(){return{individuals:this.bestIndividuals.map(t=>[...t]),scores:[...this.bestScores],generations:this.generationCount}}reset(){this.population=this.initializePopulation(),this.bestIndividuals=[],this.bestScores=[],this.generationCount=0}getPopulationStats(){const t=this.population.map(o=>this.fitness(o)),e=t.reduce((o,r)=>o+r,0)/t.length,n=t.reduce((o,r)=>o+Math.pow(r-e,2),0)/t.length;return{populationSize:this.population.length,meanFitness:e,standardDeviation:Math.sqrt(n),minFitness:Math.min(...t),maxFitness:Math.max(...t),generation:this.generationCount}}}class Vn{options;walkers;history;constructor(t={}){this.options={length:t.length||100,dimensions:t.dimensions||1,stepSize:t.stepSize||1,bounds:t.bounds||[-100,100],branchProbability:t.branchProbability||.05,mergeProbability:t.mergeProbability||.02,attractorStrength:t.attractorStrength||0,attractorPosition:t.attractorPosition||Array(t.dimensions||1).fill(0)},this.walkers=[],this.history=[]}generate(t){this.initialize(t),this.history=[];for(let e=0;e<this.options.length;e++)this.updateWalkers(),this.recordState(),this.handleBranching(),this.handleMerging();return this.history}initialize(t){const e=t||Array(this.options.dimensions).fill(0);this.walkers=[{position:[...e],velocity:Array(this.options.dimensions).fill(0),branches:[],age:0,active:!0}]}updateWalkers(){for(const t of this.walkers)if(t.active){for(let e=0;e<this.options.dimensions;e++){const n=(Math.random()-.5)*2*this.options.stepSize;let o=0;if(this.options.attractorStrength>0){const r=t.position[e]-this.options.attractorPosition[e];o=-this.options.attractorStrength*r}t.velocity[e]=t.velocity[e]*.9+n+o,t.position[e]+=t.velocity[e],t.position[e]<this.options.bounds[0]?(t.position[e]=this.options.bounds[0],t.velocity[e]*=-.5):t.position[e]>this.options.bounds[1]&&(t.position[e]=this.options.bounds[1],t.velocity[e]*=-.5)}t.age++}}recordState(){const t=this.walkers.filter(e=>e.active);if(t.length>0){const e=Array(this.options.dimensions).fill(0);for(const n of t)for(let o=0;o<this.options.dimensions;o++)e[o]+=n.position[o];for(let n=0;n<this.options.dimensions;n++)e[n]/=t.length;this.history.push([...e])}}handleBranching(){const t=[];for(const e of this.walkers)if(e.active&&Math.random()<this.options.branchProbability){const n={position:[...e.position],velocity:e.velocity.map(o=>o+(Math.random()-.5)*this.options.stepSize),branches:[],age:0,active:!0};t.push(n),e.branches.push(n)}this.walkers.push(...t)}handleMerging(){if(this.walkers.length<=1)return;const t=this.walkers.filter(n=>n.active),e=this.options.stepSize*2;for(let n=0;n<t.length;n++)for(let o=n+1;o<t.length;o++)if(Math.random()<this.options.mergeProbability&&this.calculateDistance(t[n].position,t[o].position)<e){for(let i=0;i<this.options.dimensions;i++)t[n].position[i]=(t[n].position[i]+t[o].position[i])/2,t[n].velocity[i]=(t[n].velocity[i]+t[o].velocity[i])/2;t[o].active=!1}this.walkers=this.walkers.filter(n=>n.active)}calculateDistance(t,e){let n=0;for(let o=0;o<t.length;o++)n+=Math.pow(t[o]-e[o],2);return Math.sqrt(n)}getProjection(t=0){return this.history.map(e=>e[t]||0)}mapToScale(t=0,e=[0,2,4,5,7,9,11],n=3){const o=this.getProjection(t);if(o.length===0)return[];const r=Math.min(...o),s=Math.max(...o)-r||1;return o.map(c=>{const a=(c-r)/s,h=Math.floor(a*e.length*n),u=Math.floor(h/e.length),m=h%e.length;return 60+u*12+e[m]})}mapToRhythm(t=0,e=[.25,.5,1,2]){const n=this.getProjection(t);if(n.length===0)return[];const o=Math.min(...n),i=Math.max(...n)-o||1;return n.map(s=>{const c=(s-o)/i,a=Math.floor(c*e.length),h=Math.max(0,Math.min(a,e.length-1));return e[h]})}mapToVelocity(t=0,e=.3,n=1){const o=this.getProjection(t);if(o.length===0)return[];const r=Math.min(...o),s=Math.max(...o)-r||1;return o.map(c=>{const a=(c-r)/s;return e+a*(n-e)})}generateCorrelated(t,e=.5,n=0){if(t.length===0)return[];const o=[];let r=0;for(let i=0;i<t.length;i++){const s=(Math.random()-.5)*2*this.options.stepSize,c=e*(t[i]-r);r+=s+c,r=Math.max(this.options.bounds[0],Math.min(this.options.bounds[1],r)),o.push(r)}return o}analyze(){if(this.history.length<2)return{meanDisplacement:0,meanSquaredDisplacement:0,totalDistance:0,fractalDimension:0};const t=this.getProjection(0),e=t[0],n=t[t.length-1],o=Math.abs(n-e),r=t.map(a=>Math.pow(a-e,2)),i=r.reduce((a,h)=>a+h,0)/r.length;let s=0;for(let a=1;a<t.length;a++)s+=Math.abs(t[a]-t[a-1]);const c=s>0?Math.log(s)/Math.log(t.length):0;return{meanDisplacement:o,meanSquaredDisplacement:i,totalDistance:s,fractalDimension:c}}getWalkerStates(){return this.walkers.map(t=>({...t}))}reset(){this.walkers=[],this.history=[]}toJmonNotes(t=[1],e={}){const{useStringTime:n=!1,timingConfig:o=wt,dimension:r=0,mapToScale:i=null,scaleRange:s=[60,72]}=e,c=this.getProjection(r),a=[];let h=0;for(let u=0;u<c.length;u++){const m=t[u%t.length];let p=c[u];if(i){const v=Math.min(...c),k=Math.max(...c)-v||1,F=(p-v)/k,V=Math.floor(F*i.length),O=Math.max(0,Math.min(V,i.length-1));p=i[O]}else p=this.mapToScale([c],i||[60,62,64,65,67,69,71])[0][u];a.push({pitch:p,duration:m,time:n?$t(h,o):h}),h+=m}return a}generateTrack(t,e=[1],n={},o={}){this.generate(t);const r=this.toJmonNotes(e,n);return Gt(r,{label:"random-walk",midiChannel:0,synth:{type:"Synth"},...o})}}class On{walkRange;walkStart;walkProbability;roundTo;branchingProbability;mergingProbability;timingConfig;constructor(t={}){this.walkRange=t.walkRange||null,this.walkStart=t.walkStart!==void 0?t.walkStart:this.walkRange?Math.floor((this.walkRange[1]-this.walkRange[0])/2)+this.walkRange[0]:0,this.walkProbability=t.walkProbability||[-1,0,1],this.roundTo=t.roundTo!==void 0?t.roundTo:null,this.branchingProbability=t.branchingProbability||0,this.mergingProbability=t.mergingProbability||0,this.timingConfig=t.timingConfig||wt}generate(t,e){let n=Math.random;e!==void 0&&(n=this.createSeededRandom(e));const o=[this.initializeWalk(t)];let r=[this.walkStart];for(let i=1;i<t;i++){const s=[...r],c=[];for(let a=0;a<r.length;a++){const h=o[a],u=r[a];if(u===null){h&&(h[i]=null);continue}const m=this.generateStep(n);let p=u+m;if(isNaN(p)&&(p=u),this.walkRange!==null&&(p<this.walkRange[0]?p=this.walkRange[0]:p>this.walkRange[1]&&(p=this.walkRange[1])),isNaN(p)&&(p=this.walkStart),h&&(h[i]=p),s[a]=p,n()<this.branchingProbability){const v=this.createBranch(o[a],i),f=this.generateStep(n);let k=u+f;isNaN(k)&&(k=u),this.walkRange!==null&&(k<this.walkRange[0]?k=this.walkRange[0]:k>this.walkRange[1]&&(k=this.walkRange[1])),isNaN(k)&&(k=this.walkStart),v[i]=k,c.push(v),s.push(k)}}o.push(...c),r=s,r=this.handleMerging(o,r,i,n)}return o}generateStep(t=Math.random){if(Array.isArray(this.walkProbability))return this.walkProbability[Math.floor(t()*this.walkProbability.length)];if(typeof this.walkProbability=="object"&&this.walkProbability.mean!==void 0&&this.walkProbability.std!==void 0){let e=this.generateNormal(this.walkProbability.mean,this.walkProbability.std,t);return this.roundTo!==null&&(e=parseFloat(e.toFixed(this.roundTo))),e}return[-1,0,1][Math.floor(t()*3)]}generateNormal(t,e,n=Math.random){let o,r;do o=n();while(o===0);r=n();const i=Math.sqrt(-2*Math.log(o))*Math.cos(2*Math.PI*r),s=t+e*i;return isNaN(s)?t:s}initializeWalk(t){const e=new Array(t);e[0]=this.walkStart;for(let n=1;n<t;n++)e[n]=null;return e}createBranch(t,e){const n=new Array(t.length);for(let o=0;o<e;o++)n[o]=null;for(let o=e;o<n.length;o++)n[o]=null;return n}handleMerging(t,e,n,o=Math.random){const r=[...e];for(let i=0;i<e.length;i++)if(e[i]!==null)for(let s=i+1;s<e.length;s++){if(e[s]===null)continue;const c=this.roundTo!==null?this.roundTo:.001;if(Math.abs(e[i]-e[s])<=c&&o()<this.mergingProbability&&(r[s]=null,t[s]))for(let a=n;a<t[s].length;a++)t[s][a]=null}return r}toJmonNotes(t,e=[1],n={}){const o=n.useStringTime||!1,r=[];let i=0,s=0;const c=Math.max(...t.map(a=>a.length));for(let a=0;a<c;a++){const h=t.map(u=>u[a]).filter(u=>u!==null);if(h.length>0){const u=e[s%e.length],m=h.length===1?h[0]:h;r.push({pitch:m,duration:u,time:o?$t(i,this.timingConfig):i}),i+=u,s++}}return r}generateTrack(t,e=[1],n={}){const o=this.generate(t,n.seed),r=this.toJmonNotes(o,e,n);return Gt(r,{label:"random-walk",midiChannel:0,synth:{type:"Synth"},...n})}mapToScale(t,e=[60,62,64,65,67,69,71]){return t.map(n=>n.map(o=>{if(o===null)return null;const r=this.walkRange[0],s=this.walkRange[1]-r,c=(o-r)/s,a=Math.floor(c*e.length),h=Math.max(0,Math.min(a,e.length-1));return e[h]}))}createSeededRandom(t){let e=Math.abs(t)||1;return function(){e=(e*9301+49297)%233280;const n=e/233280;return Math.max(1e-7,Math.min(.9999999,n))}}}class _t{distance;frequency;phase;subPhasors;center;constructor(t=1,e=1,n=0,o=[]){this.distance=t,this.frequency=e,this.phase=n,this.subPhasors=o||[],this.center={x:0,y:0}}addSubPhasor(t){this.subPhasors.push(t)}getPosition(t){const e=this.frequency*t+this.phase,n=this.center.x+this.distance*Math.cos(e),o=this.center.y+this.distance*Math.sin(e);return{x:n,y:o,angle:e,distance:this.distance}}getDistanceFromOrigin(t){const e=this.getPosition(t);return Math.sqrt(e.x*e.x+e.y*e.y)}getAngleFromOrigin(t){const e=this.getPosition(t);let n=Math.atan2(e.y,e.x)*180/Math.PI;return n<0&&(n+=360),n}simulate(t,e={x:0,y:0}){this.center=e;const n=[];for(const o of t){const r=this.getPosition(o),i=this.getDistanceFromOrigin(o),s=this.getAngleFromOrigin(o);n.push({time:o,position:r,distance:i,angle:s,phasor:this});for(const c of this.subPhasors){c.center=r;const a=c.simulate([o],r);n.push(...a)}}return n}}class ie{phasors;timingConfig;constructor(t=wt){this.phasors=[],this.timingConfig=t}addPhasor(t){this.phasors.push(t)}simulate(t){const e=[];for(const n of this.phasors){const o=n.simulate(t);e.push(o)}return e}getAllPhasors(){const t=[];for(const e of this.phasors)t.push(e),this.collectSubPhasors(e,t);return t}collectSubPhasors(t,e){for(const n of t.subPhasors)e.push(n),this.collectSubPhasors(n,e)}mapToMusic(t,e={}){const n=this.simulate(t),o=[];for(let r=0;r<n.length;r++){const i=n[r],s=this.createMusicalTrack(i,r,e);o.push(s)}return o}createMusicalTrack(t,e,n={}){const{pitchRange:o=[40,80],durationRange:r=[.25,2],useDistance:i=!0,useAngle:s=!1,quantizeToScale:c=null,timingConfig:a=this.timingConfig,useStringTime:h=!1}=n,u=[];for(const m of t){let p,v;if(i){const f=Math.max(0,Math.min(1,m.distance/10));p=o[0]+f*(o[1]-o[0])}else p=o[0]+m.angle/360*(o[1]-o[0]);if(s)v=r[0]+m.angle/360*(r[1]-r[0]);else{const f=Math.max(0,Math.min(1,m.distance/10));v=r[1]-f*(r[1]-r[0])}if(c){const f=Math.floor((p-o[0])/(o[1]-o[0])*c.length),k=Math.max(0,Math.min(f,c.length-1));p=c[k]}else p=Math.round(p);u.push({pitch:p,duration:v,time:h?$t(m.time,a):m.time,phasorData:{distance:m.distance,angle:m.angle,position:m.position}})}return u}generateTracks(t,e={},n={}){const o=this.mapToMusic(t,e),r=[];return o.forEach((i,s)=>{const c=Gt(i,{label:`phasor-${s+1}`,midiChannel:s%16,synth:{type:"Synth"},...n});r.push(c)}),r}static createComplexSystem(){const t=new ie,e=new _t(.2,5,0),n=new _t(.3,3,Math.PI/2),o=new _t(.1,8,Math.PI);e.addSubPhasor(o);const r=new _t(2,1,0,[e,n]),i=new _t(3.5,.6,Math.PI/3);return t.addPhasor(r),t.addPhasor(i),t}static generateTimeArray(t=0,e=10,n=100){const o=[],r=(e-t)/(n-1);for(let i=0;i<n;i++)o.push(t+i*r);return o}}class Gn{constructor(t={}){this.width=t.width||100,this.height=t.height||100,this.maxIterations=t.maxIterations||100,this.xMin=t.xMin||-2.5,this.xMax=t.xMax||1.5,this.yMin=t.yMin||-2,this.yMax=t.yMax||2}generate(){const t=[];for(let e=0;e<this.height;e++){const n=[];for(let o=0;o<this.width;o++){const r=this.xMin+o/this.width*(this.xMax-this.xMin),i=this.yMin+e/this.height*(this.yMax-this.yMin),s=this.mandelbrotIterations({real:r,imaginary:i});n.push(s)}t.push(n)}return t}extractSequence(t="diagonal",e=0){const n=this.generate();switch(t){case"diagonal":return this.extractDiagonal(n);case"border":return this.extractBorder(n);case"spiral":return this.extractSpiral(n);case"column":return this.extractColumn(n,e);case"row":return this.extractRow(n,e);default:return this.extractDiagonal(n)}}mandelbrotIterations(t){let e={real:0,imaginary:0};for(let n=0;n<this.maxIterations;n++){const o=e.real*e.real-e.imaginary*e.imaginary+t.real,r=2*e.real*e.imaginary+t.imaginary;if(e.real=o,e.imaginary=r,e.real*e.real+e.imaginary*e.imaginary>4)return n}return this.maxIterations}extractDiagonal(t){const e=[],n=Math.min(t.length,t[0]?.length||0);for(let o=0;o<n;o++)e.push(t[o][o]);return e}extractBorder(t){const e=[],n=t.length,o=t[0]?.length||0;if(n===0||o===0)return e;for(let r=0;r<o;r++)e.push(t[0][r]);for(let r=1;r<n;r++)e.push(t[r][o-1]);if(n>1)for(let r=o-2;r>=0;r--)e.push(t[n-1][r]);if(o>1)for(let r=n-2;r>0;r--)e.push(t[r][0]);return e}extractSpiral(t){const e=[],n=t.length,o=t[0]?.length||0;if(n===0||o===0)return e;let r=0,i=n-1,s=0,c=o-1;for(;r<=i&&s<=c;){for(let a=s;a<=c;a++)e.push(t[r][a]);r++;for(let a=r;a<=i;a++)e.push(t[a][c]);if(c--,r<=i){for(let a=c;a>=s;a--)e.push(t[i][a]);i--}if(s<=c){for(let a=i;a>=r;a--)e.push(t[a][s]);s++}}return e}extractColumn(t,e){const n=[],o=t[0]?.length||0,r=Math.max(0,Math.min(e,o-1));for(const i of t)i[r]!==void 0&&n.push(i[r]);return n}extractRow(t,e){const n=Math.max(0,Math.min(e,t.length-1));return t[n]?[...t[n]]:[]}mapToScale(t,e=[0,2,4,5,7,9,11],n=3){if(t.length===0)return[];const o=Math.min(...t),i=Math.max(...t)-o||1;return t.map(s=>{const c=(s-o)/i,a=Math.floor(c*e.length*n),h=Math.floor(a/e.length),u=a%e.length;return 60+h*12+e[u]})}mapToRhythm(t,e=[1,2,4,8,16]){if(t.length===0)return[];const n=Math.min(...t),r=Math.max(...t)-n||1;return t.map(i=>{const s=(i-n)/r,c=Math.floor(s*e.length),a=Math.max(0,Math.min(c,e.length-1));return 1/e[a]})}}class Bn{constructor(t={}){this.r=t.r||3.8,this.x0=t.x0||.5,this.iterations=t.iterations||1e3,this.skipTransient=t.skipTransient||100}generate(){const t=[];let e=this.x0;for(let n=0;n<this.iterations+this.skipTransient;n++)e=this.r*e*(1-e),n>=this.skipTransient&&t.push(e);return t}bifurcationDiagram(t=2.5,e=4,n=1e3){const o=[],r=[],i=(e-t)/n;for(let s=0;s<n;s++){const c=t+s*i,a=this.r;this.r=c;const h=this.generate();this.r=a;const u=h.slice(-50);for(const m of u)o.push(c),r.push(m)}return{r:o,x:r}}mapToScale(t,e=[0,2,4,5,7,9,11],n=3){return t.length===0?[]:t.map(o=>{const r=Math.floor(o*e.length*n),i=Math.floor(r/e.length),s=r%e.length;return 60+i*12+e[s]})}mapToRhythm(t,e=[.25,.5,1,2]){return t.length===0?[]:t.map(n=>{const o=Math.floor(n*e.length),r=Math.max(0,Math.min(o,e.length-1));return e[r]})}mapToVelocity(t,e=.3,n=1){if(t.length===0)return[];const o=n-e;return t.map(r=>e+r*o)}detectCycles(t,e=.01){const n=[];for(let o=1;o<=Math.floor(t.length/2);o++){let r=!0;for(let i=o;i<Math.min(t.length,o*3);i++)if(Math.abs(t[i]-t[i-o])>e){r=!1;break}r&&n.push(o)}return n}lyapunovExponent(t=1e4){let e=this.x0,n=0;for(let o=0;o<t;o++){const r=this.r*(1-2*e);n+=Math.log(Math.abs(r)),e=this.r*e*(1-e)}return n/t}generateCoupled(t=2,e=.1){const n=Array(t).fill(null).map(()=>[]),o=Array(t).fill(this.x0);for(let r=0;r<this.iterations+this.skipTransient;r++){const i=[...o];for(let s=0;s<t;s++){let c=0;for(let a=0;a<t;a++)a!==s&&(c+=e*(o[a]-o[s]));i[s]=this.r*o[s]*(1-o[s])+c,i[s]=Math.max(0,Math.min(1,i[s]))}if(o.splice(0,t,...i),r>=this.skipTransient)for(let s=0;s<t;s++)n[s].push(o[s])}return n}setRegime(t,e){switch(t){case"periodic":this.r=3.2;break;case"chaotic":this.r=3.9;break;case"edge":this.r=3.57;break;case"custom":e!==void 0&&(this.r=Math.max(0,Math.min(4,e)));break}}getParameters(){return{r:this.r,x0:this.x0,iterations:this.iterations,skipTransient:this.skipTransient}}}class zn{operation;direction;repetition;timingConfig;sequence=[];constructor(t){const{operation:e,direction:n,repetition:o,timingConfig:r=wt}=t;if(!["additive","subtractive"].includes(e))throw new Error("Invalid operation. Choose 'additive' or 'subtractive'.");if(!["forward","backward","inward","outward"].includes(n))throw new Error("Invalid direction. Choose 'forward', 'backward', 'inward' or 'outward'.");if(o<0||!Number.isInteger(o))throw new Error("Invalid repetition value. Must be an integer greater than or equal to 0.");this.operation=e,this.direction=n,this.repetition=o,this.timingConfig=r}generate(t){this.sequence=this.normalizeInput(t);let e;if(this.operation==="additive"&&this.direction==="forward")e=this.additiveForward();else if(this.operation==="additive"&&this.direction==="backward")e=this.additiveBackward();else if(this.operation==="additive"&&this.direction==="inward")e=this.additiveInward();else if(this.operation==="additive"&&this.direction==="outward")e=this.additiveOutward();else if(this.operation==="subtractive"&&this.direction==="forward")e=this.subtractiveForward();else if(this.operation==="subtractive"&&this.direction==="backward")e=this.subtractiveBackward();else if(this.operation==="subtractive"&&this.direction==="inward")e=this.subtractiveInward();else if(this.operation==="subtractive"&&this.direction==="outward")e=this.subtractiveOutward();else throw new Error("Invalid operation/direction combination");const n=this.adjustOffsets(e);return this.toJmonNotes(n,!1)}additiveForward(){const t=[];for(let e=0;e<this.sequence.length;e++){const n=this.sequence.slice(0,e+1);for(let o=0;o<=this.repetition;o++)t.push(...n)}return t}additiveBackward(){const t=[];for(let e=this.sequence.length;e>0;e--){const n=this.sequence.slice(e-1);for(let o=0;o<=this.repetition;o++)t.push(...n)}return t}additiveInward(){const t=[],e=this.sequence.length;for(let n=0;n<Math.ceil(e/2);n++){let o;if(n<e-n-1){const r=this.sequence.slice(0,n+1),i=this.sequence.slice(e-n-1);o=[...r,...i]}else o=[...this.sequence];for(let r=0;r<=this.repetition;r++)t.push(...o)}return t}additiveOutward(){const t=[],e=this.sequence.length;if(e%2===0){const n=Math.floor(e/2)-1,o=Math.floor(e/2);for(let r=0;r<e/2;r++){const i=this.sequence.slice(n-r,o+r+1);for(let s=0;s<=this.repetition;s++)t.push(...i)}}else{const n=Math.floor(e/2);for(let o=0;o<=n;o++){const r=this.sequence.slice(n-o,n+o+1);for(let i=0;i<=this.repetition;i++)t.push(...r)}}return t}subtractiveForward(){const t=[];for(let e=0;e<this.sequence.length;e++){const n=this.sequence.slice(e);for(let o=0;o<=this.repetition;o++)t.push(...n)}return t}subtractiveBackward(){const t=[];for(let e=this.sequence.length;e>0;e--){const n=this.sequence.slice(0,e);for(let o=0;o<=this.repetition;o++)t.push(...n)}return t}subtractiveInward(){const t=[],e=this.sequence.length,n=Math.floor(e/2);for(let o=0;o<=this.repetition;o++)t.push(...this.sequence);for(let o=1;o<=n;o++){const r=this.sequence.slice(o,e-o);if(r.length>0)for(let i=0;i<=this.repetition;i++)t.push(...r)}return t}subtractiveOutward(){const t=[];let e=[...this.sequence];for(let n=0;n<=this.repetition;n++)t.push(...e);for(;e.length>2;){e=e.slice(1,-1);for(let n=0;n<=this.repetition;n++)t.push(...e)}return t}normalizeInput(t){return Array.isArray(t)?Array.isArray(t[0])?t.map(([e,n,o=0])=>({pitch:e,duration:n,offset:o})):t.map(e=>{const n=e.pitch,o=e.duration;let r=0;return typeof e.offset=="number"?r=e.offset:typeof e.time=="number"?r=e.time:typeof e.time=="string"&&(r=this.timeToBeats(e.time)),{...e,pitch:n,duration:o,offset:r}}):[]}beatsToTime(t){return $t(t,this.timingConfig)}timeToBeats(t){return typeof t!="string"?Number(t)||0:re(t,this.timingConfig)}adjustOffsets(t){let e=0;return t.map(n=>{const o={...n,offset:e};return e+=n.duration,o})}toJmonNotes(t,e=!1){return t.map(({pitch:n,duration:o,offset:r,...i})=>{const{time:s,...c}=i;return{pitch:n,duration:o,time:e?this.beatsToTime(r):r,...c}})}generateTrack(t,e={}){const n=this.generate(t);return Gt(n,{timingConfig:this.timingConfig,...e})}}class Dn{tChord;direction;rank;isAlternate;currentDirection;timingConfig;constructor(t,e="down",n=0,o=wt){if(!["up","down","any","alternate"].includes(e))throw new Error("Invalid direction. Choose 'up', 'down', 'any' or 'alternate'.");if(this.tChord=t,this.isAlternate=e==="alternate",this.currentDirection=this.isAlternate?"up":e,this.direction=e,this.timingConfig=o,!Number.isInteger(n)||n<0)throw new Error("Rank must be a non-negative integer.");this.rank=Math.min(n,t.length-1),this.rank>=t.length&&console.warn("Rank exceeds the length of the t-chord. Using last note of the t-chord.")}generate(t,e=!1){const n=this.normalizeInput(t),o=[];for(const r of n){if(r.pitch===void 0){const{offset:v,time:f,...k}=r;o.push({...k,pitch:void 0,time:e?this.beatsToTime(v):v});continue}const i=r.pitch,c=this.tChord.map(v=>v-i).map((v,f)=>({index:f,value:v})).sort((v,f)=>Math.abs(v.value)-Math.abs(f.value));let a=this.rank,h;if(this.currentDirection==="up"||this.currentDirection==="down"){const v=c.filter(({value:f})=>this.currentDirection==="up"?f>=0:f<=0);if(v.length===0)h=this.currentDirection==="up"?Math.max(...this.tChord):Math.min(...this.tChord);else{a>=v.length&&(a=v.length-1);const f=v[a].index;h=this.tChord[f]}}else{a>=c.length&&(a=c.length-1);const v=c[a].index;h=this.tChord[v]}this.isAlternate&&(this.currentDirection=this.currentDirection==="up"?"down":"up");const{offset:u,time:m,...p}=r;o.push({...p,pitch:h,time:e?this.beatsToTime(u):u})}return o}normalizeInput(t){return Array.isArray(t)?Array.isArray(t[0])?t.map(([e,n,o=0])=>({pitch:e,duration:n,offset:o})):t.map(e=>{const n=e.pitch,o=e.duration;let r=0;return typeof e.offset=="number"?r=e.offset:typeof e.time=="number"?r=e.time:typeof e.time=="string"&&(r=this.timeToBeats(e.time)),{...e,pitch:n,duration:o,offset:r}}):[]}beatsToTime(t){return $t(t,this.timingConfig)}timeToBeats(t){return typeof t!="string"?Number(t)||0:re(t,this.timingConfig)}}class qn{static gini(t,e){if(t.length===0)return 0;const n=t.length,o=e||Array(n).fill(1),r=t.map((u,m)=>({value:u,weight:o[m]})).sort((u,m)=>u.value-m.value),i=r.map(u=>u.value),s=r.map(u=>u.weight),c=s.reduce((u,m)=>u+m,0);let a=0,h=0;for(let u=0;u<n;u++){const m=s.slice(0,u+1).reduce((p,v)=>p+v,0);a+=s[u]*(2*m-s[u]-c)*i[u],h+=s[u]*i[u]*c}return h===0?0:a/h}static balance(t,e){if(t.length===0)return 0;const n=e||Array(t.length).fill(1),o=t.reduce((i,s,c)=>i+s*n[c],0),r=n.reduce((i,s)=>i+s,0);return r===0?0:o/r}static autocorrelation(t,e){const n=t.length,o=e||Math.floor(n/2),r=[],i=t.reduce((c,a)=>c+a,0)/n,s=t.reduce((c,a)=>c+Math.pow(a-i,2),0)/n;for(let c=0;c<=o;c++){let a=0;for(let h=0;h<n-c;h++)a+=(t[h]-i)*(t[h+c]-i);a/=n-c,r.push(s===0?0:a/s)}return r}static motif(t,e=3){if(t.length<e*2)return 0;const n=new Map;for(let i=0;i<=t.length-e;i++){const s=t.slice(i,i+e).join(",");n.set(s,(n.get(s)||0)+1)}const o=Math.max(...n.values()),r=n.size;return r===0?0:o/r}static dissonance(t,e=[0,2,4,5,7,9,11]){if(t.length===0)return 0;let n=0;for(const o of t){const r=(o%12+12)%12;e.includes(r)&&n++}return 1-n/t.length}static rhythmic(t,e=16){if(t.length===0)return 0;let n=0;const o=.1;for(const r of t){const i=r*e,s=Math.round(i);Math.abs(i-s)<=o&&n++}return n/t.length}static fibonacciIndex(t){if(t.length<2)return 0;const e=(1+Math.sqrt(5))/2;let n=0;for(let o=1;o<t.length;o++)if(t[o-1]!==0){const r=t[o]/t[o-1],i=Math.abs(r-e);n+=1/(1+i)}return n/(t.length-1)}static syncopation(t,e=4){if(t.length===0)return 0;let n=0;for(const o of t){const r=o*e%1;r>.2&&r<.8&&Math.abs(r-.5)>.2&&n++}return n/t.length}static contourEntropy(t){if(t.length<2)return 0;const e=[];for(let i=1;i<t.length;i++){const s=t[i]-t[i-1];s>0?e.push(1):s<0?e.push(-1):e.push(0)}const n={up:0,down:0,same:0};for(const i of e)i>0?n.up++:i<0?n.down++:n.same++;const o=e.length;return-[n.up/o,n.down/o,n.same/o].filter(i=>i>0).reduce((i,s)=>i+s*Math.log2(s),0)}static intervalVariance(t){if(t.length<2)return 0;const e=[];for(let r=1;r<t.length;r++)e.push(Math.abs(t[r]-t[r-1]));const n=e.reduce((r,i)=>r+i,0)/e.length;return e.reduce((r,i)=>r+Math.pow(i-n,2),0)/e.length}static density(t,e=1){if(t.length===0)return 0;const n=t.map(s=>typeof s.time=="string"?parseFloat(s.time)||0:s.time||0),o=Math.min(...n),i=Math.max(...n)-o||1;return t.length/(i/e)}static gapVariance(t){if(t.length<2)return 0;const e=[];for(let r=1;r<t.length;r++)e.push(t[r]-t[r-1]);const n=e.reduce((r,i)=>r+i,0)/e.length;return e.reduce((r,i)=>r+Math.pow(i-n,2),0)/e.length}static analyze(t,e={}){const{scale:n=[0,2,4,5,7,9,11]}=e,o=t.map(i=>typeof i.note=="number"?i.note:typeof i.note=="string"?60:Array.isArray(i.note)?i.note[0]:60),r=t.map(i=>typeof i.time=="number"?i.time:parseFloat(i.time)||0);return{gini:this.gini(o),balance:this.balance(o),motif:this.motif(o),dissonance:this.dissonance(o,n),rhythmic:this.rhythmic(r),fibonacciIndex:this.fibonacciIndex(o),syncopation:this.syncopation(r),contourEntropy:this.contourEntropy(o),intervalVariance:this.intervalVariance(o),density:this.density(t),gapVariance:this.gapVariance(r)}}}const Yn=Object.freeze(Object.defineProperty({__proto__:null,MusicalAnalysis:qn,MusicalIndex:Yt},Symbol.toStringTag,{value:"Module"}));function Ut(l,t={}){const{timeSignature:e="4/4",tempo:n=120}=t,o=Array.isArray(l?.notes)?l.notes:[],r=[];for(let i=0;i<o.length;i++){const s=o[i];if(!s||typeof s!="object")continue;const c=s.pitch===null||s.pitch===void 0,a=At(s.time,0),h=At(s.duration,0),u=a+Math.max(0,h),m=Wn(s);if(m.length!==0)for(const p of m){const v=typeof p=="string"?p:p.type;if(v)switch(v){case"staccato":{r.push({type:"durationScale",index:i,factor:.5,start:a,end:u});break}case"tenuto":{r.push({type:"durationScale",index:i,factor:1.1,start:a,end:u});break}case"accent":{r.push({type:"velocityBoost",index:i,amountBoost:.2,start:a,end:a+Math.min(.1,h)});break}case"marcato":{r.push({type:"velocityBoost",index:i,amountBoost:.3,start:a,end:a+Math.min(.15,h)}),r.push({type:"durationScale",index:i,factor:.9,start:a,end:u});break}case"glissando":case"portamento":{if(c)break;const f=Kn(s.pitch),k=typeof p.target=="number"?p.target:void 0;if(typeof f!="number"||typeof k!="number")break;r.push({type:"pitch",subtype:v,index:i,from:f,to:k,start:a,end:u,curve:p.curve||"linear"});break}case"bend":{const f=At(p.amount,void 0);if(f===void 0)break;r.push({type:"pitch",subtype:"bend",index:i,amount:f,start:a,end:u,curve:p.curve||"linear"});break}case"vibrato":{r.push({type:"pitch",subtype:"vibrato",index:i,rate:At(p.rate,5),depth:At(p.depth,50),start:a,end:u});break}case"tremolo":{r.push({type:"amplitude",subtype:"tremolo",index:i,rate:At(p.rate,8),depth:se(p.depth??.3),start:a,end:u});break}case"crescendo":case"diminuendo":{const f=se(s.velocity??.8),k=se(At(p.endVelocity,v==="crescendo"?Math.min(1,f+.2):Math.max(0,f-.2)));r.push({type:"amplitude",subtype:v,index:i,startVelocity:f,endVelocity:k,start:a,end:u,curve:p.curve||"linear"});break}}}}return{notes:o,modulations:r}}function Un(l,t={}){const n=Hn(l?.tracks).map(r=>Ut(r,t)),o=l?.metadata?{...l.metadata}:void 0;return{tracks:n,...o?{metadata:o}:{}}}function Wn(l){const t=[];if(Array.isArray(l?.articulations))for(const e of l.articulations)typeof e=="string"?t.push({type:e}):e&&typeof e=="object"&&typeof e.type=="string"&&t.push({...e});return t}function Hn(l){return Array.isArray(l)?l.map((t,e)=>Array.isArray(t?.notes)?t:{name:`Track ${e+1}`,notes:Array.isArray(t)?t:t?.notes||[]}):l&&typeof l=="object"?Object.entries(l).map(([t,e],n)=>({name:t||`Track ${n+1}`,notes:Array.isArray(e?.notes)?e.notes:Array.isArray(e)?e:[]})):[]}function Kn(l){if(l!=null){if(Array.isArray(l)){const t=l.filter(e=>typeof e=="number");return t.length===0?void 0:Math.min(...t)}if(typeof l=="number")return l}}function At(l,t){const e=typeof l=="number"?l:Number(l);return Number.isFinite(e)?e:t}function se(l){const t=At(l,0);return Number.isFinite(t)?Math.max(0,Math.min(1,t)):0}function $e(l,t={}){return Ut(l,t)}function Jn(l,t={}){return Ut(l,t)}function Xn(l,t={}){return Ut(l,t)}function Qn(l,t={}){return Un(l,t)}const Zn={compileEvents:$e,compileTimeline:Jn,deriveTimeline:Xn,compileComposition:Qn},to={harmony:pn,rhythm:Nn,motifs:{MotifBank:Cn}},eo={theory:et},no={gaussian:{Regressor:Ie,Kernel:_n},automata:{Cellular:Ln},loops:qt,genetic:{Darwin:Fn},walks:{Random:Vn,Chain:On,Phasor:{Vector:_t,System:ie}},fractals:{Mandelbrot:Gn,LogisticMap:Bn},minimalism:{Process:zn,Tintinnabuli:Dn}},oo={...Yn},ro={...hn},Ct={theory:to,constants:eo,generative:no,analysis:oo,audio:Zn,utils:ro};function io(l){const t=typeof l=="string"?parseInt(l,10):l;if(!Number.isFinite(t))return String(l);const n=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"][(t%12+12)%12],o=Math.floor(t/12)-1;return`${n}${o}`}function so(l){return!l||!Array.isArray(l.audioGraph)||l.audioGraph.forEach(t=>{try{if(!t||t.type!=="Sampler")return;const e=t.options||{},n=e.urls;if(!n||typeof n!="object")return;const o={};Object.keys(n).forEach(r=>{const i=String(r);let s=i;/^\d+$/.test(i)&&(s=io(parseInt(i,10))),o[s]=n[r]}),t.options={...e,urls:o}}catch{}}),l}class ae{constructor(t={}){this.options=t}static parseBBTToBeats(t,e=4,n=480){if(typeof t=="number")return t;if(typeof t!="string")return 0;const o=t.match(/^(\d+):(\d+(?:\.\d+)?):(\d+)$/);if(!o)return 0;const r=parseInt(o[1],10),i=parseFloat(o[2]),s=parseInt(o[3],10);return r*e+i+s/n}static parseDurationToBeats(t,e=4,n=480){if(typeof t=="number")return t;if(typeof t!="string")return 0;if(/^\d+:\d+(?:\.\d+)?:\d+$/.test(t))return this.parseBBTToBeats(t,e,n);const o=t.match(/^(\d+)(n|t)$/);if(o){const r=parseInt(o[1],10),i=o[2];if(i==="n")return 4/r;if(i==="t")return 4/r*(2/3)}return 0}convert(t){return(t.tracks||[]).map(n=>({label:n.label,type:"PolySynth",part:(n.notes||[]).map(o=>({time:o.time,pitch:o.pitch,duration:o.duration,velocity:o.velocity||.8}))}))}}function _e(l,t={}){try{so(l)}catch{}const o=new ae(t).convert(l).map((m,p)=>({originalTrackIndex:p,voiceIndex:0,totalVoices:1,trackInfo:{label:m.label},synthConfig:{type:m.type||"PolySynth"},partEvents:m.part||[]})),r=l.tempo||l.metadata?.tempo||l.bpm||120,[i,s]=(l.timeSignature||"4/4").split("/").map(m=>parseInt(m,10)),c=isFinite(i)?i:4;let a=0;o.forEach(m=>{m.partEvents&&m.partEvents.length>0&&m.partEvents.forEach(p=>{const v=ae.parseBBTToBeats(p.time,c),f=ae.parseDurationToBeats(p.duration,c),k=v+f;k>a&&(a=k)})});const h=60/r,u=a*h;return console.log(`[TONEJS] Duration calc: totalBeats=${a.toFixed(2)} beats = ${u.toFixed(2)}s - loop ends exactly when last note finishes`),{tracks:o,metadata:{totalDuration:u,tempo:r}}}const Lt={0:{name:"Acoustic Grand Piano",folder:"acoustic_grand_piano-mp3"},1:{name:"Bright Acoustic Piano",folder:"bright_acoustic_piano-mp3"},2:{name:"Electric Grand Piano",folder:"electric_grand_piano-mp3"},3:{name:"Honky-tonk Piano",folder:"honkytonk_piano-mp3"},4:{name:"Electric Piano 1",folder:"electric_piano_1-mp3"},5:{name:"Electric Piano 2",folder:"electric_piano_2-mp3"},6:{name:"Harpsichord",folder:"harpsichord-mp3"},7:{name:"Clavinet",folder:"clavinet-mp3"},8:{name:"Celesta",folder:"celesta-mp3"},9:{name:"Glockenspiel",folder:"glockenspiel-mp3"},10:{name:"Music Box",folder:"music_box-mp3"},11:{name:"Vibraphone",folder:"vibraphone-mp3"},12:{name:"Marimba",folder:"marimba-mp3"},13:{name:"Xylophone",folder:"xylophone-mp3"},14:{name:"Tubular Bells",folder:"tubular_bells-mp3"},15:{name:"Dulcimer",folder:"dulcimer-mp3"},16:{name:"Drawbar Organ",folder:"drawbar_organ-mp3"},17:{name:"Percussive Organ",folder:"percussive_organ-mp3"},18:{name:"Rock Organ",folder:"rock_organ-mp3"},19:{name:"Church Organ",folder:"church_organ-mp3"},20:{name:"Reed Organ",folder:"reed_organ-mp3"},21:{name:"Accordion",folder:"accordion-mp3"},22:{name:"Harmonica",folder:"harmonica-mp3"},23:{name:"Tango Accordion",folder:"tango_accordion-mp3"},24:{name:"Acoustic Guitar (nylon)",folder:"acoustic_guitar_nylon-mp3"},25:{name:"Acoustic Guitar (steel)",folder:"acoustic_guitar_steel-mp3"},26:{name:"Electric Guitar (jazz)",folder:"electric_guitar_jazz-mp3"},27:{name:"Electric Guitar (clean)",folder:"electric_guitar_clean-mp3"},28:{name:"Electric Guitar (muted)",folder:"electric_guitar_muted-mp3"},29:{name:"Overdriven Guitar",folder:"overdriven_guitar-mp3"},30:{name:"Distortion Guitar",folder:"distortion_guitar-mp3"},31:{name:"Guitar Harmonics",folder:"guitar_harmonics-mp3"},32:{name:"Acoustic Bass",folder:"acoustic_bass-mp3"},33:{name:"Electric Bass (finger)",folder:"electric_bass_finger-mp3"},34:{name:"Electric Bass (pick)",folder:"electric_bass_pick-mp3"},35:{name:"Fretless Bass",folder:"fretless_bass-mp3"},36:{name:"Slap Bass 1",folder:"slap_bass_1-mp3"},37:{name:"Slap Bass 2",folder:"slap_bass_2-mp3"},38:{name:"Synth Bass 1",folder:"synth_bass_1-mp3"},39:{name:"Synth Bass 2",folder:"synth_bass_2-mp3"},40:{name:"Violin",folder:"violin-mp3"},41:{name:"Viola",folder:"viola-mp3"},42:{name:"Cello",folder:"cello-mp3"},43:{name:"Contrabass",folder:"contrabass-mp3"},44:{name:"Tremolo Strings",folder:"tremolo_strings-mp3"},45:{name:"Pizzicato Strings",folder:"pizzicato_strings-mp3"},46:{name:"Orchestral Harp",folder:"orchestral_harp-mp3"},47:{name:"Timpani",folder:"timpani-mp3"},48:{name:"String Ensemble 1",folder:"string_ensemble_1-mp3"},49:{name:"String Ensemble 2",folder:"string_ensemble_2-mp3"},56:{name:"Trumpet",folder:"trumpet-mp3"},57:{name:"Trombone",folder:"trombone-mp3"},58:{name:"Tuba",folder:"tuba-mp3"},64:{name:"Soprano Sax",folder:"soprano_sax-mp3"},65:{name:"Alto Sax",folder:"alto_sax-mp3"},66:{name:"Tenor Sax",folder:"tenor_sax-mp3"},67:{name:"Baritone Sax",folder:"baritone_sax-mp3"},68:{name:"Oboe",folder:"oboe-mp3"},69:{name:"English Horn",folder:"english_horn-mp3"},70:{name:"Bassoon",folder:"bassoon-mp3"},71:{name:"Clarinet",folder:"clarinet-mp3"},72:{name:"Piccolo",folder:"piccolo-mp3"},73:{name:"Flute",folder:"flute-mp3"},74:{name:"Recorder",folder:"recorder-mp3"}},Wt=["https://raw.githubusercontent.com/jmonlabs/midi-js-soundfonts/gh-pages/FluidR3_GM","https://cdn.jsdelivr.net/gh/gleitz/midi-js-soundfonts@gh-pages/FluidR3_GM"];function Bt(l,t=Wt[0],e=[21,108],n="complete"){const o=Lt[l];if(!o)return console.warn(`GM program ${l} not found, using Acoustic Grand Piano`),Bt(0,t,e);const r={},[i,s]=e;let c=[];switch(n){case"minimal":for(let a=i;a<=s;a+=12)c.push(a);c.push(60);break;case"balanced":for(let a=i;a<=s;a+=4)c.push(a);[60,64,67].forEach(a=>{a>=i&&a<=s&&!c.includes(a)&&c.push(a)});break;case"quality":for(let a=i;a<=s;a+=3)c.push(a);break;case"complete":for(let a=i;a<=s;a++)c.push(a);break;default:return console.warn(`Unknown sampling strategy '${n}', using 'balanced'`),Bt(l,t,e,"balanced")}c=[...new Set(c)].sort((a,h)=>a-h);for(const a of c){const h=co(a);r[h]=ao(o.folder,h,t)}return console.log(`[GM INSTRUMENT] Generated ${Object.keys(r).length} sample URLs for ${o.name} (${n} strategy)`),r}function ao(l,t,e){return`${e}/${l}/${t}.mp3`}function co(l){const t=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"],e=Math.floor(l/12)-1,n=l%12;return`${t[n]}${e}`}function Le(l){const t=l.toLowerCase().trim();for(const[e,n]of Object.entries(Lt))if(n.name.toLowerCase()===t)return parseInt(e,10);for(const[e,n]of Object.entries(Lt)){const o=n.name.toLowerCase();if(o.includes(t)||t.includes(o.split(" ")[0]))return parseInt(e,10)}return null}function lo(l,t,e={},n="destination"){let o;if(typeof t=="string"){if(o=Le(t),o===null){console.warn(`GM instrument "${t}" not found. Available instruments:`);const h=Object.values(Lt).map(u=>u.name).slice(0,10);console.warn(`Examples: ${h.join(", ")}...`),console.warn("Using Acoustic Grand Piano as fallback"),o=0}}else o=t;if(!Lt[o])return null;const{baseUrl:i=Wt[0],noteRange:s=[21,108],envelope:c={attack:.1,release:1},strategy:a="complete"}=e;return{id:l,type:"Sampler",options:{urls:Bt(o,i,s,a),baseUrl:"",envelope:{enabled:!0,attack:c.attack,release:c.release}},target:n}}function Fe(){return[{program:0,name:"Acoustic Grand Piano",category:"Piano"},{program:1,name:"Bright Acoustic Piano",category:"Piano"},{program:4,name:"Electric Piano 1",category:"Piano"},{program:6,name:"Harpsichord",category:"Piano"},{program:40,name:"Violin",category:"Strings"},{program:42,name:"Cello",category:"Strings"},{program:48,name:"String Ensemble 1",category:"Strings"},{program:56,name:"Trumpet",category:"Brass"},{program:57,name:"Trombone",category:"Brass"},{program:65,name:"Alto Sax",category:"Woodwinds"},{program:71,name:"Clarinet",category:"Woodwinds"},{program:73,name:"Flute",category:"Woodwinds"},{program:24,name:"Acoustic Guitar (nylon)",category:"Guitar"},{program:25,name:"Acoustic Guitar (steel)",category:"Guitar"},{program:33,name:"Electric Bass (finger)",category:"Bass"},{program:16,name:"Drawbar Organ",category:"Organ"},{program:21,name:"Accordion",category:"Organ"}]}const uo=Object.freeze(Object.defineProperty({__proto__:null,CDN_SOURCES:Wt,GM_INSTRUMENTS:Lt,createGMInstrumentNode:lo,findGMProgramByName:Le,generateSamplerUrls:Bt,getPopularInstruments:Fe},Symbol.toStringTag,{value:"Module"})),ho=["Reverb","JCReverb","Freeverb"],mo=["Delay","FeedbackDelay","PingPongDelay"],fo=["Chorus","Phaser","Tremolo","Vibrato","AutoWah"],po=["Distortion","Chebyshev","BitCrusher"],go=["Compressor","Limiter","Gate","MidSideCompressor"],yo=["Filter","AutoFilter"],wo=["FrequencyShifter","PitchShift","StereoWidener"],bo=[...ho,...mo,...fo,...po,...go,...yo,...wo],xo=["Synth","PolySynth","MonoSynth","AMSynth","FMSynth","DuoSynth","PluckSynth","NoiseSynth"],Ve={MAX_WIDTH:800,MIN_WIDTH:0},ce={MARGIN:"8px 0",GAP:12,UPDATE_INTERVAL:100},vo={},To={DEFAULT_TEMPO:120},le={INVALID_COMPOSITION:"Composition must be a valid JMON object",NO_SEQUENCES_OR_TRACKS:"Composition must have sequences or tracks",TRACKS_MUST_BE_ARRAY:"Tracks/sequences must be an array"},ue={PLAYER:"[PLAYER]"};function Oe(l,t={}){if(!l||typeof l!="object")throw console.error(`${ue.PLAYER} Invalid composition:`,l),new Error(le.INVALID_COMPOSITION);const{autoplay:e=!1,showDebug:n=!1,customInstruments:o={},autoMultivoice:r=!0,maxVoices:i=4,Tone:s=null}=t;if(!l.sequences&&!l.tracks)throw console.error(`${ue.PLAYER} No sequences or tracks found in composition:`,l),new Error(le.NO_SEQUENCES_OR_TRACKS);const c=l.tracks||l.sequences||[];if(!Array.isArray(c))throw console.error(`${ue.PLAYER} Tracks/sequences must be an array:`,c),new Error(le.TRACKS_MUST_BE_ARRAY);const a=l.tempo||l.bpm||To.DEFAULT_TEMPO,u=_e(l,{autoMultivoice:r,maxVoices:i,showDebug:n}),{tracks:m,metadata:p}=u;let v=p.totalDuration;const f=vo,k=document.createElement("div");k.style.cssText=`
        font-family: 'PT Sans', sans-serif;
        background-color: ${f.background};
        color: ${f.text};
        padding: 16px 16px 8px 16px;
        border-radius: 12px;
        width: 100%;
        max-width: ${Ve.MAX_WIDTH}px;
        min-width: ${Ve.MIN_WIDTH};
        border: 1px solid ${f.border};
        box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        box-sizing: border-box;
    `;const F=document.createElement("style");F.textContent=`
        /* iOS audio improvements */
        .jmon-music-player-container {
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        .jmon-music-player-play {
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        /* Button hover effects */
        .jmon-music-player-btn-vertical:hover {
            background-color: #555555 !important;
            transform: translateY(-1px);
        }
        .jmon-music-player-btn-vertical:active {
            transform: translateY(0px);
        }

        /* Large screens: Show vertical downloads, hide horizontal ones, horizontal track layout */
        @media (min-width: 600px) {
            .jmon-music-player-downloads {
                display: none !important;
            }
            .jmon-music-player-vertical-downloads {
                display: flex !important;
            }
            .jmon-music-player-top {
                gap: 32px !important;
            }
            .jmon-music-player-right {
                min-width: 140px !important;
                max-width: 160px !important;
            }
            .jmon-track-selector {
                flex-direction: row !important;
                align-items: center !important;
                gap: 16px !important;
            }
            .jmon-track-selector label {
                min-width: 120px !important;
                margin-bottom: 0 !important;
                flex-shrink: 0 !important;
            }
            .jmon-track-selector select {
                flex: 1 !important;
            }
        }

        /* Medium screens: Compact layout with horizontal track selectors */
        @media (min-width: 481px) and (max-width: 799px) {
            .jmon-music-player-downloads {
                display: none !important;
            }
            .jmon-music-player-vertical-downloads {
                display: flex !important;
            }
            .jmon-music-player-top {
                gap: 20px !important;
            }
            .jmon-music-player-right {
                min-width: 120px !important;
                max-width: 140px !important;
            }
            .jmon-track-selector {
                flex-direction: row !important;
                align-items: center !important;
                gap: 12px !important;
            }
            .jmon-track-selector label {
                min-width: 100px !important;
                margin-bottom: 0 !important;
                flex-shrink: 0 !important;
                font-size: 14px !important;
            }
            .jmon-track-selector select {
                flex: 1 !important;
            }
        }

        /* Small screens: Mobile layout */
        @media (max-width: 480px) {
            .jmon-music-player-downloads {
                display: flex !important;
            }
            .jmon-music-player-vertical-downloads {
                display: none !important;
            }
            .jmon-music-player-container {
                padding: 8px !important;
                border-radius: 8px !important;
                max-width: 100vw !important;
                min-width: 0 !important;
                box-shadow: none !important;
            }
            .jmon-music-player-top {
                flex-direction: column !important;
                gap: 12px !important;
                align-items: stretch !important;
            }
            .jmon-music-player-left, .jmon-music-player-right {
                width: 100% !important;
                min-width: 0 !important;
                max-width: none !important;
                flex: none !important;
            }
            .jmon-music-player-right {
                gap: 12px !important;
            }
            .jmon-track-selector {
                flex-direction: column !important;
                align-items: stretch !important;
                gap: 8px !important;
            }
            .jmon-track-selector label {
                min-width: auto !important;
                margin-bottom: 0 !important;
            }
            .jmon-track-selector select {
                flex: none !important;
            }
            .jmon-music-player-timeline {
                gap: 8px !important;
                margin: 6px 0 !important;
            }
            .jmon-music-player-downloads {
                flex-direction: column !important;
                gap: 8px !important;
                margin-top: 6px !important;
            }
            .jmon-music-player-btn {
                min-height: 40px !important;
                font-size: 14px !important;
                padding: 10px 0 !important;
            }
            .jmon-music-player-play {
                width: 40px !important;
                height: 40px !important;
                min-width: 40px !important;
                max-width: 40px !important;
                padding: 8px !important;
                margin: 0 4px !important;
                border-radius: 50% !important;
                flex-shrink: 0 !important;
            }
            .jmon-music-player-stop {
                width: 40px !important;
                height: 40px !important;
                min-width: 40px !important;
                max-width: 40px !important;
                padding: 8px !important;
                margin: 0 4px !important;
                flex-shrink: 0 !important;
            }
        }
    `,document.head.appendChild(F),k.classList.add("jmon-music-player-container");const V=document.createElement("div");V.style.cssText=`
        display: grid;
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto auto;
        gap: 12px;
        margin-bottom: 0px;
        font-family: 'PT Sans', sans-serif;
    `,V.classList.add("jmon-music-player-main");const O=document.createElement("div");O.style.cssText=`
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        font-family: 'PT Sans', sans-serif;
        gap: 24px;
        flex-wrap: wrap;
    `,O.classList.add("jmon-music-player-top");const L=document.createElement("div");L.style.cssText=`
        display: flex;
        flex-direction: column;
        flex: 1;
        min-width: 0;
        box-sizing: border-box;
    `,L.classList.add("jmon-music-player-left");const q=document.createElement("div");q.style.cssText=`
        display: flex;
        flex-direction: column;
        gap: 6px;
    `;const W=Fe(),at=l.tracks||[],U=[];at.forEach((S,C)=>{const N=m.find(Q=>Q.originalTrackIndex===C)?.analysis;N?.hasGlissando&&console.warn(`Track ${S.label||S.name||C+1} contient un glissando : la polyphonie sera désactivée pour cette piste.`);const j=document.createElement("div");j.style.cssText=`
            margin-bottom: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        `,j.classList.add("jmon-track-selector");const B=document.createElement("label");B.textContent=S.label||`Track ${C+1}`,B.style.cssText=`
            font-family: 'PT Sans', sans-serif;
            font-size: 16px;
            color: ${f.text};
            display: block;
            margin-bottom: 0;
            font-weight: normal;
            flex-shrink: 0;
        `;const Y=document.createElement("select");Y.style.cssText=`
            padding: 4px;
            border: 1px solid ${f.secondary};
            border-radius: 4px;
            background-color: ${f.background};
            color: ${f.text};
            font-size: 12px;
            width: 100%;
            height: 28px;
            box-sizing: border-box;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            margin: 0;
            outline: none;
        `;const it=document.createElement("optgroup");it.label="Synthesizers";const rt=["PolySynth","Synth","AMSynth","DuoSynth","FMSynth","MembraneSynth","MetalSynth","MonoSynth","PluckSynth"],pt=l.audioGraph||[];if(Array.isArray(pt)&&pt.length>0){const Q=l.tracks?.[C]?.synthRef;pt.forEach($=>{if($.id&&$.type&&$.type!=="Destination"){const st=document.createElement("option");st.value=`AudioGraph: ${$.id}`,st.textContent=$.id,Q===$.id&&(st.selected=!0),it.appendChild(st)}})}rt.forEach(Q=>{const $=document.createElement("option");$.value=Q,$.textContent=Q,(N?.hasGlissando&&Q==="Synth"||!N?.hasGlissando&&!l.tracks?.[C]?.synthRef&&Q==="PolySynth")&&($.selected=!0),N?.hasGlissando&&(Q==="PolySynth"||Q==="DuoSynth")&&($.disabled=!0,$.textContent+=" (mono only for glissando)"),it.appendChild($)}),Y.appendChild(it);const Mt=document.createElement("optgroup");Mt.label="Sampled Instruments";const dt={};W.forEach(Q=>{dt[Q.category]||(dt[Q.category]=[]),dt[Q.category].push(Q)}),Object.keys(dt).sort().forEach(Q=>{const $=document.createElement("optgroup");$.label=Q,dt[Q].forEach(st=>{const z=document.createElement("option");z.value=`GM: ${st.name}`,z.textContent=st.name,N?.hasGlissando&&(z.disabled=!0,z.textContent+=" (not suitable for glissando)"),$.appendChild(z)}),Y.appendChild($)}),U.push(Y),j.append(B,Y),q.appendChild(j)}),L.appendChild(q);const K=document.createElement("div");K.style.cssText=`
        display: flex;
        flex-direction: column;
        min-width: 120px;
        max-width: 150px;
        box-sizing: border-box;
        gap: 16px;
    `,K.classList.add("jmon-music-player-right");const mt=document.createElement("div");mt.style.cssText=`
        display: flex;
        flex-direction: column;
        width: 100%;
        min-width: 0;
        box-sizing: border-box;
    `;const ut=document.createElement("label");ut.textContent="Tempo",ut.style.cssText=`
        font-family: 'PT Sans', sans-serif;
        font-size: 16px;
        font-weight: normal;
        margin-bottom: 8px;
        color: ${f.text};
    `;const J=document.createElement("input");J.type="number",J.min=60,J.max=240,J.value=a,J.style.cssText=`
        padding: 4px;
        border: 1px solid ${f.secondary};
        border-radius: 4px;
        background-color: ${f.background};
        color: ${f.text};
        font-size: 12px;
        text-align: center;
        width: 100%;
        height: 28px;
        box-sizing: border-box;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        margin: 0;
        outline: none;
    `,mt.append(ut,J);const bt=document.createElement("div");bt.style.cssText=`
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-top: 8px;
    `,bt.classList.add("jmon-music-player-vertical-downloads");const xt=document.createElement("button");xt.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-keyboard-music" style="margin-right: 8px;"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="M6 8h4"/><path d="M14 8h.01"/><path d="M18 8h.01"/><path d="M2 12h20"/><path d="M6 12v4"/><path d="M10 12v4"/><path d="M14 12v4"/><path d="M18 12v4"/></svg><span>MIDI</span>',xt.style.cssText=`
        padding: 12px 16px;
        border: none;
        border-radius: 8px;
        background-color: #333333;
        color: white;
        font-family: 'PT Sans', sans-serif;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 44px;
        box-sizing: border-box;
    `,xt.classList.add("jmon-music-player-btn-vertical");const Pt=document.createElement("button");Pt.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-audio-lines" style="margin-right: 8px;"><path d="M2 10v3"/><path d="M6 6v11"/><path d="M10 3v18"/><path d="M14 8v7"/><path d="M18 5v13"/><path d="M22 10v3"/></svg><span>WAV</span>',Pt.style.cssText=`
        padding: 12px 16px;
        border: none;
        border-radius: 8px;
        background-color: #333333;
        color: white;
        font-family: 'PT Sans', sans-serif;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 44px;
        box-sizing: border-box;
    `,Pt.classList.add("jmon-music-player-btn-vertical"),bt.append(xt,Pt),bt.style.display="none",K.append(mt,bt);const vt=document.createElement("div");vt.style.cssText=`
        position: relative;
        width: 100%;
        margin: ${ce.MARGIN};
        display: flex;
        align-items: center;
        gap: ${ce.GAP}px;
        min-width: 0;
        box-sizing: border-box;
    `,vt.classList.add("jmon-music-player-timeline");const ht=document.createElement("div");ht.textContent="0:00",ht.style.cssText=`
        font-family: 'PT Sans', sans-serif;
        font-size: 14px;
        color: ${f.text};
        min-width: 40px;
        text-align: center;
    `;const ft=document.createElement("div");ft.textContent="0:00",ft.style.cssText=`
        font-family: 'PT Sans', sans-serif;
        font-size: 14px;
        color: ${f.text};
        min-width: 40px;
        text-align: center;
    `;const nt=document.createElement("input");nt.type="range",nt.min=0,nt.max=100,nt.value=0,nt.style.cssText=`
        flex-grow: 1;
        -webkit-appearance: none;
        background: ${f.secondary};
        outline: none;
        border-radius: 15px;
        overflow: visible;
        height: 8px;
    `;const Tt=document.createElement("style");Tt.textContent=`
        input[type="range"].jmon-timeline-slider {
            background: ${f.secondary} !important;
            border: 1px solid ${f.border} !important;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1) !important;
        }
        input[type="range"].jmon-timeline-slider::-webkit-slider-track {
            background: ${f.secondary} !important;
            height: 8px !important;
            border-radius: 15px !important;
            border: 1px solid ${f.border} !important;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1) !important;
        }
        input[type="range"].jmon-timeline-slider::-moz-range-track {
            background: ${f.secondary} !important;
            height: 8px !important;
            border-radius: 15px !important;
            border: 1px solid ${f.border} !important;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1) !important;
        }
        input[type="range"].jmon-timeline-slider::-webkit-slider-thumb {
            -webkit-appearance: none !important;
            appearance: none !important;
            height: 20px !important;
            width: 20px !important;
            border-radius: 50% !important;
            background: ${f.primary} !important;
            cursor: pointer !important;
            border: 2px solid ${f.background} !important;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2) !important;
        }
        input[type="range"].jmon-timeline-slider::-moz-range-thumb {
            height: 20px !important;
            width: 20px !important;
            border-radius: 50% !important;
            background: ${f.primary} !important;
            cursor: pointer !important;
            border: 2px solid ${f.background} !important;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2) !important;
        }
    `,document.head.appendChild(Tt),nt.classList.add("jmon-timeline-slider");const H=document.createElement("button");H.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-play"><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></svg>',H.style.cssText=`
        width: 40px;
        height: 40px;
        min-width: 40px;
        max-width: 40px;
        padding: 8px;
        border: none;
        border-radius: 50%;
        background-color: ${f.primary};
        color: ${f.background};
        font-size: 16px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0px 5px 0px 10px;
        box-sizing: border-box;
        flex-shrink: 0;
    `,H.classList.add("jmon-music-player-play");const ct=document.createElement("button");ct.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-square"><rect width="18" height="18" x="3" y="3" rx="2"/></svg>',ct.style.cssText=`
        width: 40px;
        height: 40px;
        min-width: 40px;
        max-width: 40px;
        padding: 8px;
        border: none;
        border-radius: 8px;
        background-color: ${f.secondary};
        color: ${f.text};
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0px 5px 0px 0px;
        box-sizing: border-box;
        flex-shrink: 0;
    `,ct.classList.add("jmon-music-player-stop");const tt=document.createElement("div");tt.style.cssText=`
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        color: ${f.lightText};
        margin: 0px 0px 0px 10px;
    `;const lt=document.createElement("div");lt.style.cssText=`
        display: flex;
        align-items: center;
        gap: 0px;
    `,lt.append(H,ct),vt.append(ht,nt,ft,lt);const A=document.createElement("div");A.style.cssText=`
        display: flex;
        justify-content: space-between;
        margin-top: 8px;
        gap: 10px;
        min-width: 0;
        box-sizing: border-box;
    `,A.classList.add("jmon-music-player-downloads");const P=document.createElement("button");P.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-keyboard-music" style="margin-right: 5px;"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="M6 8h4"/><path d="M14 8h.01"/><path d="M18 8h.01"/><path d="M2 12h20"/><path d="M6 12v4"/><path d="M10 12v4"/><path d="M14 12v4"/><path d="M18 12v4"/></svg><span>MIDI</span>',P.style.cssText=`
        padding: 15px 30px;
        margin: 0 5px;
        border: none;
        border-radius: 8px;
        background-color: #333333;
        color: white;
        font-family: 'PT Sans', sans-serif;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.3s ease;
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 50px;
        min-width: 0;
        box-sizing: border-box;
    `,P.classList.add("jmon-music-player-btn");const b=document.createElement("button");b.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-audio-lines" style="margin-right: 5px;"><path d="M2 10v3"/><path d="M6 6v11"/><path d="M10 3v18"/><path d="M14 8v7"/><path d="M18 5v13"/><path d="M22 10v3"/></svg><span>WAV</span>',b.style.cssText=`
        padding: 15px 30px;
        margin: 0 5px;
        border: none;
        border-radius: 8px;
        background-color: #333333;
        color: white;
        font-family: 'PT Sans', sans-serif;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.3s ease;
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 50px;
        min-width: 0;
        box-sizing: border-box;
    `,b.classList.add("jmon-music-player-btn"),A.append(P,b),O.append(L,K),V.appendChild(O),V.appendChild(vt),k.append(V,A);let d,w=!1,y=[],g=[],T=[],M=null;const x=l.tracks||[],I=()=>{if(!d||!l.audioGraph||!Array.isArray(l.audioGraph))return null;const S={},C=N=>{const j={};return Object.entries(N||{}).forEach(([B,Y])=>{let it=B;if(typeof B=="number"||/^\d+$/.test(String(B)))try{it=d.Frequency(parseInt(B,10),"midi").toNote()}catch{}j[it]=Y}),j};try{return l.audioGraph.forEach(N=>{const{id:j,type:B,options:Y={},target:it}=N;if(!j||!B)return;let rt=null;if(B==="Sampler"){const pt=C(Y.urls);let Mt,dt;const Q=new Promise((st,z)=>{Mt=st,dt=z}),$={urls:pt,onload:()=>Mt&&Mt(),onerror:st=>{console.error(`[PLAYER] Sampler load error for ${j}:`,st),dt&&dt(st)}};Y.baseUrl&&($.baseUrl=Y.baseUrl);try{console.log(`[PLAYER] Building Sampler ${j} with urls:`,pt,"baseUrl:",$.baseUrl||"(none)"),rt=new d.Sampler($)}catch(st){console.error("[PLAYER] Failed to create Sampler:",st),rt=null}T.push(Q),rt&&Y.envelope&&Y.envelope.enabled&&(typeof Y.envelope.attack=="number"&&(rt.attack=Y.envelope.attack),typeof Y.envelope.release=="number"&&(rt.release=Y.envelope.release))}else if(xo.includes(B))try{rt=new d[B](Y)}catch(pt){console.warn(`[PLAYER] Failed to create ${B} from audioGraph, using PolySynth:`,pt),rt=new d.PolySynth}else if(bo.includes(B))try{rt=new d[B](Y),console.log(`[PLAYER] Created effect ${j} (${B}) with options:`,Y)}catch(pt){console.warn(`[PLAYER] Failed to create ${B} effect:`,pt),rt=null}else B==="Destination"&&(S[j]=d.Destination);rt&&(S[j]=rt)}),Object.keys(S).length>0&&l.audioGraph.forEach(N=>{const{id:j,target:B}=N;if(!j||!S[j])return;const Y=S[j];if(Y!==d.Destination)if(B&&S[B])try{S[B]===d.Destination?(Y.toDestination(),console.log(`[PLAYER] Connected ${j} -> Destination`)):(Y.connect(S[B]),console.log(`[PLAYER] Connected ${j} -> ${B}`))}catch(it){console.warn(`[PLAYER] Failed to connect ${j} -> ${B}:`,it),Y.toDestination()}else Y.toDestination(),console.log(`[PLAYER] Connected ${j} -> Destination (no target specified)`)}),S}catch(N){return console.error("[PLAYER] Failed building audioGraph instruments:",N),null}},E=()=>/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,_=S=>`${Math.floor(S/60)}:${Math.floor(S%60).toString().padStart(2,"0")}`;ft.textContent=_(v);const G=async()=>{if(typeof window<"u"){const S=s||window.Tone||(typeof d<"u"?d:null);if(S)console.log("[PLAYER] Using existing Tone.js, version:",S.version||"unknown"),window.Tone=S;else try{if(typeof require<"u"){console.log("[PLAYER] Loading Tone.js via require()...");const N=await require("tone@14.8.49/build/Tone.js");window.Tone=N.default||N.Tone||N}else{console.log("[PLAYER] Loading Tone.js via import()...");const N=await import("https://esm.sh/tone@14.8.49");window.Tone=N.default||N.Tone||N}if(!window.Tone||typeof window.Tone!="object"||!window.Tone.PolySynth){console.warn("[PLAYER] First load attempt failed, trying alternative CDN...");try{const N=await import("https://cdn.skypack.dev/tone@14.8.49");if(window.Tone=N.default||N.Tone||N,!window.Tone||!window.Tone.PolySynth)throw new Error("Alternative CDN also failed")}catch{console.warn("[PLAYER] Alternative CDN failed, trying jsdelivr...");try{const j=await import("https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.js");if(window.Tone=j.default||j.Tone||j,!window.Tone||!window.Tone.PolySynth)throw new Error("All CDN attempts failed")}catch{throw new Error("Loaded Tone.js but got invalid object from all CDNs")}}}console.log("[PLAYER] Tone.js loaded successfully, version:",window.Tone.version||"unknown")}catch(N){return console.warn("Could not auto-load Tone.js:",N.message),console.log("To use the player, load Tone.js manually first using one of these methods:"),console.log('Method 1: Tone = await require("tone@14.8.49/build/Tone.js")'),console.log('Method 2: Tone = await import("https://esm.sh/tone@14.8.49").then(m => m.default)'),console.log('Method 3: Tone = await import("https://cdn.skypack.dev/tone@14.8.49").then(m => m.default)'),!1}const C=window.Tone||S;if(C)return d=C,console.log("[PLAYER] Available Tone constructors:",{PolySynth:typeof d.PolySynth,Synth:typeof d.Synth,Part:typeof d.Part,Transport:typeof d.Transport,start:typeof d.start,context:!!d.context}),console.log("[PLAYER] Tone.js initialized, context state:",d.context?d.context.state:"no context"),E()&&console.log("[PLAYER] iOS device detected - audio context will start on user interaction"),!0}return console.warn("Tone.js not available"),!1},Z=()=>{if(!d){console.warn("[PLAYER] Tone.js not available, cannot setup audio");return}const S=[];if(d.PolySynth||S.push("PolySynth"),d.Synth||S.push("Synth"),d.Part||S.push("Part"),d.Transport||S.push("Transport"),S.length>0){console.error("[PLAYER] Tone.js is missing required constructors:",S),console.error("[PLAYER] Available Tone properties:",Object.keys(d).filter(C=>typeof d[C]=="function").slice(0,20)),console.error("[PLAYER] Tone object:",d),console.error("[PLAYER] This usually means Tone.js did not load correctly. Try refreshing the page or loading Tone.js manually.");return}if(d.Transport.bpm.value=p.tempo,console.log(`[PLAYER] Set Transport BPM to ${p.tempo} before building instruments`),!M&&(M=I(),M)){const C=Object.keys(M).filter(N=>M[N]&&M[N].name==="Sampler");C.length>0&&console.log("[PLAYER] Using audioGraph Samplers for tracks with synthRef:",C)}console.log("[PLAYER] Cleaning up existing audio...",{synths:y.length,parts:g.length}),d.Transport.stop(),d.Transport.position=0,g.forEach((C,N)=>{try{C.stop()}catch(j){console.warn(`[PLAYER] Failed to stop part ${N}:`,j)}}),g.forEach((C,N)=>{try{C.dispose()}catch(j){console.warn(`[PLAYER] Failed to dispose part ${N}:`,j)}}),y.forEach((C,N)=>{if(!M||!Object.values(M).includes(C))try{C.disconnect&&typeof C.disconnect=="function"&&C.disconnect(),C.dispose()}catch(j){console.warn(`[PLAYER] Failed to dispose synth ${N}:`,j)}}),y=[],g=[],console.log("[PLAYER] Audio cleanup completed"),console.log("[PLAYER] Converted tracks:",m.length),m.forEach(C=>{const{originalTrackIndex:N,voiceIndex:j,totalVoices:B,trackInfo:Y,synthConfig:it,partEvents:rt}=C,Mt=(x[N]||{}).synthRef,dt=60/p.tempo,Q=(rt||[]).map(z=>{const R=typeof z.time=="number"?z.time*dt:z.time,D=typeof z.duration=="number"?z.duration*dt:z.duration;return{...z,time:R,duration:D}});let $=null;if(Mt&&M&&M[Mt])$=M[Mt];else{const z=U[N]?U[N].value:it.type;try{if(z.startsWith("AudioGraph: ")){const R=z.substring(12);if(M&&M[R])$=M[R],console.log(`[PLAYER] Using audioGraph instrument: ${R}`);else throw new Error(`AudioGraph instrument ${R} not found`)}else if(z.startsWith("GM: ")){const R=z.substring(4),D=W.find(ot=>ot.name===R);if(D){console.log(`[PLAYER] Loading GM instrument: ${R}`);const ot=Bt(D.program,Wt[0],[36,84],"balanced");console.log(`[PLAYER] Loading GM instrument ${R} with ${Object.keys(ot).length} samples`),console.log("[PLAYER] Sample notes:",Object.keys(ot).sort()),$=new d.Sampler({urls:ot,onload:()=>console.log(`[PLAYER] GM instrument ${R} loaded successfully`),onerror:kt=>{console.error(`[PLAYER] Failed to load GM instrument ${R}:`,kt)}}).toDestination()}else throw new Error(`GM instrument ${R} not found`)}else{const R=it.reason==="glissando_compatibility"?it.type:z;if(!d[R]||typeof d[R]!="function")throw new Error(`Tone.${R} is not a constructor`);$=new d[R]().toDestination(),it.reason==="glissando_compatibility"&&j===0&&console.warn(`[MULTIVOICE] Using ${R} instead of ${it.original} for glissando in ${Y.label}`)}}catch(R){console.warn(`Failed to create ${z}, using PolySynth:`,R);try{if(!d.PolySynth||typeof d.PolySynth!="function")throw new Error("Tone.PolySynth is not available");$=new d.PolySynth().toDestination()}catch(D){console.error("Fatal: Cannot create any synth, Tone.js may not be properly loaded:",D);return}}}y.push($),B>1&&console.log(`[MULTIVOICE] Track "${Y.label}" voice ${j+1}: ${rt.length} notes`);const st=new d.Part((z,R)=>{if(Array.isArray(R.pitch))R.pitch.forEach(D=>{let ot="C4";typeof D=="number"?ot=d.Frequency(D,"midi").toNote():typeof D=="string"?ot=D:Array.isArray(D)&&typeof D[0]=="string"&&(ot=D[0]),$.triggerAttackRelease(ot,R.duration,z)});else if(Array.isArray(R.modulations)&&R.modulations.some(D=>D.type==="pitch"&&(D.subtype==="glissando"||D.subtype==="portamento")&&(D.to!==void 0||D.target!==void 0))){let D=typeof R.pitch=="number"?d.Frequency(R.pitch,"midi").toNote():R.pitch;const ot=R.modulations.find(It=>It.type==="pitch"&&(It.subtype==="glissando"||It.subtype==="portamento")&&(It.to!==void 0||It.target!==void 0)),kt=ot&&(ot.to!==void 0?ot.to:ot.target);let Rt=typeof kt=="number"?d.Frequency(kt,"midi").toNote():kt;console.log("[PLAYER] Glissando",{fromNote:D,toNote:Rt,duration:R.duration,time:z}),console.log("[PLAYER] Glissando effect starting from",D,"to",Rt),$.triggerAttack(D,z,R.velocity||.8);const Vt=d.Frequency(D).toFrequency(),Dt=d.Frequency(Rt).toFrequency(),Et=1200*Math.log2(Dt/Vt);if($.detune&&$.detune.setValueAtTime&&$.detune.linearRampToValueAtTime)$.detune.setValueAtTime(0,z),$.detune.linearRampToValueAtTime(Et,z+R.duration),console.log("[PLAYER] Applied detune glissando:",Et,"cents over",R.duration,"beats");else{const It=d.Frequency(D).toMidi(),Uo=d.Frequency(Rt).toMidi(),Xt=Math.max(3,Math.abs(Uo-It)),Ke=R.duration/Xt;for(let Qt=1;Qt<Xt;Qt++){const Wo=Qt/(Xt-1),Ho=Vt*Math.pow(Dt/Vt,Wo),Ko=d.Frequency(Ho).toNote(),Jo=z+Qt*Ke;$.triggerAttackRelease(Ko,Ke*.8,Jo,(R.velocity||.8)*.7)}console.log("[PLAYER] Applied chromatic glissando with",Xt,"steps")}$.triggerRelease(z+R.duration)}else{let D="C4";typeof R.pitch=="number"?D=d.Frequency(R.pitch,"midi").toNote():typeof R.pitch=="string"?D=R.pitch:Array.isArray(R.pitch)&&typeof R.pitch[0]=="string"&&(D=R.pitch[0]);let ot=R.duration,kt=R.velocity||.8;const Rt=Array.isArray(R.modulations)?R.modulations:[],Vt=Rt.find(Et=>Et.type==="durationScale"&&typeof Et.factor=="number");Vt&&(ot=R.duration*Vt.factor);const Dt=Rt.find(Et=>Et.type==="velocityBoost"&&typeof Et.amountBoost=="number");Dt&&(kt=Math.min(kt+Dt.amountBoost,1)),$.triggerAttackRelease(D,ot,z,kt)}},Q);g.push(st)}),d.Transport.loopEnd=v,d.Transport.loop=!0,d.Transport.stop(),d.Transport.position=0,ft.textContent=_(v)};let X=0;const ye=ce.UPDATE_INTERVAL,Ye=()=>{const S=performance.now(),C=S-X>=ye;if(d&&w){const N=typeof d.Transport.loopEnd=="number"?d.Transport.loopEnd:d.Time(d.Transport.loopEnd).toSeconds();if(C){const j=d.Transport.seconds%N,B=j/N*100;nt.value=Math.min(B,100),ht.textContent=_(j),ft.textContent=_(N),X=S}if(d.Transport.state==="started"&&w)requestAnimationFrame(Ye);else if(d.Transport.state==="stopped"||d.Transport.state==="paused"){if(C){const j=d.Transport.seconds%N,B=j/N*100;nt.value=Math.min(B,100),ht.textContent=_(j),X=S}d.Transport.state==="stopped"&&(d.Transport.seconds=0,nt.value=0,ht.textContent=_(0),w=!1,H.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-play"><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></svg>')}}};H.addEventListener("click",async()=>{if(!d)if(await G())Z();else{console.error("[PLAYER] Failed to initialize Tone.js");return}if(w)console.log("[PLAYER] Pausing playback..."),d.Transport.pause(),w=!1,H.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-play"><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></svg>',console.log("[PLAYER] Playback paused");else{if(!d.context||d.context.state!=="running")try{await d.start(),console.log("[PLAYER] Audio context started:",d.context?d.context.state:"unknown"),d.context&&typeof d.context.resume=="function"&&(await d.context.resume(),console.log("[PLAYER] Audio context resumed for iOS compatibility"))}catch(S){console.error("[PLAYER] Failed to start audio context:",S);let C="Failed to start audio. ";E()?C+="On iOS, please ensure your device isn't in silent mode and try again.":C+="Please check your audio settings and try again.",alert(C);return}if(y.length===0&&(console.log("[PLAYER] No synths found, setting up audio..."),Z()),d.Transport.state!=="paused"?(d.Transport.stop(),d.Transport.position=0,console.log("[PLAYER] Starting from beginning")):console.log("[PLAYER] Resuming from paused position"),console.log("[PLAYER] Transport state before start:",d.Transport.state),console.log("[PLAYER] Transport position reset to:",d.Transport.position),console.log("[PLAYER] Audio context state:",d.context?d.context.state:"unknown"),console.log("[PLAYER] Parts count:",g.length),console.log("[PLAYER] Synths count:",y.length),M){const S=Object.values(M).filter(C=>C&&C.name==="Sampler");if(S.length>0&&T.length>0){console.log(`[PLAYER] Waiting for ${S.length} sampler(s) to load...`);try{await Promise.all(T),console.log("[PLAYER] All samplers loaded.")}catch(C){console.warn("[PLAYER] Sampler load wait error:",C);return}}}if(g.length===0){console.error("[PLAYER] No parts available to start. This usually means setupAudio() failed."),console.error("[PLAYER] Try refreshing the page or check if Tone.js is properly loaded.");return}d.Transport.state!=="paused"&&g.forEach((S,C)=>{if(!S||typeof S.start!="function"){console.error(`[PLAYER] Part ${C} is invalid:`,S);return}try{S.start(0)}catch(N){console.error(`[PLAYER] Failed to start part ${C}:`,N)}}),d.Transport.start(),w=!0,H.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-pause"><circle cx="12" cy="12" r="10"/><line x1="10" x2="10" y1="15" y2="9"/><line x1="14" x2="14" y1="15" y2="9"/></svg>',Ye()}}),ct.addEventListener("click",async()=>{d&&(console.log("[PLAYER] Stopping playback completely..."),d.Transport.stop(),d.Transport.cancel(),d.Transport.position=0,g.forEach((S,C)=>{try{S.stop()}catch(N){console.warn(`[PLAYER] Failed to stop part ${C} during complete stop:`,N)}}),w=!1,nt.value=0,ht.textContent=_(0),H.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-play"><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></svg>',console.log("[PLAYER] Playback stopped completely"))}),nt.addEventListener("input",()=>{if(d&&v>0){const S=nt.value/100*v,C=w;C&&d.Transport.pause(),d.Transport.seconds=S,ht.textContent=_(S),C&&setTimeout(()=>{d.Transport.start()},50)}}),J.addEventListener("change",()=>{const S=parseInt(J.value);d&&S>=60&&S<=240?(console.log(`[PLAYER] Tempo changed to ${S} BPM`),d.Transport.bpm.value=S,console.log(`[PLAYER] Tempo changed to ${S} BPM`)):J.value=d?d.Transport.bpm.value:a}),U.forEach(S=>{S.addEventListener("change",()=>{if(d&&y.length>0){console.log("[PLAYER] Synthesizer selection changed, reinitializing audio...");const C=w;w&&(d.Transport.stop(),w=!1),Z(),C?setTimeout(()=>{d.Transport.start(),w=!0,H.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-pause"><circle cx="12" cy="12" r="10"/><line x1="10" x2="10" y1="15" y2="9"/><line x1="14" x2="14" y1="15" y2="9"/></svg>'},100):H.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-play"><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></svg>'}})});const Ue=()=>{console.log("MIDI download - requires MIDI converter implementation")},We=()=>{console.log("WAV download - requires WAV generator implementation")};P.addEventListener("click",Ue),b.addEventListener("click",We),xt.addEventListener("click",Ue),Pt.addEventListener("click",We);const He=typeof window<"u"&&window.Tone||(typeof d<"u"?d:null);if(He&&G().then(()=>{Z(),e&&setTimeout(()=>{H.click()},500)}),e&&!He){const S=setInterval(()=>{(typeof window<"u"&&window.Tone||(typeof d<"u"?d:null))&&(clearInterval(S),setTimeout(()=>{H.click()},500))},100);setTimeout(()=>{clearInterval(S)},1e4)}return k}class he{static midiToNoteName(t){const e=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],n=Math.floor(t/12)-1,o=t%12;return e[o]+n}static convert(t){const e=t.tempo||t.bpm||120,n=t.timeSignature||"4/4",o=t.tracks||[],r=Array.isArray(o)?o:o&&typeof o=="object"?Object.values(o):[];return{header:{bpm:e,timeSignature:n},tracks:r.map(i=>{const s=i.label||i.name,c=Array.isArray(i.notes)?i.notes:Array.isArray(i)?i:[],a=Array.isArray(c)?c:[],h=$e({notes:a},{tempo:e,timeSignature:n}),u=a.map(m=>({pitch:m.pitch,noteName:typeof m.pitch=="number"?he.midiToNoteName(m.pitch):m.pitch,time:m.time,duration:m.duration,velocity:m.velocity||.8}));return{label:s,notes:u,modulations:h&&Array.isArray(h.modulations)?h.modulations:[]}})}}}function Mo(l){return he.convert(l)}class de{constructor(t={}){this.options={Tone:null,trackNaming:"auto",mergeDrums:!0,quantize:null,includeModulations:!0,includeTempo:!0,includeKeySignature:!0,...t}}static async convert(t,e={}){return await new de(e).convertToJmon(t)}async convertToJmon(t){const e=await this.initializeTone();let n;try{n=new e.Midi(t)}catch(a){throw new Error(`Failed to parse MIDI file: ${a.message}`)}const o=this.buildJmonComposition(n,e),r=new Nt,{valid:i,normalized:s,errors:c}=r.validateAndNormalize(o);return i||console.warn("Generated JMON failed validation:",c),i?s:o}async initializeTone(){const t=this.options.Tone;if(typeof window<"u"){const e=t||window.Tone||(typeof Tone<"u"?Tone:null);if(e)return e;try{const n=await import("tone");return n.default||n}catch{throw new Error("Tone.js not found. Please provide Tone instance or load Tone.js")}}else{if(t)return t;throw new Error("Tone instance required in Node.js environment")}}buildJmonComposition(t,e){const n={format:"jmon",version:"1.0",tempo:this.extractTempo(t),tracks:this.convertTracks(t.tracks,e,t)},o=this.extractTimeSignature(t);o&&(n.timeSignature=o);const r=this.extractKeySignature(t);r&&(n.keySignature=r);const i=this.extractMetadata(t);return Object.keys(i).length>0&&(n.metadata=i),this.options.includeTempo&&this.hasTempoChanges(t)&&(n.tempoMap=this.extractTempoMap(t)),this.hasTimeSignatureChanges(t)&&(n.timeSignatureMap=this.extractTimeSignatureMap(t)),n}convertTracks(t,e,n){const o=[];let r=0;for(const i of t){if(!i.notes||i.notes.length===0)continue;const s=this.generateTrackName(i,r,n),c=this.isDrumTrack(i),a=i.notes.map(m=>this.convertNote(m,e,i)),h=this.options.quantize?this.quantizeNotes(a,this.options.quantize):a,u={label:s,notes:h};if(i.channel!==void 0&&(u.midiChannel=i.channel),i.instrument&&(u.synth={type:c?"Sampler":"PolySynth",options:this.getInstrumentOptions(i.instrument,c)}),this.options.includeModulations&&i.controlChanges){const m=this.extractModulations(i.controlChanges);m.length>0&&this.applyModulationsToTrack(u,m)}o.push(u),r++}return o}convertNote(t,e,n){const o={pitch:t.midi,time:t.time,duration:this.convertDurationToNoteValue(t.duration),velocity:t.velocity},r=t.tempo||120;if(o.time=this.convertSecondsToQuarterNotes(t.time,r),this.options.includeModulations&&t.controlChanges){const i=this.convertNoteModulations(t.controlChanges);i.length>0&&(o.modulations=i)}return o}generateTrackName(t,e,n){switch(this.options.trackNaming){case"numbered":return`Track ${e+1}`;case"channel":return`Channel ${(t.channel||0)+1}`;case"instrument":return t.instrument?t.instrument.name||`Instrument ${t.instrument.number}`:`Track ${e+1}`;case"auto":default:return t.name&&t.name.trim()?t.name.trim():this.isDrumTrack(t)?"Drums":t.instrument&&t.instrument.name?t.instrument.name:t.channel!==void 0?t.channel===9?"Drums":`Channel ${t.channel+1}`:`Track ${e+1}`}}isDrumTrack(t){return t.channel===9}getInstrumentOptions(t,e){return e?{envelope:{enabled:!0,attack:.02,decay:.1,sustain:.8,release:.3}}:{oscillator:{type:"triangle"},envelope:{attack:.1,decay:.2,sustain:.7,release:1}}}extractTempo(t){if(t.header&&t.header.tempos&&t.header.tempos.length>0)return Math.round(t.header.tempos[0].bpm);for(const e of t.tracks)if(e.tempoEvents&&e.tempoEvents.length>0)return Math.round(e.tempoEvents[0].bpm);return 120}extractTimeSignature(t){if(t.header&&t.header.timeSignatures&&t.header.timeSignatures.length>0){const e=t.header.timeSignatures[0];return`${e.numerator}/${e.denominator}`}for(const e of t.tracks)if(e.timeSignatureEvents&&e.timeSignatureEvents.length>0){const n=e.timeSignatureEvents[0];return`${n.numerator}/${n.denominator}`}return null}extractKeySignature(t){return null}extractMetadata(t){const e={};for(const n of t.tracks)if(n.meta)for(const o of n.meta)switch(o.type){case"trackName":case"text":!e.title&&o.text&&o.text.trim()&&(e.title=o.text.trim());break;case"copyright":o.text&&o.text.trim()&&(e.copyright=o.text.trim());break;case"composer":o.text&&o.text.trim()&&(e.composer=o.text.trim());break}return e}hasTempoChanges(t){if(t.header&&t.header.tempos&&t.header.tempos.length>1)return!0;for(const e of t.tracks)if(e.tempoEvents&&e.tempoEvents.length>1)return!0;return!1}extractTempoMap(t){const e=[],n=[];t.header&&t.header.tempos&&n.push(...t.header.tempos.map(o=>({time:o.time,tempo:Math.round(o.bpm)})));for(const o of t.tracks)o.tempoEvents&&n.push(...o.tempoEvents.map(r=>({time:r.time,tempo:Math.round(r.bpm)})));n.sort((o,r)=>o.time-r.time);for(const o of n)e.push({time:this.convertSecondsToQuarterNotes(o.time,o.tempo),tempo:o.tempo});return e}hasTimeSignatureChanges(t){if(t.header&&t.header.timeSignatures&&t.header.timeSignatures.length>1)return!0;for(const e of t.tracks)if(e.timeSignatureEvents&&e.timeSignatureEvents.length>1)return!0;return!1}extractTimeSignatureMap(t){const e=[],n=[];t.header&&t.header.timeSignatures&&n.push(...t.header.timeSignatures);for(const o of t.tracks)o.timeSignatureEvents&&n.push(...o.timeSignatureEvents);n.sort((o,r)=>o.time-r.time);for(const o of n)e.push({time:this.convertSecondsToQuarterNotes(o.time,120),timeSignature:`${o.numerator}/${o.denominator}`});return e}convertSecondsToQuarterNotes(t,e){const n=60/e;return t/n}convertDurationToNoteValue(t){const n=t/.5;return n>=3.5?"1n":n>=1.75?"2n":n>=.875?"4n":n>=.4375?"8n":n>=.21875?"16n":n>=.109375?"32n":"16n"}extractModulations(t){const e=[];for(const[n,o]of Object.entries(t)){const r=parseInt(n);for(const i of o){const s={type:"cc",controller:r,value:i.value,time:this.convertSecondsToQuarterNotes(i.time,120)};e.push(s)}}return e}convertNoteModulations(t){return this.extractModulations(t)}applyModulationsToTrack(t,e){e.length>0&&(t.automation=[{id:"midi_cc",target:"midi.cc1",anchorPoints:e.map(n=>({time:n.time,value:n.value}))}])}quantizeNotes(t,e){return t.map(n=>({...n,time:Math.round(n.time/e)*e}))}}async function ko(l,t={}){const e=typeof ArrayBuffer<"u"&&l instanceof ArrayBuffer,n=typeof Uint8Array<"u"&&l instanceof Uint8Array;if(!e&&!n)throw new TypeError("midiToJmon: 'midiData' must be an ArrayBuffer or Uint8Array");return await de.convert(l,t)}function So(l,t={}){return{sampleRate:t.sampleRate||44100,duration:t.duration||10,channels:t.channels||1,tempo:l.tempo||l.bpm||120,notes:l.tracks?.flatMap(e=>e.notes)||[]}}class Ao{static convert(t){let n=`// SuperCollider script generated from JMON
// Title: ${t.metadata?.name||"Untitled"}
`;return(t.tracks?.[0]?.notes||[]).forEach(r=>{n+=`Synth("default", ["freq", ${r.pitch}, "dur", ${r.duration}]);
`}),n}}function Po(l){return Ao.convert(l)}function Eo(l){const t=[];if(!Array.isArray(l))return t;for(const e of l)typeof e=="string"?t.push({type:e}):e&&typeof e=="object"&&typeof e.type=="string"&&t.push({...e});return t}function Ge(l){const t=l.has("staccato"),e=l.has("marcato"),n=l.has("tenuto"),o=!e&&l.has("accent");return{staccato:t,accent:o,tenuto:n,marcato:e}}function No(l){const t=[];return l.staccato&&t.push("a."),l.accent&&t.push("a>"),l.tenuto&&t.push("a-"),l.marcato&&t.push("a^"),t}function Co(l,t={}){const e=t.includeFermata!==!1,n=[],o=new Set(l.map(s=>s.type)),r=Ge(o);r.staccato&&n.push("!staccato!"),r.accent&&n.push("!accent!"),r.tenuto&&n.push("!tenuto!"),r.marcato&&n.push("!marcato!");const i=s=>o.has(s);return e&&i("fermata")&&n.push("!fermata!"),i("trill")&&n.push("!trill!"),i("mordent")&&n.push("!mordent!"),i("turn")&&n.push("!turn!"),i("arpeggio")&&n.push("!arpeggio!"),(i("glissando")||i("portamento"))&&n.push("!slide!"),n}function Ro(l){const t=l.find(o=>o.type==="stroke")||l.find(o=>o.type==="arpeggio")||l.find(o=>o.type==="arpeggiate");if(!t)return null;const e=typeof t.direction=="string"&&t.direction.toLowerCase()==="down"?"down":"up",n=typeof t.style=="string"&&t.style.toLowerCase()==="brush"?"brush":"roll";return{direction:e,style:n}}function Io(l){const t=l.find(o=>o.type==="glissando"||o.type==="portamento");if(!t)return null;const e=t.type==="portamento"?"port.":"gliss.",n={type:t.type,text:e};return typeof t.target=="number"&&(n.target=t.target),typeof t.curve=="string"&&(n.curve=t.curve),n}function jo(l,t={}){const e=Eo(l),n=new Set(e.map(a=>a.type)),o=Ge(n),r=Co(e,t.abc),i=No(o),s=Ro(e),c=Io(e);return{has:n,abc:{decorations:r},vexflow:{articulations:i,stroke:s,gliss:c}}}class $o{constructor(){this.noteMap={60:"C/4",61:"C#/4",62:"D/4",63:"D#/4",64:"E/4",65:"F/4",66:"F#/4",67:"G/4",68:"G#/4",69:"A/4",70:"A#/4",71:"B/4",72:"C/5",73:"C#/5",74:"D/5",75:"D#/5",76:"E/5",77:"F/5",78:"F#/5",79:"G/5",80:"G#/5",81:"A/5",82:"A#/5",83:"B/5"}}midiToVexFlow(t){if(this.noteMap[t])return this.noteMap[t];const e=Math.floor(t/12)-1;return`${["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"][t%12]}/${e}`}durationToVexFlow(t){return t>=4?"w":t>=2?"h":t>=1?"q":t>=.5?"8":t>=.25?"16":"32"}convertToVexFlow(t){const e={timeSignature:t.timeSignature||"4/4",keySignature:t.keySignature||"C",clef:t.clef,metadata:t.metadata||{},tempo:t.tempo??t.bpm??null,tracks:[]};let n=[];return Array.isArray(t.tracks)?n=t.tracks.map((o,r)=>({name:o.name||`Track ${r+1}`,notes:o.notes||o,clef:o.clef})):t.tracks&&typeof t.tracks=="object"?n=Object.entries(t.tracks).map(([o,r],i)=>({name:o||`Track ${i+1}`,notes:r,clef:r&&r.clef||void 0})):t.notes?n=[{name:t.name||"Track 1",notes:t.notes,clef:t.clef}]:n=[{name:"Track 1",notes:t,clef:t.clef}],n.forEach((o,r)=>{const i=o.notes||o,s=[];Array.isArray(i)&&i.forEach(c=>{const a=Array.isArray(c.pitch)?c.pitch:c.pitch!==null&&c.pitch!==void 0?[c.pitch]:[];if(a.length>0){const h={keys:a.map(u=>String(this.midiToVexFlow(u)).toLowerCase()),duration:this.durationToVexFlow(c.duration||1),time:c.time??0};if(c.articulation||Array.isArray(c.articulations)&&c.articulations.length){if(c.articulation&&typeof c.articulation=="string")h.articulations=[c.articulation];else if(Array.isArray(c.articulations)&&c.articulations.length){const u=jo(c.articulations);if(u&&u.vexflow&&(Array.isArray(u.vexflow.articulations)&&u.vexflow.articulations.length&&(h.vfArticulations=u.vexflow.articulations.slice()),u.vexflow.stroke&&(h.stroke={...u.vexflow.stroke}),u.vexflow.gliss)){const m=u.vexflow.gliss;try{h.gliss={type:m.type,targetKey:typeof m.target=="number"?String(this.midiToVexFlow(m.target)).toLowerCase():void 0,curve:m.curve||"linear",text:m.text||(m.type==="portamento"?"port.":"gliss.")}}catch{}}}}Array.isArray(c.ornaments)&&c.ornaments.length&&(h.ornaments=c.ornaments.map(u=>{const m={type:u.type};return u.parameters&&(m.parameters={...u.parameters},u.type==="grace_note"&&u.parameters.gracePitches&&(m.parameters.gracePitches=u.parameters.gracePitches.map(p=>typeof p=="number"?this.midiToVexFlow(p):p))),m})),s.push(h)}else s.push({keys:[],duration:this.durationToVexFlow(c.duration||1),time:c.time??0,isRest:!0})}),e.tracks.push({name:o.name||`Track ${r+1}`,notes:s,clef:o.clef})}),e}createRenderer(t,e=800,n=200){return{elementId:t,width:e,height:n,renderer:"svg",scale:1}}generateRenderingInstructions(t,e){return{type:"vexflow",data:t,config:e,render:function(n){let r=e.element&&e.element.nodeType===1?e.element:e.elementId?document.getElementById(e.elementId):null;const i=document.body||document.documentElement;r?(r.id||(r.id=e.elementId||`vexflow-${Date.now()}`),i.contains(r)||i.appendChild(r)):(r=document.createElement("div"),r.id=e.elementId||`vexflow-${Date.now()}`,i.appendChild(r)),e.elementId=r.id;const s=(()=>{const c=[n,n&&n.default,typeof window<"u"&&(window.VF||window.VexFlow),typeof window<"u"&&window.Vex&&(window.Vex.Flow||window.Vex)];for(const a of c)if(a)return a;return null})();try{const c=s&&(s.Factory||s.Flow&&s.Flow.Factory||s.VF&&s.VF.Factory);if(!c)throw new Error("VexFlow Factory API not available on this build");const h=new c({renderer:{elementId:e.elementId||r.id,width:e.width,height:e.height}}).getContext(),u=s&&(s.Flow||s)||{},m=e.accidentalsMode||"auto",v=(b=>{const d=(b||"C").trim(),w={C:0,G:1,D:2,A:3,E:4,B:5,"F#":6,"C#":7},y={C:0,F:1,Bb:2,Eb:3,Ab:4,Db:5,Gb:6,Cb:7},g={A:0,E:1,B:2,"F#":3,"C#":4,"G#":5,"D#":6,"A#":7},T={A:0,D:1,G:2,C:3,F:4,Bb:5,Eb:6,Ab:7},M=["f","c","g","d","a","e","b"],x=["b","e","a","d","g","c","f"],I=/m(in)?$/i.test(d),E=d.replace(/m(in)?$/i,"");let _=0,G="natural";I&&g[E]!==void 0?(_=g[E],G="sharp"):I&&T[E]!==void 0?(_=T[E],G="flat"):w[E]!==void 0?(_=w[E],G="sharp"):y[E]!==void 0&&(_=y[E],G="flat");const Z={a:"natural",b:"natural",c:"natural",d:"natural",e:"natural",f:"natural",g:"natural"};if(G==="sharp")for(let X=0;X<_;X++)Z[M[X]]="sharp";if(G==="flat")for(let X=0;X<_;X++)Z[x[X]]="flat";return Z})(t.keySignature),f=b=>{const d=String(b).replace(/r/g,"");return{w:32,h:16,q:8,8:4,16:2,32:1}[d]||0},F=(b=>{const[d,w]=(b||"4/4").split("/").map(y=>parseInt(y,10));return{n:d||4,d:w||4}})(t.timeSignature),V=Math.max(1,Math.round(32*F.n/F.d)),O=b=>({32:"w",16:"h",8:"q",4:"8",2:"16",1:"32"})[b]||"q",L=[];let q=[],W=(()=>{const d=(t.tracks[0].notes||[]).reduce((y,g)=>Math.min(y,g.time??0),Number.POSITIVE_INFINITY),w=d===Number.POSITIVE_INFINITY?0:d;return Math.round(w*8%V)})();const at=t.tracks[0].notes,U=[];for(const b of at){const d=f(b.duration);if(!!b.grace){U.push(b);continue}let y=d,g=!0;for(;y>0;){const T=V-W,M=Math.min(y,T),x={...b,duration:O(M)};g&&U.length&&(x.graceNotes=U.splice(0,U.length)),g||(x.tieFromPrev=!0),M<y&&(x.tieToNext=!0),q.push(x),W+=M,y-=M,g=!1,W>=V&&(L.push(q),q=[],W=0)}}q.length&&L.push(q);const K=10,mt=10,ut=40,J=Math.max(100,(e.width||800)-K-mt),bt=Math.max(1,L.length),xt=Math.max(100,Math.floor(J/bt)),Pt=b=>{const d=/^([a-g])(b|#)?\/(-?\d+)$/.exec(b);if(!d)return 60;const y={c:0,d:2,e:4,f:5,g:7,a:9,b:11}[d[1]],g=d[2]==="#"?1:d[2]==="b"?-1:0;return(parseInt(d[3],10)+1)*12+y+g},vt=[];L.forEach(b=>{b.forEach(d=>{d&&!d.isRest&&Array.isArray(d.keys)&&d.keys[0]&&vt.push(Pt(String(d.keys[0]).toLowerCase()))})});const ft=(vt.length?(()=>{const b=[...vt].sort((w,y)=>w-y),d=b.length/2;return b.length%2?b[Math.floor(d)]:(b[d-1]+b[d])/2})():60)<60?"bass":"treble",nt=e.measuresPerLine&&e.measuresPerLine>0?Math.max(1,Math.floor(e.measuresPerLine)):Math.max(1,Math.floor(J/Math.max(120,Math.floor(J/Math.max(1,bt))))),Tt=[];for(let b=0;b<L.length;b+=nt)Tt.push(L.slice(b,b+nt));const H=80,ct=[],tt=[];Tt.forEach((b,d)=>{const w=ut+d*H,y=new u.Stave(K,w,J),T=(E=>{const _=(E||"").toString().toLowerCase();return{g:"treble",treble:"treble",f:"bass",bass:"bass",c:"alto",alto:"alto",tenor:"tenor","treble-8vb":"treble-8vb","treble-8va":"treble-8va","bass-8vb":"bass-8vb"}[_]||"treble"})(t.clef||t.tracks&&t.tracks[0]&&t.tracks[0].clef||ft);if(y.addClef(T),t.timeSignature&&d===0&&y.addTimeSignature(t.timeSignature),t.keySignature&&t.keySignature!=="C"&&d===0&&y.addKeySignature(t.keySignature),y.setContext(h).draw(),d===0)try{const E=t.metadata&&t.metadata.title;if(E&&(h.save(),h.setFont("bold 16px Arial"),h.fillText(E,K,w-20),h.restore()),t.tempo){h.save(),h.setFont("12px Arial");const _=`♩ = ${t.tempo}`;h.fillText(_,K+200,w-8),h.restore()}}catch{}const M=[];b.forEach((E,_)=>{E.slice().sort((Z,X)=>(Z.time??0)-(X.time??0)).forEach(Z=>{if(Z.isRest)M.push(new u.StaveNote({keys:["d/5"],duration:String(Z.duration).replace(/r?$/,"r")}));else{const X=new u.StaveNote({keys:Z.keys.map(ye=>ye.toLowerCase()),duration:Z.duration});M.push(X),tt.push({vf:X,data:Z})}}),_<b.length-1&&u.BarNote&&u.Barline&&u.Barline.type&&M.push(new u.BarNote(u.Barline.type.SINGLE))});const x=new u.Voice({num_beats:Math.max(1,b.length)*V,beat_value:32});x.setMode&&u.Voice&&u.Voice.Mode&&u.Voice.Mode.SOFT!==void 0?x.setMode(u.Voice.Mode.SOFT):typeof x.setStrict=="function"&&x.setStrict(!1),x.addTickables(M.filter(E=>typeof E.getTicks=="function"?E.getTicks().value()>0:!0)),new u.Formatter().joinVoices([x]).format([x],J-20),x.draw(h,y)});const lt=[];L.forEach((b,d)=>{const w=b.slice().sort((y,g)=>(y.time??0)-(g.time??0)).map(y=>{if(y.isRest)return new u.StaveNote({keys:["d/5"],duration:String(y.duration).replace(/r?$/,"r")});const g=new u.StaveNote({keys:y.keys.map(M=>M.toLowerCase()),duration:y.duration});if(y.graceNotes&&u.GraceNoteGroup&&u.GraceNote)try{const M=y.graceNotes.map(I=>new u.GraceNote({keys:(I.keys||[]).map(E=>String(E).toLowerCase()),duration:"16",slash:!0})),x=new u.GraceNoteGroup(M,!0);typeof x.beamNotes=="function"&&x.beamNotes(),typeof x.setContext=="function"&&typeof x.attachToNote=="function"&&(x.setContext(h),x.attachToNote(g))}catch{}if(Array.isArray(y.ornaments)&&y.ornaments.length&&u.GraceNoteGroup&&u.GraceNote){const M=y.ornaments.filter(x=>x.type==="grace_note");if(M.length>0)try{const x=M.flatMap(I=>I.parameters&&I.parameters.gracePitches?I.parameters.gracePitches.map(E=>new u.GraceNote({keys:[String(E).toLowerCase()],duration:"16",slash:I.parameters.graceNoteType==="acciaccatura"})):[]);if(x.length>0){const I=new u.GraceNoteGroup(x,!0);typeof I.beamNotes=="function"&&I.beamNotes(),typeof I.setContext=="function"&&typeof I.attachToNote=="function"&&(I.setContext(h),I.attachToNote(g))}}catch(x){console.warn("Failed to render grace note ornaments:",x)}}u.Accidental&&y.keys.forEach((M,x)=>{const I=M.toLowerCase(),E=/^([a-g])(#{1,2}|b{1,2})?\/-?\d+$/.exec(I),_=E?E[1]:I[0],G=E&&E[2]?E[2].includes("#")?"#":"b":"",Z=v[_]||"natural";let X=null;G==="#"&&Z!=="sharp"?X="#":G==="b"&&Z!=="flat"&&(X="b"),X&&(typeof g.addAccidental=="function"?g.addAccidental(x,new u.Accidental(X)):typeof g.addModifier=="function"&&g.addModifier(new u.Accidental(X),x))});const T={staccato:"a.",accent:"a>",tenuto:"a-",marcato:"a^",legato:"a-"};if(Array.isArray(y.vfArticulations)&&y.vfArticulations.length?y.vfArticulations.forEach(M=>{if(u&&u.Articulation&&u.Modifier&&u.Modifier.Position&&(typeof g.addArticulation=="function"||typeof g.addModifier=="function")){const x=new u.Articulation(M);x&&typeof x.setPosition=="function"&&x.setPosition(u.Modifier.Position.ABOVE),typeof g.addArticulation=="function"?g.addArticulation(0,x):typeof g.addModifier=="function"&&g.addModifier(x,0)}}):Array.isArray(y.articulations)&&y.articulations.forEach(M=>{const x=typeof M=="string"?M:M&&M.type,I=T[x]||null;if(I&&u&&u.Articulation&&u.Modifier&&u.Modifier.Position&&(typeof g.addArticulation=="function"||typeof g.addModifier=="function")){const E=new u.Articulation(I);E&&typeof E.setPosition=="function"&&E.setPosition(u.Modifier.Position.ABOVE),typeof g.addArticulation=="function"?g.addArticulation(0,E):typeof g.addModifier=="function"&&g.addModifier(E,0)}}),y.stroke&&u&&u.Stroke)try{const M=(y.stroke.direction||"up").toLowerCase(),x=(y.stroke.style||"roll").toLowerCase(),I=u.Stroke.Type&&(x==="brush"?M==="down"?u.Stroke.Type.BRUSH_DOWN:u.Stroke.Type.BRUSH_UP:M==="down"?u.Stroke.Type.ROLL_DOWN:u.Stroke.Type.ROLL_UP);I&&typeof g.addStroke=="function"&&g.addStroke(0,new u.Stroke(I))}catch{}return g});if(w.forEach((y,g)=>{const T=b[g];if(!T||T.isRest)return;const M=typeof T.dots=="number"?T.dots:T.dots===!0||T.dot===!0||T.dotted===!0?1:0;for(let x=0;x<M;x++)typeof y.addDotToAll=="function"?y.addDotToAll():u.Dot&&T.keys.forEach((I,E)=>{typeof y.addModifier=="function"&&y.addModifier(new u.Dot,E)});tt.push({vf:y,data:T})}),lt.push(...w),u.Beam&&typeof u.Beam.generateBeams=="function"){const y=w.filter(g=>typeof g.isRest!="function"||!g.isRest());try{const g=u.Beam.generateBeams(y);g.forEach(T=>T.setContext(h)),ct.push(...g)}catch{}}d<L.length-1&&u.BarNote&&u.Barline&&u.Barline.type&&lt.push(new u.BarNote(u.Barline.type.SINGLE))});const A=L.length*V,P=new u.Voice({num_beats:A,beat_value:32});P.setMode&&u.Voice&&u.Voice.Mode&&u.Voice.Mode.SOFT!==void 0?P.setMode(u.Voice.Mode.SOFT):typeof P.setStrict=="function"&&P.setStrict(!1),P.addTickables(lt.filter(b=>typeof b.getTicks=="function"?b.getTicks().value()>0:!0)),ct.length&&ct.forEach(b=>{try{b.draw()}catch{}});try{const b=document.createElement("details");b.style.marginTop="10px";const d=document.createElement("summary");d.textContent="VexFlow Source",d.style.cursor="pointer",b.appendChild(d);const w=document.createElement("pre");w.textContent=JSON.stringify(t,null,2),b.appendChild(w)}catch{}if(tt.length&&u.StaveTie)for(let b=0;b<tt.length-1;b++){const d=tt[b];if(!d)continue;const w=d.data||{};if(!!!(w.tieToNext||w.tieStart||w.tie==="start"))continue;let g=null;for(let T=b+1;T<tt.length;T++)if(tt[T]){g=tt[T];break}if(g)try{new u.StaveTie({first_note:d.vf,last_note:g.vf,first_indices:[0],last_indices:[0]}).setContext(h).draw()}catch{}}if(tt.length&&u&&u.Glissando)for(let b=0;b<tt.length-1;b++){const d=tt[b];if(!d||!d.data||!d.vf)continue;const w=d.data.gliss;if(!w)continue;let y=null;if(w.targetKey)for(let g=b+1;g<tt.length;g++){const T=tt[g];if(T&&T.data&&Array.isArray(T.data.keys)&&T.data.keys.some(x=>String(x).toLowerCase()===String(w.targetKey).toLowerCase())){y=T;break}}if(!y){for(let g=b+1;g<tt.length;g++)if(tt[g]){y=tt[g];break}}if(y&&y.vf)try{const g=new u.Glissando({from:d.vf,to:y.vf,text:w.text||(w.type==="portamento"?"port.":"gliss.")});g&&typeof g.setContext=="function"&&g.setContext(h).draw()}catch{}}}catch(c){console.warn("Factory API failed, trying low-level API:",c);const a=s&&(s.Flow||s.VF||s)||{};e.accidentalsMode;const u=(A=>{const P=(A||"C").trim(),b={C:0,G:1,D:2,A:3,E:4,B:5,"F#":6,"C#":7},d={C:0,F:1,Bb:2,Eb:3,Ab:4,Db:5,Gb:6,Cb:7},w={A:0,E:1,B:2,"F#":3,"C#":4,"G#":5,"D#":6,"A#":7},y={A:0,D:1,G:2,C:3,F:4,Bb:5,Eb:6,Ab:7},g=["f","c","g","d","a","e","b"],T=["b","e","a","d","g","c","f"],M=/m(in)?$/i.test(P),x=P.replace(/m(in)?$/i,"");let I=0,E="natural";M&&w[x]!==void 0?(I=w[x],E="sharp"):M&&y[x]!==void 0?(I=y[x],E="flat"):b[x]!==void 0?(I=b[x],E="sharp"):d[x]!==void 0&&(I=d[x],E="flat");const _={a:"natural",b:"natural",c:"natural",d:"natural",e:"natural",f:"natural",g:"natural"};if(E==="sharp")for(let G=0;G<I;G++)_[g[G]]="sharp";if(E==="flat")for(let G=0;G<I;G++)_[T[G]]="flat";return _})(t.keySignature),m=a&&a.Renderer||s.Renderer||s.Flow&&s.Flow.Renderer;if(!m||!m.Backends)throw new Error("VexFlow low-level API not available (Renderer missing)");const p=new m(r,m.Backends.SVG);p.resize(e.width,e.height);const v=p.getContext(),f=A=>{const P=String(A).replace(/r/g,"");return{w:32,h:16,q:8,8:4,16:2,32:1}[P]||0},F=(A=>{const[P,b]=(A||"4/4").split("/").map(d=>parseInt(d,10));return{n:P||4,d:b||4}})(t.timeSignature),V=Math.max(1,Math.round(32*F.n/F.d)),O=A=>({32:"w",16:"h",8:"q",4:"8",2:"16",1:"32"})[A]||"q",L=[];let q=[],W=(()=>{const P=(t.tracks[0].notes||[]).reduce((d,w)=>Math.min(d,w.time??0),Number.POSITIVE_INFINITY),b=P===Number.POSITIVE_INFINITY?0:P;return Math.round(b*8%V)})();const at=t.tracks[0].notes,U=[];for(const A of at){const P=f(A.duration);if(!!A.grace){U.push(A);continue}let d=P,w=!0;for(;d>0;){const y=V-W,g=Math.min(d,y),T={...A,duration:O(g)};w&&U.length&&(T.graceNotes=U.splice(0,U.length)),w||(T.tieFromPrev=!0),g<d&&(T.tieToNext=!0),q.push(T),W+=g,d-=g,w=!1,W>=V&&(L.push(q),q=[],W=0)}}q.length&&L.push(q);const K=10,mt=10,ut=40,J=Math.max(100,(e.width||800)-K-mt),bt=A=>{const P=/^([a-g])(b|#)?\/(-?\d+)$/.exec(A);if(!P)return 60;const d={c:0,d:2,e:4,f:5,g:7,a:9,b:11}[P[1]],w=P[2]==="#"?1:P[2]==="b"?-1:0;return(parseInt(P[3],10)+1)*12+d+w},xt=[];L.forEach(A=>{A.forEach(P=>{P&&!P.isRest&&Array.isArray(P.keys)&&P.keys[0]&&xt.push(bt(String(P.keys[0]).toLowerCase()))})});const vt=(xt.length?(()=>{const A=[...xt].sort((b,d)=>b-d),P=A.length/2;return A.length%2?A[Math.floor(P)]:(A[P-1]+A[P])/2})():60)<60?"bass":"treble",ht=e.measuresPerLine&&e.measuresPerLine>0?Math.max(1,Math.floor(e.measuresPerLine)):Math.max(1,Math.floor(J/Math.max(120,Math.floor(J/Math.max(1,L.length))))),ft=[];for(let A=0;A<L.length;A+=ht)ft.push(L.slice(A,A+ht));const nt=80,Tt=[],H=[];ft.forEach((A,P)=>{const b=ut+P*nt,d=new a.Stave(K,b,J),y=(x=>{const I=x.toString().toLowerCase();return{g:"treble",treble:"treble",f:"bass",bass:"bass",c:"alto",alto:"alto",tenor:"tenor","treble-8vb":"treble-8vb","treble-8va":"treble-8va","bass-8vb":"bass-8vb"}[I]||"treble"})(t.clef||t.tracks&&t.tracks[0]&&t.tracks[0].clef||vt);if(d.addClef(y),t.timeSignature&&P===0&&d.addTimeSignature(t.timeSignature),t.keySignature&&t.keySignature!=="C"&&P===0&&d.addKeySignature(t.keySignature),d.setContext(v).draw(),P===0)try{const x=t.metadata&&t.metadata.title;if(x&&(v.save(),v.setFont("bold 16px Arial"),v.fillText(x,K,b-20),v.restore()),t.tempo){v.save(),v.setFont("12px Arial");const I=`♩ = ${t.tempo}`;v.fillText(I,K+200,b-8),v.restore()}}catch{}const g=[];A.forEach((x,I)=>{x.slice().sort((_,G)=>(_.time??0)-(G.time??0)).forEach(_=>{if(_.isRest)g.push(new a.StaveNote({keys:["d/5"],duration:String(_.duration).replace(/r?$/,"r")}));else{const G=new a.StaveNote({keys:_.keys.map(Z=>Z.toLowerCase()),duration:_.duration});g.push(G),H.push({vf:G,data:_})}}),I<A.length-1&&a.BarNote&&a.Barline&&a.Barline.type&&g.push(new a.BarNote(a.Barline.type.SINGLE))});const T=new a.Voice({num_beats:Math.max(1,A.length)*V,beat_value:32});T.setMode&&a.Voice&&a.Voice.Mode&&a.Voice.Mode.SOFT!==void 0?T.setMode(a.Voice.Mode.SOFT):typeof T.setStrict=="function"&&T.setStrict(!1),T.addTickables(g.filter(x=>typeof x.getTicks=="function"?x.getTicks().value()>0:!0)),new a.Formatter().joinVoices([T]).format([T],J-20),T.draw(v,d)});const ct=[];L.forEach((A,P)=>{const b=A.slice().sort((d,w)=>(d.time??0)-(w.time??0)).map(d=>{if(d.isRest)return new a.StaveNote({keys:["d/5"],duration:String(d.duration).replace(/r?$/,"r")});const w=new a.StaveNote({keys:d.keys.map(g=>g.toLowerCase()),duration:d.duration});if(d.graceNotes&&a.GraceNoteGroup&&a.GraceNote)try{const g=d.graceNotes.map(M=>new a.GraceNote({keys:(M.keys||[]).map(x=>String(x).toLowerCase()),duration:"16",slash:!0})),T=new a.GraceNoteGroup(g,!0);typeof T.beamNotes=="function"&&T.beamNotes(),typeof T.setContext=="function"&&typeof T.attachToNote=="function"&&(T.setContext(v),T.attachToNote(w))}catch{}if(Array.isArray(d.ornaments)&&d.ornaments.length&&a.GraceNoteGroup&&a.GraceNote){const g=d.ornaments.filter(T=>T.type==="grace_note");if(g.length>0)try{const T=g.flatMap(M=>M.parameters&&M.parameters.gracePitches?M.parameters.gracePitches.map(x=>new a.GraceNote({keys:[String(x).toLowerCase()],duration:"16",slash:M.parameters.graceNoteType==="acciaccatura"})):[]);if(T.length>0){const M=new a.GraceNoteGroup(T,!0);typeof M.beamNotes=="function"&&M.beamNotes(),typeof M.setContext=="function"&&typeof M.attachToNote=="function"&&(M.setContext(v),M.attachToNote(w))}}catch(T){console.warn("Failed to render grace note ornaments:",T)}}a.Accidental&&d.keys.forEach((g,T)=>{const M=g.toLowerCase(),x=/^([a-g])(#{1,2}|b{1,2})?\/-?\d+$/.exec(M),I=x?x[1]:M[0],E=x&&x[2]?x[2].includes("#")?"#":"b":"",_=u[I]||"natural";let G=null;E==="#"&&_!=="sharp"?G="#":E==="b"&&_!=="flat"&&(G="b"),G&&(typeof w.addAccidental=="function"?w.addAccidental(T,new a.Accidental(G)):typeof w.addModifier=="function"&&w.addModifier(new a.Accidental(G),T))});const y={staccato:"a.",accent:"a>",tenuto:"a-",marcato:"a^",legato:"a-"};return Array.isArray(d.vfArticulations)&&d.vfArticulations.length?d.vfArticulations.forEach(g=>{if(a&&a.Articulation&&a.Modifier&&a.Modifier.Position&&(typeof w.addArticulation=="function"||typeof w.addModifier=="function")){const T=new a.Articulation(g);T&&typeof T.setPosition=="function"&&T.setPosition(a.Modifier.Position.ABOVE),typeof w.addArticulation=="function"?w.addArticulation(0,T):typeof w.addModifier=="function"&&w.addModifier(T,0)}}):Array.isArray(d.articulations)&&d.articulations.forEach(g=>{const T=typeof g=="string"?g:g&&g.type,M=y[T]||null;if(M&&a&&a.Articulation&&a.Modifier&&a.Modifier.Position&&(typeof w.addArticulation=="function"||typeof w.addModifier=="function")){const x=new a.Articulation(M);x&&typeof x.setPosition=="function"&&x.setPosition(a.Modifier.Position.ABOVE),typeof w.addArticulation=="function"?w.addArticulation(0,x):typeof w.addModifier=="function"&&w.addModifier(x,0)}}),w});if(b.forEach((d,w)=>{const y=A[w];if(!y||y.isRest)return;const g=typeof y.dots=="number"?y.dots:y.dots===!0||y.dot===!0||y.dotted===!0?1:0;for(let T=0;T<g;T++)typeof d.addDotToAll=="function"?d.addDotToAll():a.Dot&&y.keys.forEach((M,x)=>{typeof d.addModifier=="function"&&d.addModifier(new a.Dot,x)});H.push({vf:d,data:y})}),ct.push(...b),a.Beam&&typeof a.Beam.generateBeams=="function"){const d=b.filter(w=>typeof w.isRest!="function"||!w.isRest());try{const w=a.Beam.generateBeams(d);w.forEach(y=>y.setContext(v)),Tt.push(...w)}catch{}}P<L.length-1&&a.BarNote&&a.Barline&&a.Barline.type&&ct.push(new a.BarNote(a.Barline.type.SINGLE))});const tt=L.length*V,lt=new a.Voice({num_beats:tt,beat_value:32});if(lt.setMode&&a.Voice&&a.Voice.Mode&&a.Voice.Mode.SOFT!==void 0?lt.setMode(a.Voice.Mode.SOFT):typeof lt.setStrict=="function"&&lt.setStrict(!1),lt.addTickables(ct.filter(A=>typeof A.getTicks=="function"?A.getTicks().value()>0:!0)),Tt.length&&Tt.forEach(A=>{try{A.draw()}catch{}}),H.length&&a.StaveTie)for(let A=0;A<H.length-1;A++){const P=H[A];if(!P)continue;const b=P.data||{};if(!!!(b.tieToNext||b.tieStart||b.tie==="start"))continue;let w=null;for(let y=A+1;y<H.length;y++)if(H[y]){w=H[y];break}if(w)try{new a.StaveTie({first_note:P.vf,last_note:w.vf,first_indices:[0],last_indices:[0]}).setContext(v).draw()}catch{}}}}}}}function Be(l,t={}){const e=new $o,n=e.convertToVexFlow(l);if(t.elementId){const o=e.createRenderer(t.elementId,t.width,t.height);return e.generateRenderingInstructions(n,o)}return n}let Ht,Kt,me,fe,pe;async function _o(){if(!Ht&&!Kt){const l=await Promise.resolve().then(()=>uo);Ht=l.GM_INSTRUMENTS,Kt=l.createGMInstrumentNode,me=l.findGMProgramByName,fe=l.generateSamplerUrls,pe=l.getPopularInstruments}return{GM_INSTRUMENTS:Ht,createGMInstrumentNode:Kt,findGMProgramByName:me,generateSamplerUrls:fe,getPopularInstruments:pe}}function Lo(l){return new Nt().validateAndNormalize(l)}function Fo(l,t={}){if(!l||typeof l!="object")throw new Error("render() requires a valid JMON object");return Oe(l,t)}function Vo(l,t={}){const e={autoplay:!1,...t};return Oe(l,e)}function Oo(l,t={},e={}){let n="unknown",o=null;if(t&&typeof t=="string"?n=t.toLowerCase():t&&(typeof t=="object"||typeof t=="function")?(t.Renderer||t.Flow||t.VF||t.Factory||t.Stave||t.StaveNote||t.Voice||t.Formatter||t.Vex&&(t.Vex.Flow||t.Vex)||t.default&&(t.default.Renderer||t.default.Stave||t.default.VF))&&(n="vexflow",o=t):typeof window<"u"&&(window.VF||window.VexFlow||window.Vex&&(window.Vex.Flow||window.Vex)||window.Flow&&window.Flow.Factory)&&(n="vexflow",o=window.VF||window.VexFlow||window.Vex&&(window.Vex.Flow||window.Vex)||window),n==="vexflow"){console.log("VexFlow engine detected, proceeding with rendering");const r=typeof document<"u";let i;if(r){i=document.createElement("div");const s=`vexflow-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;i.id=s,i.style.display="block",i.style.position="static",i.style.visibility="visible",i.style.width="fit-content",i.style.height="fit-content";try{try{const f=e.width||800,k=e.height||200,F=Be(l,{elementId:s,width:f,height:k});if(F&&F.type==="vexflow"&&typeof F.render=="function"){if(F.config&&(F.config.element=i),F.render(o),e.outputType){const V=i.querySelector("svg");if(!V)return i;if(e.outputType==="svg")return V;if(e.outputType==="clonedSvg"){const O=V.cloneNode(!0);return O.style.display="block",O.style.maxWidth="100%",O.style.height="auto",O}else if(e.outputType==="div")return i}return i}}catch{}const c=o||typeof window<"u"&&(window.VF||window.VexFlow||window.Vex&&(window.Vex.Flow||window.Vex));if(!c||!c.Renderer)throw new Error("VexFlow not properly loaded");const a=e.width||800,h=e.height||200,u=new c.Renderer(i,c.Renderer.Backends.SVG);u.resize(a,h);const m=u.getContext(),p=new c.Stave(10,40,a-50);p.addClef("treble"),l.timeSignature&&p.addTimeSignature(l.timeSignature),l.keySignature&&l.keySignature!=="C"&&p.addKeySignature(l.keySignature),p.setContext(m).draw();const v=(l.notes||[]).map(f=>{if(!f.pitch)return null;const k=O=>{const L=["c","c#","d","d#","e","f","f#","g","g#","a","a#","b"],q=Math.floor(O/12)-1,W=O%12;return L[W].replace("#","#")+"/"+q},F=O=>O>=4?"w":O>=2?"h":O>=1?"q":O>=.5?"8":"16",V=Array.isArray(f.pitch)?f.pitch.map(k):[k(f.pitch)];return new c.StaveNote({keys:V,duration:F(f.duration||1)})}).filter(Boolean);if(v.length>0)try{const f=new c.Voice({num_beats:4,beat_value:4});typeof f.setMode=="function"&&c.Voice&&c.Voice.Mode&&c.Voice.Mode.SOFT!==void 0?f.setMode(c.Voice.Mode.SOFT):typeof f.setStrict=="function"&&f.setStrict(!1),typeof f.addTickables=="function"&&f.addTickables(v);const k=new c.Formatter;typeof k.joinVoices=="function"&&typeof k.format=="function"&&k.joinVoices([f]).format([f],a-80),typeof f.draw=="function"&&f.draw(m,p)}catch(f){console.warn("VexFlow voice/formatter error:",f);try{let k=60;v.forEach(F=>{typeof F.setStave=="function"&&F.setStave(p),typeof F.setContext=="function"&&F.setContext(m),typeof F.preFormat=="function"&&F.preFormat(),typeof F.setX=="function"&&F.setX(k),typeof F.draw=="function"&&F.draw(),k+=40})}catch(k){console.warn("Manual note drawing failed:",k)}}if(e.outputType){const f=i.querySelector("svg");if(!f)return i;if(e.outputType==="svg")return f;if(e.outputType==="clonedSvg"){const k=f.cloneNode(!0);return k.style.display="block",k.style.maxWidth="100%",k.style.height="auto",k}else if(e.outputType==="div")return i}return i}catch(c){throw new Error(`VexFlow rendering failed: ${c.message}. Please check your VexFlow instance.`)}}else throw new Error("VexFlow rendering requires a DOM environment. Use jm.converters.vexflow() for data conversion.")}throw new Error("Score rendering requires VexFlow. Please provide a VexFlow instance as the second parameter: jm.score(piece, vexflow)")}const ze={render:Fo,play:Vo,score:Oo,validate:Lo,converters:{midi:Mo,midiToJmon:ko,tonejs:_e,wav:So,supercollider:Po,vexflow:Be},theory:Ct.theory,generative:Ct.generative,analysis:Ct.analysis,constants:Ct.constants,audio:Ct.audio,utils:{...Ct.utils,JmonValidator:Nt,jmon:Sn},instruments:{load:_o,GM_INSTRUMENTS:Ht,generateSamplerUrls:fe,createGMInstrumentNode:Kt,findGMProgramByName:me,getPopularInstruments:pe},VERSION:"1.0.0"},Go=Ct.audio;let Ft=null,De=!1;async function Bo(){if(De)return Ft;De=!0;try{if(typeof window<"u"&&window.Plotly)return Ft=window.Plotly,Ft;if(typeof window>"u"){const t=await import("plotly.js");return Ft=t.default||t,Ft}return null}catch{return console.warn("Plotly.js not available. Visualization methods will return placeholder data."),null}}class Jt{static async line(t,e={},n="plot"){const o=await Bo();if(!o)return{data:t,options:e,type:"line",message:"Plotly.js not available"};const{title:r,width:i=640,height:s=400,color:c="steelblue",xTitle:a="X",yTitle:h="Y"}=e,u={x:t.x,y:t.y,type:"scatter",mode:"lines",line:{color:c,width:2},name:"Line"},m={title:r?{text:r}:void 0,width:i,height:s,xaxis:{title:{text:a}},yaxis:{title:{text:h}}};await o.newPlot(n,[u],m)}static async scatter(t,e={},n="plot"){const{title:o,width:r=640,height:i=400,color:s="steelblue",xTitle:c="X",yTitle:a="Y"}=e,h={x:t.x,y:t.y,type:"scatter",mode:"markers",marker:{color:t.color||s,size:t.size||8},name:"Scatter"},u={title:o?{text:o}:void 0,width:r,height:i,xaxis:{title:{text:c}},yaxis:{title:{text:a}}};await plotly.newPlot(n,[h],u)}static async heatmap(t,e={},n="plot"){const{title:o,width:r=640,height:i=400,colorScale:s="Viridis",xTitle:c="X",yTitle:a="Y"}=e,h={z:t,type:"heatmap",colorscale:s,showscale:!0},u={title:o?{text:o}:void 0,width:r,height:i,xaxis:{title:{text:c}},yaxis:{title:{text:a}}};await plotly.newPlot(n,[h],u)}static async bar(t,e={},n="plot"){const{title:o,width:r=640,height:i=400,color:s="steelblue",xTitle:c="X",yTitle:a="Y"}=e,h={x:t.x.map(m=>m.toString()),y:t.y,type:"bar",marker:{color:t.color||s},name:"Bar"},u={title:o?{text:o}:void 0,width:r,height:i,xaxis:{title:{text:c}},yaxis:{title:{text:a}}};await plotly.newPlot(n,[h],u)}static async radar(t,e={},n="plot"){const{title:o,width:r=400,height:i=400,color:s="steelblue"}=e,c=[...t.x,t.x[0]],h={r:[...t.y,t.y[0]],theta:c,type:"scatterpolar",mode:"lines+markers",fill:"toself",line:{color:s},marker:{color:s,size:8},name:"Radar"},u={title:o?{text:o}:void 0,width:r,height:i,polar:{radialaxis:{visible:!0,range:[0,Math.max(...t.y)*1.1]}}};await plotly.newPlot(n,[h],u)}static async timeSeries(t,e={},n="plot"){const{title:o,width:r=640,height:i=400,xTitle:s="Time",yTitle:c="Value"}=e,a={x:t.x,y:t.y,type:"scatter",mode:"lines",line:{width:2},name:"Time Series"},h={title:o?{text:o}:void 0,width:r,height:i,xaxis:{title:{text:s}},yaxis:{title:{text:c}}};await plotly.newPlot(n,[a],h)}static async matrix(t,e={},n="plot"){const{title:o,width:r=640,height:i=400,xTitle:s="Position",yTitle:c="Time Step"}=e,h={z:t.slice().reverse(),type:"heatmap",colorscale:[[0,"white"],[1,"black"]],showscale:!1,hoverinfo:"none"},u={title:o?{text:o}:void 0,width:r,height:i,xaxis:{title:{text:s},showticklabels:!1},yaxis:{title:{text:c},showticklabels:!1}};await plotly.newPlot(n,[h],u)}static async surface(t,e={},n="plot"){const{title:o,width:r=640,height:i=400,colorScale:s="Viridis",xTitle:c="X",yTitle:a="Y",zTitle:h="Z"}=e,u={x:t.x,y:t.y,z:t.z,type:"surface",colorscale:s},m={title:o?{text:o}:void 0,width:r,height:i,scene:{xaxis:{title:{text:c}},yaxis:{title:{text:a}},zaxis:{title:{text:h}}}};await plotly.newPlot(n,[u],m)}static async multiLine(t,e={},n="plot"){const{title:o,width:r=640,height:i=400,xTitle:s="X",yTitle:c="Y"}=e,a=t.map((u,m)=>({x:u.x,y:u.y,type:"scatter",mode:"lines",name:`Series ${m+1}`,line:{width:2}})),h={title:o?{text:o}:void 0,width:r,height:i,xaxis:{title:{text:s}},yaxis:{title:{text:c}}};await plotly.newPlot(n,a,h)}static async histogram(t,e={},n="plot"){const{title:o,width:r=640,height:i=400,color:s="steelblue",xTitle:c="Value",yTitle:a="Frequency"}=e,h={x:t.x,type:"histogram",marker:{color:s},name:"Histogram"},u={title:o?{text:o}:void 0,width:r,height:i,xaxis:{title:{text:c}},yaxis:{title:{text:a}}};await plotly.newPlot(n,[h],u)}static async boxPlot(t,e={},n="plot"){const{title:o,width:r=640,height:i=400,yTitle:s="Value"}=e,c=t.map((h,u)=>({y:h.y,type:"box",name:`Dataset ${u+1}`})),a={title:o?{text:o}:void 0,width:r,height:i,yaxis:{title:{text:s}}};await plotly.newPlot(n,c,a)}static async violin(t,e={},n="plot"){const{title:o,width:r=640,height:i=400,yTitle:s="Value"}=e,c=t.map((h,u)=>({y:h.y,type:"violin",name:`Dataset ${u+1}`,box:{visible:!0},meanline:{visible:!0}})),a={title:o?{text:o}:void 0,width:r,height:i,yaxis:{title:{text:s}}};await plotly.newPlot(n,c,a)}static async contour(t,e={},n="plot"){const{title:o,width:r=640,height:i=400,colorScale:s="Viridis",xTitle:c="X",yTitle:a="Y"}=e,h={x:t.x,y:t.y,z:t.z,type:"contour",colorscale:s,showscale:!0},u={title:o?{text:o}:void 0,width:r,height:i,xaxis:{title:{text:c}},yaxis:{title:{text:a}}};await plotly.newPlot(n,[h],u)}static async scatter3D(t,e={},n="plot"){const{title:o,width:r=640,height:i=400,color:s="steelblue",xTitle:c="X",yTitle:a="Y",zTitle:h="Z"}=e,u={x:t.x,y:t.y,z:t.z,type:"scatter3d",mode:"markers",marker:{color:t.color||s,size:4,opacity:.8},name:"3D Scatter"},m={title:o?{text:o}:void 0,width:r,height:i,scene:{xaxis:{title:{text:c}},yaxis:{title:{text:a}},zaxis:{title:{text:h}}}};await plotly.newPlot(n,[u],m)}static async animate(t,e={},n="plot"){const{title:o,width:r=640,height:i=400,duration:s=500,transition:c=100}=e,a=t[0]?.data||[],h={title:o?{text:o}:void 0,width:r,height:i,updatemenus:[{type:"buttons",showactive:!1,buttons:[{label:"Play",method:"animate",args:[null,{frame:{duration:s,redraw:!0},transition:{duration:c},fromcurrent:!0}]},{label:"Pause",method:"animate",args:[[null],{frame:{duration:0,redraw:!1},mode:"immediate",transition:{duration:0}}]}]}],...t[0]?.layout},u=t.map((m,p)=>({name:p.toString(),data:m.data,layout:m.layout}));await Ft.newPlot(n,a,h),await plotly.addFrames(n,u)}static async candlestick(t,e={},n="plot"){const{title:o,width:r=640,height:i=400,xTitle:s="Time",yTitle:c="Price"}=e,a={x:t.x,open:t.open,high:t.high,low:t.low,close:t.close,type:"candlestick",name:"OHLC"},h={title:o?{text:o}:void 0,width:r,height:i,xaxis:{title:{text:s}},yaxis:{title:{text:c}}};await plotly.newPlot(n,[a],h)}}class zo{static plotEvolution(t,e={}){const{title:n="Cellular Automata Evolution",width:o=600,height:r=400,colorScheme:i="binary",showAxis:s=!1}=e,c=[];return t.forEach((a,h)=>{a.forEach((u,m)=>{c.push({x:m,y:t.length-1-h,value:u})})}),Jt.matrix(t,{title:n,width:o,height:r,showAxis:s})}static plotGeneration(t,e={}){const{title:n="CA Generation",width:o=600,height:r=100}=e,i={x:t.map((s,c)=>c),y:t.map(()=>0),color:t.map(s=>s?"black":"white")};return Jt.scatter(i,{title:n,width:o,height:r,showAxis:!1})}static compareRules(t,e={}){const{width:n=300,height:o=200,colorScheme:r="binary"}=e;return t.map(({ruleNumber:i,history:s})=>this.plotEvolution(s,{title:`Rule ${i}`,width:n,height:o,colorScheme:r,showAxis:!1}))}static createAnimationData(t){return t.map((e,n)=>({frame:n,data:e.map((o,r)=>({x:r,y:0,value:o}))}))}static extractPatterns(t){const e=[],n=[],o=[],r=t[0]?.length||0;for(let i=0;i<r;i++){const s=t.map(a=>a[i]),c=this.findPeriod(s.filter(a=>a!==void 0));c>1&&c<10&&e.push({position:i,period:c})}if(t.length>5){const i=t[t.length-1],s=t[t.length-2];if(i&&s)for(let c=0;c<r-3;c++)i.slice(c,c+3).every((h,u)=>h===s[c+u]&&h===1)&&o.push({position:c,width:3})}return{oscillators:e,gliders:n,stillLifes:o}}static findPeriod(t){if(t.length<4)return 1;for(let e=1;e<=Math.floor(t.length/2);e++){let n=!0;for(let o=e;o<t.length;o++)if(t[o]!==t[o-e]){n=!1;break}if(n)return e}return 1}static plotDensity(t,e={}){const{title:n="CA Density Over Time",width:o=600,height:r=300}=e,i=t.map((c,a)=>({time:a,density:c.reduce((h,u)=>h+u,0)/c.length})),s={x:i.map(c=>c.time),y:i.map(c=>c.density)};return Jt.line(s,{title:n,width:o,height:r,color:"steelblue",showAxis:!0})}static plotSpacetime(t,e={}){const{title:n="Spacetime Diagram",width:o=600,height:r=400,showGrid:i=!1}=e,s=[];return t.forEach((c,a)=>{c.forEach((h,u)=>{s.push({x:u,y:t.length-1-a,value:h,border:i})})}),Jt.matrix(t,{title:n,width:o,height:r,showAxis:!1})}}const ge=Object.freeze(Object.defineProperty({__proto__:null,CAVisualizer:zo},Symbol.toStringTag,{value:"Module"}));let zt=null,qe=!1;async function Do(){if(qe)return zt;qe=!0;try{if(typeof window<"u"&&window.Plotly)return zt=window.Plotly,zt;if(typeof window>"u"){const t=await import("plotly.js");return zt=t.default||t,zt}return null}catch{return console.warn("Plotly.js not available. Visualization methods will return placeholder data."),null}}class qo{static async plotLoops(t,e=4,n=1/4,o=null,r={}){const{container:i="loop-plot",title:s="Loop Visualization",showDurationArcs:c=!0,showMarkers:a=!0,showShapes:h=!0,colorScheme:u="colorblind"}=r,m=Object.values(t),p=o||this.generateColors(m.length,u),v=[];m.forEach((q,W)=>{if(!q.notes||q.notes.length===0)return;const at=q.notes.filter(U=>U.pitch!==null);if(at.length!==0&&((c||a)&&at.forEach(U=>{const K=U.time/e*360,mt=U.duration/e*360;if(c&&mt>1){const ut=this.generateArcPoints(K,mt,50),J=Array(50).fill(m.length-W-1);v.push({type:"scatterpolar",r:J,theta:ut,mode:"lines",line:{color:"rgba(60, 60, 60, 0.65)",width:8},name:`${q.label} Duration`,showlegend:!1})}a&&[K,(K+mt)%360].forEach(ut=>{v.push({type:"scatterpolar",r:[m.length-W-.9,m.length-W-1.1],theta:[ut,ut],mode:"lines",line:{color:"Black",width:3},name:`${q.label} Markers`,showlegend:!1})})}),h)){const U=at.map(K=>K.time/e*360);U.length>1&&(U.push(U[0]),v.push({type:"scatterpolar",r:Array(U.length).fill(m.length-W-1),theta:U,mode:"lines",line:{color:"rgba(0, 0, 0, 0.65)",width:1},fill:"toself",fillcolor:p[W%p.length],name:q.label,showlegend:!1}))}});const f=this.generateTickValues(e,n),k=this.generateTickLabels(e,n),F=m.map(q=>q.label).reverse(),V={title:{text:s},polar:{radialaxis:{visible:!0,range:[m.length,-.1],tickvals:Array.from({length:m.length},(q,W)=>W),ticktext:F},angularaxis:{tickvals:f,ticktext:k,direction:"clockwise",rotation:90}},template:"none",showlegend:!1},O={responsive:!0,displayModeBar:!0},L=await Do();if(!L)throw new Error("Plotly.js not available for visualization");return L.newPlot(i,v,V,O)}static generateColors(t,e="colorblind"){const n=[];switch(e){case"colorblind":const o=["rgba(230, 159, 0, 0.65)","rgba(86, 180, 233, 0.65)","rgba(0, 158, 115, 0.65)","rgba(240, 228, 66, 0.65)","rgba(0, 114, 178, 0.65)","rgba(213, 94, 0, 0.65)","rgba(204, 121, 167, 0.65)"];for(let i=0;i<t;i++)n.push(o[i%o.length]);break;case"viridis":const r=["rgba(68, 1, 84, 0.65)","rgba(59, 82, 139, 0.65)","rgba(33, 144, 140, 0.65)","rgba(94, 201, 98, 0.65)","rgba(253, 231, 37, 0.65)"];for(let i=0;i<t;i++)if(t<=r.length)n.push(r[i]);else{const c=i/(t-1)*(r.length-1),a=Math.floor(c);n.push(r[a])}break;case"classic":default:for(let i=0;i<t;i++){const s=i/t,c=this.hsvToRgb(s,1,1);n.push(`rgba(${Math.round(c.r*255)}, ${Math.round(c.g*255)}, ${Math.round(c.b*255)}, 0.5)`)}break}return n}static hsvToRgb(t,e,n){let o,r,i;const s=Math.floor(t*6),c=t*6-s,a=n*(1-e),h=n*(1-c*e),u=n*(1-(1-c)*e);switch(s%6){case 0:o=n,r=u,i=a;break;case 1:o=h,r=n,i=a;break;case 2:o=a,r=n,i=u;break;case 3:o=a,r=h,i=n;break;case 4:o=u,r=a,i=n;break;case 5:o=n,r=a,i=h;break;default:o=r=i=0}return{r:o,g:r,b:i}}static generateArcPoints(t,e,n){const o=[];for(let r=0;r<n;r++){const i=t+r/(n-1)*e;o.push(i%360)}return o}static generateTickValues(t,e){const n=[],o=Math.floor(t/e);for(let r=0;r<o;r++)n.push(r*360/o);return n}static generateTickLabels(t,e){const n=[],o=Math.floor(t/e);for(let r=0;r<o;r++){const i=r*e%t;n.push(i.toString())}return n}}const Yo=Object.freeze(Object.defineProperty({__proto__:null,LoopVisualizer:qo},Symbol.toStringTag,{value:"Module"}));St.audio=Go,St.default=ze,St.jm=ze,Object.defineProperties(St,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
